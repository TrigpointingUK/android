


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DownloadTrigsActivity</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">uk.trigpointing.android</a>
</div>

<h1>Coverage Summary for Class: DownloadTrigsActivity (uk.trigpointing.android)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DownloadTrigsActivity</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/25)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/113)
  </span>
</td>
</tr>
  <tr>
    <td class="name">DownloadTrigsActivity$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DownloadTrigsActivity$DownloadStatus</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/25)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/115)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package uk.trigpointing.android;
&nbsp;
&nbsp;import java.io.BufferedInputStream;
&nbsp;import java.io.BufferedReader;
&nbsp;import java.io.IOException;
&nbsp;import java.io.InputStream;
&nbsp;import java.io.InputStreamReader;
&nbsp;import java.net.URL;
&nbsp;import java.net.URLConnection;
&nbsp;import java.util.zip.GZIPInputStream;
&nbsp;
&nbsp;import uk.trigpointing.android.common.BaseActivity;
&nbsp;
&nbsp;import android.annotation.SuppressLint;
&nbsp;import android.content.pm.PackageManager.NameNotFoundException;
&nbsp;import android.os.Bundle;
&nbsp;import android.os.Handler;
&nbsp;import android.os.Looper;
&nbsp;import android.util.Log;
&nbsp;import android.view.MenuItem;
&nbsp;import android.widget.ProgressBar;
&nbsp;import android.widget.TextView;
&nbsp;
&nbsp;import java.util.concurrent.CompletableFuture;
&nbsp;import java.util.concurrent.ExecutorService;
&nbsp;import java.util.concurrent.Executors;
&nbsp;
&nbsp;import uk.trigpointing.android.logging.SyncTask;
&nbsp;import uk.trigpointing.android.logging.SyncListener;
&nbsp;import uk.trigpointing.android.types.Condition;
&nbsp;import uk.trigpointing.android.types.Trig;
&nbsp;import android.content.Intent;
&nbsp;
<b class="nc">&nbsp;public class DownloadTrigsActivity extends BaseActivity implements SyncListener {</b>
&nbsp;
&nbsp;	private TextView 		mStatus;
&nbsp;	private ProgressBar 	mProgress;
<b class="nc">&nbsp;	private Integer 		mDownloadCount = 0;</b>
<b class="nc">&nbsp;    private static int 		mProgressMax = 10000; // value unimportant</b>
&nbsp;	private int 			mAppVersion;
&nbsp;	private Handler 		mainHandler;
&nbsp;	
&nbsp;	private static final String TAG = &quot;DownloadTrigsActivity&quot;;
<b class="nc">&nbsp;	private enum DownloadStatus {OK, CANCELLED, ERROR}</b>
&nbsp;
&nbsp;
&nbsp;    @SuppressLint(&quot;SetTextI18n&quot;)
&nbsp;    @Override
&nbsp;	protected void onCreate(Bundle savedInstanceState) {
<b class="nc">&nbsp;		super.onCreate(savedInstanceState);</b>
<b class="nc">&nbsp;		setContentView(R.layout.download);</b>
&nbsp;		
&nbsp;		// Enable back button in action bar
<b class="nc">&nbsp;		if (getSupportActionBar() != null) {</b>
<b class="nc">&nbsp;			getSupportActionBar().setDisplayHomeAsUpEnabled(true);</b>
&nbsp;		}
&nbsp;		
&nbsp;		try {
<b class="nc">&nbsp;			mAppVersion = this.getPackageManager().getPackageInfo(this.getPackageName(), 0).versionCode;</b>
&nbsp;		} catch (NameNotFoundException e) {
<b class="nc">&nbsp;			Log.e(TAG,&quot;Couldn&#39;t get versionCode!&quot;);</b>
<b class="nc">&nbsp;			mAppVersion = 99999;</b>
&nbsp;		}		
&nbsp;		
<b class="nc">&nbsp;		mStatus = findViewById(R.id.downloadStatus);</b>
<b class="nc">&nbsp;		mStatus.setText(&quot;Starting download...&quot;);</b>
<b class="nc">&nbsp;		mProgress = findViewById(R.id.downloadProgress);</b>
<b class="nc">&nbsp;		mProgress.setMax(mProgressMax);</b>
<b class="nc">&nbsp;		mProgress.setProgress(0);</b>
&nbsp;		
&nbsp;		// Initialize main handler
<b class="nc">&nbsp;		mainHandler = new Handler(Looper.getMainLooper());</b>
&nbsp;		
&nbsp;		// Automatically start the download
<b class="nc">&nbsp;        CompletableFuture&lt;DownloadStatus&gt; mTask = downloadTrigs();</b>
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;
&nbsp;	@SuppressLint(&quot;SetTextI18n&quot;)
&nbsp;    private CompletableFuture&lt;DownloadStatus&gt; downloadTrigs() {
&nbsp;		// Setup UI on main thread
<b class="nc">&nbsp;		mDownloadCount = 0;</b>
<b class="nc">&nbsp;		mStatus.setText(&quot;Downloading trigpoint data...&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        ExecutorService executor = Executors.newSingleThreadExecutor();</b>
&nbsp;		
<b class="nc">&nbsp;		return CompletableFuture.supplyAsync(() -&gt; {</b>
<b class="nc">&nbsp;			Log.i(TAG, &quot;PopulateTrigsTask: Starting download&quot;);</b>
&nbsp;
<b class="nc">&nbsp;			DbHelper db = new DbHelper(DownloadTrigsActivity.this);</b>
&nbsp;			String strLine;                
<b class="nc">&nbsp;			int i=0;</b>
&nbsp;
&nbsp;			try {
<b class="nc">&nbsp;				Log.i(TAG, &quot;PopulateTrigsTask: Opening database&quot;);</b>
<b class="nc">&nbsp;				db.open();</b>
<b class="nc">&nbsp;				db.mDb.beginTransaction();</b>
&nbsp;
<b class="nc">&nbsp;				String downloadUrl = &quot;https://trigpointing.uk/trigs/down-android-trigs.php?appversion=&quot;+ mAppVersion;</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;PopulateTrigsTask: Downloading from URL: &quot; + downloadUrl);</b>
&nbsp;				
<b class="nc">&nbsp;				URL url = new URL(downloadUrl);</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;PopulateTrigsTask: Opening connection&quot;);</b>
<b class="nc">&nbsp;				URLConnection ucon = url.openConnection();</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;PopulateTrigsTask: Getting input stream&quot;);</b>
<b class="nc">&nbsp;				InputStream is = ucon.getInputStream();</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;PopulateTrigsTask: Creating GZIP input stream&quot;);</b>
<b class="nc">&nbsp;				GZIPInputStream zis = new GZIPInputStream(new BufferedInputStream(is));</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;PopulateTrigsTask: Creating buffered reader&quot;);</b>
<b class="nc">&nbsp;				BufferedReader br = new BufferedReader(new InputStreamReader(zis));</b>
&nbsp;
<b class="nc">&nbsp;				Log.i(TAG, &quot;PopulateTrigsTask: Reading first line&quot;);</b>
<b class="nc">&nbsp;				if ((strLine = br.readLine()) != null) {</b>
<b class="nc">&nbsp;					mProgressMax = Integer.parseInt(strLine);</b>
<b class="nc">&nbsp;					Log.i(TAG, &quot;PopulateTrigsTask: Downloading &quot; + mProgressMax + &quot; trigs&quot;);</b>
&nbsp;					// Update progress on main thread
<b class="nc">&nbsp;					mainHandler.post(() -&gt; mProgress.setMax(mProgressMax));</b>
&nbsp;				}
&nbsp;				
<b class="nc">&nbsp;				Log.i(TAG, &quot;PopulateTrigsTask: Deleting all existing data&quot;);</b>
<b class="nc">&nbsp;				db.deleteAll();</b>
&nbsp;
<b class="nc">&nbsp;				while ((strLine = br.readLine()) != null &amp;&amp; !strLine.trim().isEmpty())   {</b>
&nbsp;					//Log.v(TAG,strLine);
<b class="nc">&nbsp;					String[] csv=strLine.split(&quot;\t&quot;);</b>
&nbsp;					
&nbsp;					// Validate CSV array has enough elements
<b class="nc">&nbsp;					if (csv.length &lt; 10) {</b>
<b class="nc">&nbsp;						Log.w(TAG, &quot;Skipping invalid line (insufficient columns): &quot; + strLine);</b>
&nbsp;						continue;
&nbsp;					}
&nbsp;					
&nbsp;					try {
<b class="nc">&nbsp;						int id						= Integer.parseInt(csv[0]);</b>
<b class="nc">&nbsp;						String waypoint				= csv[1];</b>
<b class="nc">&nbsp;						String name					= csv[2];</b>
&nbsp;						
&nbsp;						// Validate lat/lon are not empty
<b class="nc">&nbsp;						if (csv[3].trim().isEmpty() || csv[4].trim().isEmpty()) {</b>
<b class="nc">&nbsp;							Log.w(TAG, &quot;Skipping line with empty lat/lon: &quot; + strLine);</b>
&nbsp;							continue;
&nbsp;						}
&nbsp;						
<b class="nc">&nbsp;						double lat					= Double.parseDouble(csv[3]);</b>
<b class="nc">&nbsp;						double lon					= Double.parseDouble(csv[4]);</b>
<b class="nc">&nbsp;						Trig.Physical type			= Trig.Physical.fromCode(csv[5]);</b>
<b class="nc">&nbsp;						String fb					= csv[6];</b>
<b class="nc">&nbsp;						Condition condition			= Condition.fromCode(csv[7]);</b>
<b class="nc">&nbsp;						Condition logged			= Condition.TRIGNOTLOGGED;</b>
<b class="nc">&nbsp;						Trig.Current current		= Trig.Current.fromCode(csv[8]);</b>
<b class="nc">&nbsp;						Trig.Historic historic		= Trig.Historic.fromCode(csv[9]);</b>
<b class="nc">&nbsp;						db.createTrig(id, name, waypoint, lat, lon, type, condition, logged, current, historic, fb);</b>
&nbsp;						
<b class="nc">&nbsp;						if (i++%10==9){</b>
<b class="nc">&nbsp;							mDownloadCount=i;</b>
&nbsp;							// Update progress on main thread
<b class="nc">&nbsp;							final int progress = i;</b>
<b class="nc">&nbsp;							mainHandler.post(() -&gt; {</b>
<b class="nc">&nbsp;								mProgress.setProgress(progress);</b>
<b class="nc">&nbsp;								mStatus.setText(&quot;Inserted &quot; + progress + &quot; trigs&quot;);</b>
&nbsp;							});
&nbsp;						}
&nbsp;					} catch (NumberFormatException e) {
<b class="nc">&nbsp;						Log.w(TAG, &quot;Skipping line with invalid number format: &quot; + strLine + &quot; - &quot; + e.getMessage());</b>
&nbsp;                    } catch (Exception e) {
<b class="nc">&nbsp;						Log.w(TAG, &quot;Skipping line with parsing error: &quot; + strLine + &quot; - &quot; + e.getMessage());</b>
&nbsp;                    }
&nbsp;				} 
<b class="nc">&nbsp;				db.mDb.execSQL(&quot;create index if not exists latlon on trig (lat, lon)&quot;);</b>
<b class="nc">&nbsp;				db.mDb.setTransactionSuccessful();</b>
&nbsp;			}catch (IOException e) {
<b class="nc">&nbsp;				Log.e(TAG, &quot;Error: &quot; + e.getMessage(), e);</b>
<b class="nc">&nbsp;				return DownloadStatus.ERROR;</b>
&nbsp;			} catch (Exception e) {
<b class="nc">&nbsp;				Log.e(TAG, &quot;Unexpected error: &quot; + e.getMessage(), e);</b>
<b class="nc">&nbsp;				return DownloadStatus.ERROR;</b>
&nbsp;			} finally {
<b class="nc">&nbsp;				db.mDb.endTransaction();</b>
&nbsp;				db.close();
<b class="nc">&nbsp;				mDownloadCount = i;</b>
&nbsp;			}
<b class="nc">&nbsp;			return DownloadStatus.OK;</b>
&nbsp;		}, executor)
<b class="nc">&nbsp;		.thenApplyAsync(result -&gt; {</b>
<b class="nc">&nbsp;			switch (result) {</b>
&nbsp;			case OK:
<b class="nc">&nbsp;				mStatus.setText(&quot;Download complete! &quot; + mDownloadCount + &quot; trigpoints downloaded. Starting sync...&quot;);</b>
<b class="nc">&nbsp;				mProgress.setProgress(mProgressMax);</b>
&nbsp;				// Start sync after successful download with auto-sync flag
<b class="nc">&nbsp;				mainHandler.post(() -&gt; new SyncTask(DownloadTrigsActivity.this, DownloadTrigsActivity.this).execute(true));</b>
&nbsp;				break;
&nbsp;			case ERROR:
<b class="nc">&nbsp;				mStatus.setText(&quot;Download failed! Please try again.&quot;);</b>
<b class="nc">&nbsp;				mProgress.setProgress(0);</b>
&nbsp;				// Auto-close after 3 seconds on error too
<b class="nc">&nbsp;				mainHandler.postDelayed(DownloadTrigsActivity.this::finish, 3000);</b>
&nbsp;				break;
&nbsp;			case CANCELLED:
<b class="nc">&nbsp;				mStatus.setText(&quot;Download cancelled.&quot;);</b>
<b class="nc">&nbsp;				mProgress.setProgress(0);</b>
&nbsp;				// Auto-close after 3 seconds
<b class="nc">&nbsp;				mainHandler.postDelayed(DownloadTrigsActivity.this::finish, 3000);</b>
&nbsp;				break;
&nbsp;			}
<b class="nc">&nbsp;            return result;</b>
<b class="nc">&nbsp;		}, mainHandler::post);</b>
&nbsp;	}
&nbsp;	
&nbsp;	@Override
&nbsp;	public boolean onOptionsItemSelected(MenuItem item) {
<b class="nc">&nbsp;		if (item.getItemId() == android.R.id.home) {</b>
&nbsp;			// Handle back button in action bar
<b class="nc">&nbsp;			finish();</b>
<b class="nc">&nbsp;			return true;</b>
&nbsp;		}
<b class="nc">&nbsp;		return super.onOptionsItemSelected(item);</b>
&nbsp;	}
&nbsp;	
&nbsp;	@SuppressLint(&quot;SetTextI18n&quot;)
&nbsp;    @Override
&nbsp;	public void onSynced(int status) {
<b class="nc">&nbsp;		Log.i(TAG, &quot;onSynced: Sync completed with status: &quot; + status);</b>
&nbsp;		
<b class="nc">&nbsp;		mainHandler.post(() -&gt; {</b>
<b class="nc">&nbsp;			Log.i(TAG, &quot;onSynced: Updating UI and scheduling return to MainActivity&quot;);</b>
<b class="nc">&nbsp;			switch (status) {</b>
&nbsp;			case SyncTask.SUCCESS:
<b class="nc">&nbsp;				mStatus.setText(&quot;Sync complete! All data synchronised.&quot;);</b>
&nbsp;				break;
&nbsp;			case SyncTask.NOROWS:
<b class="nc">&nbsp;				mStatus.setText(&quot;Sync complete! No data to sync.&quot;);</b>
&nbsp;				break;
&nbsp;			case SyncTask.ERROR:
&nbsp;				// For first-time users, this is expected - show appropriate message
<b class="nc">&nbsp;				mStatus.setText(&quot;Sync skipped - Please login for a more personalised experience.&quot;);</b>
&nbsp;				break;
&nbsp;			case SyncTask.CANCELLED:
<b class="nc">&nbsp;				mStatus.setText(&quot;Sync cancelled.&quot;);</b>
&nbsp;				break;
&nbsp;			default:
<b class="nc">&nbsp;				mStatus.setText(&quot;Sync completed with unknown status.&quot;);</b>
&nbsp;				break;
&nbsp;			}
&nbsp;			
<b class="nc">&nbsp;			Log.i(TAG, &quot;onSynced: Scheduling return to MainActivity in 1.5 seconds&quot;);</b>
&nbsp;			// Return to MainActivity after a shorter delay (1.5 seconds instead of 3)
<b class="nc">&nbsp;			mainHandler.postDelayed(() -&gt; {</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;onSynced: Returning to MainActivity now&quot;);</b>
<b class="nc">&nbsp;				finish();</b>
&nbsp;				// Ensure we return to MainActivity
<b class="nc">&nbsp;				Intent intent = new Intent(DownloadTrigsActivity.this, MainActivity.class);</b>
<b class="nc">&nbsp;				intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_NEW_TASK);</b>
<b class="nc">&nbsp;				startActivity(intent);</b>
&nbsp;			}, 1500);
&nbsp;		});
&nbsp;	}
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-08-25 13:52</div>
</div>
</body>
</html>
