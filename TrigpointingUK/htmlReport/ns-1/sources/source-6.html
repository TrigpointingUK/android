


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > MainActivity</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">uk.trigpointing.android</a>
</div>

<h1>Coverage Summary for Class: MainActivity (uk.trigpointing.android)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">MainActivity</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/41)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/74)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/363)
  </span>
</td>
</tr>
  <tr>
    <td class="name">MainActivity$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MainActivity$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/48)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/74)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/386)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package uk.trigpointing.android;
&nbsp;
&nbsp;// import org.acra.ErrorReporter;
&nbsp;
&nbsp;import android.app.AlertDialog;
&nbsp;import android.content.Intent;
&nbsp;import android.content.SharedPreferences;
&nbsp;import android.content.res.Resources.NotFoundException;
&nbsp;import android.database.SQLException;
&nbsp;
&nbsp;import java.io.BufferedReader;
&nbsp;import java.io.IOException;
&nbsp;import java.io.InputStreamReader;
&nbsp;import java.net.HttpURLConnection;
&nbsp;import java.net.URL;
&nbsp;import java.util.concurrent.ExecutorService;
&nbsp;import java.util.concurrent.Executors;
&nbsp;import java.util.concurrent.CompletableFuture;
&nbsp;import android.os.Bundle;
&nbsp;import androidx.preference.PreferenceManager;
&nbsp;import android.util.Log;
&nbsp;import android.view.Menu;
&nbsp;import android.view.MenuItem;
&nbsp;import android.view.View;
&nbsp;import android.widget.Button;
&nbsp;import android.widget.CheckBox;
&nbsp;import android.widget.EditText;
&nbsp;import android.widget.ImageView;
&nbsp;import android.widget.LinearLayout;
&nbsp;import android.widget.TextView;
&nbsp;import android.widget.Toast;
&nbsp;
&nbsp;import androidx.activity.result.ActivityResultLauncher;
&nbsp;import androidx.activity.result.contract.ActivityResultContracts;
&nbsp;import androidx.activity.OnBackPressedCallback;
&nbsp;import androidx.core.content.ContextCompat;
&nbsp;import uk.trigpointing.android.common.BaseActivity;
&nbsp;import uk.trigpointing.android.common.ClearCacheTask;
&nbsp;import uk.trigpointing.android.logging.SyncListener;
&nbsp;import uk.trigpointing.android.logging.SyncTask;
&nbsp;import uk.trigpointing.android.mapping.DownloadMapsActivity;
&nbsp;import uk.trigpointing.android.nearest.NearestActivity;
&nbsp;import okhttp3.OkHttpClient;
&nbsp;import okhttp3.Request;
&nbsp;import okhttp3.Response;
&nbsp;import uk.trigpointing.android.api.AuthApiClient;
&nbsp;import uk.trigpointing.android.api.AuthPreferences;
&nbsp;import uk.trigpointing.android.api.User;
&nbsp;import coil.Coil;
&nbsp;import coil.ImageLoader;
&nbsp;import coil.request.ImageRequest;
&nbsp;
<b class="nc">&nbsp;public class MainActivity extends BaseActivity implements SyncListener {</b>
&nbsp;    public static final String 	TAG =&quot;MainActivity&quot;;
&nbsp;	private static final String RUNBEFORE = &quot;RUNBEFORE&quot;;
&nbsp;	private static final String AUTO_SYNC_RUN = &quot;AUTO_SYNC_RUN&quot;;
&nbsp;    private SharedPreferences 	mPrefs;
&nbsp;    private ImageView			mPillarIcon;
&nbsp;    private ImageView			mFbmIcon;
&nbsp;    private ImageView			mPassiveIcon;
&nbsp;    private ImageView			mIntersectedIcon;
&nbsp;    private ImageView			mUnsyncedIcon;
&nbsp;    private ImageView			mPhotosIcon;
&nbsp;    private TextView			mPillarCount;
&nbsp;    private TextView			mFbmCount;
&nbsp;    private TextView			mPassiveCount;
&nbsp;    private TextView			mIntersectedCount;
&nbsp;    private TextView			mUnsyncedCount;
&nbsp;    private TextView			mPhotosCount;
&nbsp;    private Button				mSyncBtn;
&nbsp;    private Button				mARViewBtn;
&nbsp;    private TextView			mUserName;
&nbsp;    private ImageView			mUserMapImage;
&nbsp;    
&nbsp;    // API authentication components
&nbsp;    private AuthApiClient authApiClient;
&nbsp;    private AuthPreferences authPreferences;
&nbsp;    
&nbsp;    // Modern activity result launchers
&nbsp;    private ActivityResultLauncher&lt;Intent&gt; nearestLauncher;
&nbsp;    private ActivityResultLauncher&lt;Intent&gt; mapLauncher;
&nbsp;    private ActivityResultLauncher&lt;Intent&gt; preferencesLauncher;
&nbsp;    
&nbsp; 	@Override
&nbsp;    public void onCreate(Bundle savedInstanceState) {
<b class="nc">&nbsp;		Log.i(TAG, &quot;onCreate: Starting MainActivity&quot;);</b>
<b class="nc">&nbsp;        super.onCreate(savedInstanceState);</b>
<b class="nc">&nbsp;        setContentView(R.layout.main);</b>
&nbsp;        
<b class="nc">&nbsp;        Log.i(TAG, &quot;onCreate: Setting up UI components&quot;);</b>
&nbsp;        // Set up UI components
<b class="nc">&nbsp;        mPillarIcon = findViewById(R.id.countPillarImage);</b>
<b class="nc">&nbsp;        mPillarCount = findViewById(R.id.countPillarText);</b>
<b class="nc">&nbsp;        mFbmIcon = findViewById(R.id.countFbmImage);</b>
<b class="nc">&nbsp;        mFbmCount = findViewById(R.id.countFbmText);</b>
<b class="nc">&nbsp;        mPassiveIcon = findViewById(R.id.countPassiveImage);</b>
<b class="nc">&nbsp;        mPassiveCount = findViewById(R.id.countPassiveText);</b>
<b class="nc">&nbsp;        mIntersectedIcon = findViewById(R.id.countIntersectedImage);</b>
<b class="nc">&nbsp;        mIntersectedCount = findViewById(R.id.countIntersectedText);</b>
<b class="nc">&nbsp;        mUnsyncedIcon = findViewById(R.id.countUnsyncedImage);</b>
<b class="nc">&nbsp;        mUnsyncedCount = findViewById(R.id.countUnsyncedText);</b>
<b class="nc">&nbsp;        mPhotosIcon = findViewById(R.id.countPhotosImage);</b>
<b class="nc">&nbsp;        mPhotosCount = findViewById(R.id.countPhotosText);</b>
<b class="nc">&nbsp;        mSyncBtn = findViewById(R.id.btnSync);</b>
<b class="nc">&nbsp;        mARViewBtn = findViewById(R.id.btnARView);</b>
<b class="nc">&nbsp;        mUserName = findViewById(R.id.txtUserName);</b>
<b class="nc">&nbsp;        mUserMapImage = findViewById(R.id.userMapImage);</b>
&nbsp;        
<b class="nc">&nbsp;        Log.i(TAG, &quot;onCreate: Setting up preferences&quot;);</b>
<b class="nc">&nbsp;        mPrefs = getSharedPreferences(&quot;TrigpointingUK&quot;, MODE_PRIVATE);</b>
&nbsp;        
&nbsp;        // Initialize API authentication components
<b class="nc">&nbsp;        authApiClient = new AuthApiClient();</b>
<b class="nc">&nbsp;        authPreferences = new AuthPreferences(this);</b>
&nbsp;        
&nbsp;        // Reset auto sync flag on app startup
<b class="nc">&nbsp;        SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(this);</b>
<b class="nc">&nbsp;        prefs.edit().putBoolean(AUTO_SYNC_RUN, false).apply();</b>
<b class="nc">&nbsp;        Log.i(TAG, &quot;onCreate: Reset auto sync flag for new app session&quot;);</b>
&nbsp;        
<b class="nc">&nbsp;        Log.i(TAG, &quot;onCreate: Setting up activity result launchers&quot;);</b>
<b class="nc">&nbsp;        setupActivityResultLaunchers();</b>
&nbsp;        
<b class="nc">&nbsp;        Log.i(TAG, &quot;onCreate: Setting up click listeners&quot;);</b>
<b class="nc">&nbsp;        setupClickListeners();</b>
&nbsp;        
<b class="nc">&nbsp;        Log.i(TAG, &quot;onCreate: Setting up back button handling&quot;);</b>
<b class="nc">&nbsp;        setupBackButtonHandling();</b>
&nbsp;        
<b class="nc">&nbsp;        Log.i(TAG, &quot;onCreate: Updating user display&quot;);</b>
<b class="nc">&nbsp;        updateUserDisplay();</b>
&nbsp;        
<b class="nc">&nbsp;        Log.i(TAG, &quot;onCreate: Populating counts&quot;);</b>
<b class="nc">&nbsp;        populateCounts();</b>
&nbsp;        
<b class="nc">&nbsp;        Log.i(TAG, &quot;onCreate: Checking for OS API key&quot;);</b>
<b class="nc">&nbsp;        checkAndFetchOsApiKey();</b>
&nbsp;        
<b class="nc">&nbsp;        Log.i(TAG, &quot;onCreate: MainActivity setup complete&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void checkAndFetchOsApiKey() {
<b class="nc">&nbsp;        CompletableFuture.runAsync(() -&gt; {</b>
<b class="nc">&nbsp;            SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(this);</b>
<b class="nc">&nbsp;            String osApiKey = prefs.getString(&quot;os_api_key&quot;, &quot;&quot;);</b>
&nbsp;
<b class="nc">&nbsp;            if (osApiKey != null &amp;&amp; !osApiKey.trim().isEmpty()) {</b>
<b class="nc">&nbsp;                Log.i(TAG, &quot;OS API key already exists.&quot;);</b>
&nbsp;                return;
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            Log.i(TAG, &quot;OS API key is missing. Fetching from URL...&quot;);</b>
<b class="nc">&nbsp;            OkHttpClient client = new OkHttpClient();</b>
<b class="nc">&nbsp;            Request request = new Request.Builder()</b>
<b class="nc">&nbsp;                    .url(&quot;https://trigpointinguk-maps.s3.eu-west-1.amazonaws.com/OS_API_KEY.txt&quot;)</b>
<b class="nc">&nbsp;                    .build();</b>
&nbsp;
<b class="nc">&nbsp;            try (Response response = client.newCall(request).execute()) {</b>
<b class="nc">&nbsp;                if (response.isSuccessful() &amp;&amp; response.body() != null) {</b>
<b class="nc">&nbsp;                    String apiKey = response.body().string().trim();</b>
<b class="nc">&nbsp;                    if (!apiKey.isEmpty()) {</b>
<b class="nc">&nbsp;                        prefs.edit().putString(&quot;os_api_key&quot;, apiKey).apply();</b>
<b class="nc">&nbsp;                        Log.i(TAG, &quot;OS API key fetched and saved successfully.&quot;);</b>
<b class="nc">&nbsp;                        runOnUiThread(() -&gt; Toast.makeText(MainActivity.this, &quot;OS API Key updated.&quot;, Toast.LENGTH_SHORT).show());</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        Log.e(TAG, &quot;Fetched OS API key is empty.&quot;);</b>
<b class="nc">&nbsp;                        runOnUiThread(() -&gt; Toast.makeText(MainActivity.this, &quot;Failed to update OS API Key: Key file is empty.&quot;, Toast.LENGTH_LONG).show());</b>
&nbsp;                    }
&nbsp;                } else {
<b class="nc">&nbsp;                    Log.e(TAG, &quot;Failed to fetch OS API key. Response code: &quot; + response.code());</b>
<b class="nc">&nbsp;                    runOnUiThread(() -&gt; Toast.makeText(MainActivity.this, &quot;Failed to update OS API Key: Server error.&quot;, Toast.LENGTH_LONG).show());</b>
&nbsp;                }
&nbsp;            } catch (IOException e) {
<b class="nc">&nbsp;                Log.e(TAG, &quot;Error checking or fetching OS API key&quot;, e);</b>
<b class="nc">&nbsp;                runOnUiThread(() -&gt; Toast.makeText(MainActivity.this, &quot;Failed to update OS API Key: Network error.&quot;, Toast.LENGTH_LONG).show());</b>
&nbsp;            }
&nbsp;        }, executor);
&nbsp;    }
&nbsp;
&nbsp;    private void setupActivityResultLaunchers() {
<b class="nc">&nbsp;        nearestLauncher = registerForActivityResult(</b>
&nbsp;            new ActivityResultContracts.StartActivityForResult(),
<b class="nc">&nbsp;            result -&gt; {}</b>
&nbsp;        );
&nbsp;        
<b class="nc">&nbsp;        mapLauncher = registerForActivityResult(</b>
&nbsp;            new ActivityResultContracts.StartActivityForResult(),
<b class="nc">&nbsp;            result -&gt; {}</b>
&nbsp;        );
&nbsp;
&nbsp;        // Handle result from FilterActivity
&nbsp;        // Handle successful result
<b class="nc">&nbsp;        ActivityResultLauncher&lt;Intent&gt; searchLauncher = registerForActivityResult(</b>
&nbsp;                new ActivityResultContracts.StartActivityForResult(),
<b class="nc">&nbsp;                result -&gt; {}</b>
&nbsp;        );
&nbsp;        
<b class="nc">&nbsp;        preferencesLauncher = registerForActivityResult(</b>
&nbsp;            new ActivityResultContracts.StartActivityForResult(),
&nbsp;            result -&gt; {
&nbsp;                // Handle result from PreferencesActivity
<b class="nc">&nbsp;                if (result.getResultCode() == RESULT_OK) {</b>
<b class="nc">&nbsp;                    TextView user = findViewById(R.id.txtUserName);</b>
<b class="nc">&nbsp;                    user.setText(mPrefs.getString(&quot;username&quot;, &quot;&quot;));</b>
&nbsp;                    
&nbsp;                    // Add user details to ACRA (disabled)
&nbsp;
<b class="nc">&nbsp;                    populateCounts();</b>
&nbsp;                }
&nbsp;            }
&nbsp;        );
&nbsp;    }
&nbsp;    
&nbsp;    private void setupClickListeners() {
<b class="nc">&nbsp;        final Button btnNearest = findViewById(R.id.btnNearest);</b>
<b class="nc">&nbsp;        btnNearest.setOnClickListener(arg0 -&gt; {</b>
<b class="nc">&nbsp;            Intent i = new Intent(MainActivity.this, NearestActivity.class);</b>
<b class="nc">&nbsp;            nearestLauncher.launch(i);</b>
&nbsp;        });
<b class="nc">&nbsp;        mSyncBtn.setOnClickListener(arg0 -&gt; doSync());</b>
&nbsp;
<b class="nc">&nbsp;        final Button btnLeafletMap = findViewById(R.id.btnLeafletMap);</b>
<b class="nc">&nbsp;        btnLeafletMap.setOnClickListener(v -&gt; {</b>
<b class="nc">&nbsp;            Intent i = new Intent(MainActivity.this, uk.trigpointing.android.mapping.LeafletMapActivity.class);</b>
<b class="nc">&nbsp;            mapLauncher.launch(i);</b>
&nbsp;        });
&nbsp;
&nbsp;        // AR View button
<b class="nc">&nbsp;        mARViewBtn.setOnClickListener(v -&gt; {</b>
<b class="nc">&nbsp;            Intent i = new Intent(MainActivity.this, uk.trigpointing.android.ar.SensorARActivity.class);</b>
<b class="nc">&nbsp;            startActivity(i);</b>
&nbsp;        });
&nbsp;
&nbsp;    }
&nbsp;    
&nbsp;    private void setupBackButtonHandling() {
&nbsp;        // Handle back button press to prevent app from closing on main activity
<b class="nc">&nbsp;        OnBackPressedCallback callback = new OnBackPressedCallback(true) {</b>
&nbsp;            @Override
&nbsp;            public void handleOnBackPressed() {
&nbsp;                // Show a toast to inform user that back button is disabled on main page
<b class="nc">&nbsp;                Toast.makeText(MainActivity.this, &quot;Press home button to minimize app&quot;, Toast.LENGTH_SHORT).show();</b>
<b class="nc">&nbsp;                Log.i(TAG, &quot;Back button pressed on main activity - staying on main page&quot;);</b>
&nbsp;                // Do nothing - this prevents the default back behavior (closing the app)
&nbsp;            }
&nbsp;        };
<b class="nc">&nbsp;        getOnBackPressedDispatcher().addCallback(this, callback);</b>
<b class="nc">&nbsp;        Log.i(TAG, &quot;setupBackButtonHandling: Back button handling configured&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;	@Override
&nbsp;	protected void onSaveInstanceState(Bundle outState) {
<b class="nc">&nbsp;		outState.putBoolean(RUNBEFORE, true);</b>
<b class="nc">&nbsp;		super.onSaveInstanceState(outState);</b>
&nbsp;	}
&nbsp;	
&nbsp;	@Override
&nbsp;	protected void onDestroy() {
<b class="nc">&nbsp;		super.onDestroy();</b>
<b class="nc">&nbsp;		if (executor != null &amp;&amp; !executor.isShutdown()) {</b>
<b class="nc">&nbsp;			executor.shutdown();</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;    public boolean onCreateOptionsMenu(Menu menu) {
<b class="nc">&nbsp;        getMenuInflater().inflate(R.menu.mainmenu, menu);</b>
&nbsp;
<b class="nc">&nbsp;        SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(this);</b>
<b class="nc">&nbsp;        boolean devMode = prefs.getBoolean(&quot;dev_mode&quot;, false);</b>
&nbsp;        
&nbsp;        // Check both API authentication and legacy authentication
<b class="nc">&nbsp;        boolean loggedIn = authPreferences.isLoggedIn() || !prefs.getString(&quot;username&quot;, &quot;&quot;).isEmpty();</b>
&nbsp;
&nbsp;        // These items are always visible, so no changes needed for them.
&nbsp;        // menu.findItem(R.id.action_settings).setVisible(true);
&nbsp;        // menu.findItem(R.id.action_about).setVisible(true);
&nbsp;
&nbsp;        // These items are only visible in developer mode.
<b class="nc">&nbsp;        menu.findItem(R.id.action_refresh).setVisible(devMode);</b>
<b class="nc">&nbsp;        menu.findItem(R.id.action_clearcache).setVisible(devMode);</b>
<b class="nc">&nbsp;        menu.findItem(R.id.action_cachestatus).setVisible(devMode);</b>
<b class="nc">&nbsp;        menu.findItem(R.id.action_testcrash).setVisible(devMode);</b>
<b class="nc">&nbsp;        menu.findItem(R.id.action_exit).setVisible(devMode);</b>
&nbsp;
<b class="nc">&nbsp;        menu.findItem(R.id.action_login).setVisible(!loggedIn);</b>
<b class="nc">&nbsp;        menu.findItem(R.id.action_logout).setVisible(loggedIn);</b>
&nbsp;
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean onOptionsItemSelected(MenuItem item) {
<b class="nc">&nbsp;        int itemId = item.getItemId();</b>
&nbsp;
<b class="nc">&nbsp;        if (itemId == R.id.action_settings) {</b>
<b class="nc">&nbsp;            startActivity(new Intent(this, SettingsActivity.class));</b>
<b class="nc">&nbsp;            return true;</b>
<b class="nc">&nbsp;        } else if (itemId == R.id.action_about) {</b>
<b class="nc">&nbsp;            startActivity(new Intent(this, AboutActivity.class));</b>
<b class="nc">&nbsp;            return true;</b>
<b class="nc">&nbsp;        } else if (itemId == R.id.action_login) {</b>
<b class="nc">&nbsp;            showLoginDialog();</b>
<b class="nc">&nbsp;            return true;</b>
<b class="nc">&nbsp;        } else if (itemId == R.id.action_logout) {</b>
<b class="nc">&nbsp;            doLogout();</b>
<b class="nc">&nbsp;            return true;</b>
<b class="nc">&nbsp;        } else if (itemId == R.id.action_refresh) {</b>
<b class="nc">&nbsp;            startActivity(new Intent(this, DownloadTrigsActivity.class));</b>
<b class="nc">&nbsp;            return true;</b>
<b class="nc">&nbsp;        } else if (itemId == R.id.action_clearcache) {</b>
<b class="nc">&nbsp;            new ClearCacheTask(this).execute();</b>
<b class="nc">&nbsp;            return true;</b>
<b class="nc">&nbsp;        } else if (itemId == R.id.action_cachestatus) {</b>
&nbsp;            // Implement cache status functionality
<b class="nc">&nbsp;            return true;</b>
<b class="nc">&nbsp;        } else if (itemId == R.id.action_testcrash) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Test Crash&quot;);</b>
<b class="nc">&nbsp;        } else if (itemId == R.id.action_exit) {</b>
<b class="nc">&nbsp;            finish();</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return super.onOptionsItemSelected(item);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void showLoginDialog() {
<b class="nc">&nbsp;        showLoginDialog(null);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void showLoginDialog(String errorMessage) {
<b class="nc">&nbsp;        AlertDialog.Builder builder = new AlertDialog.Builder(this);</b>
<b class="nc">&nbsp;        builder.setTitle(&quot;Login&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        View view = getLayoutInflater().inflate(R.layout.dialog_login, null);</b>
<b class="nc">&nbsp;        builder.setView(view);</b>
&nbsp;
<b class="nc">&nbsp;        final EditText username = view.findViewById(R.id.username);</b>
<b class="nc">&nbsp;        final EditText password = view.findViewById(R.id.password);</b>
&nbsp;
&nbsp;        // If there&#39;s an error message, add it to the dialog
<b class="nc">&nbsp;        if (errorMessage != null &amp;&amp; !errorMessage.isEmpty()) {</b>
<b class="nc">&nbsp;            TextView errorText = new TextView(this);</b>
<b class="nc">&nbsp;            errorText.setText(errorMessage);</b>
<b class="nc">&nbsp;            errorText.setTextColor(ContextCompat.getColor(this, android.R.color.holo_red_dark));</b>
<b class="nc">&nbsp;            errorText.setPadding(24, 8, 24, 16);</b>
&nbsp;            
&nbsp;            // Create a new container to include the error message
<b class="nc">&nbsp;            LinearLayout container = new LinearLayout(this);</b>
<b class="nc">&nbsp;            container.setOrientation(LinearLayout.VERTICAL);</b>
<b class="nc">&nbsp;            container.addView(errorText);</b>
<b class="nc">&nbsp;            container.addView(view);</b>
<b class="nc">&nbsp;            builder.setView(container);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        builder.setPositiveButton(&quot;Login&quot;, null); // Set to null initially</b>
<b class="nc">&nbsp;        builder.setNegativeButton(&quot;Cancel&quot;, (dialog, which) -&gt; {</b>
&nbsp;            // Clear any stored authentication data on cancel
<b class="nc">&nbsp;            authPreferences.clearAuthData();</b>
<b class="nc">&nbsp;            SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(this);</b>
<b class="nc">&nbsp;            SharedPreferences.Editor editor = prefs.edit();</b>
<b class="nc">&nbsp;            editor.remove(&quot;username&quot;);</b>
<b class="nc">&nbsp;            editor.remove(&quot;plaintextpassword&quot;);</b>
<b class="nc">&nbsp;            editor.apply();</b>
&nbsp;            
<b class="nc">&nbsp;            updateUserDisplay();</b>
<b class="nc">&nbsp;            invalidateOptionsMenu();</b>
<b class="nc">&nbsp;            dialog.cancel();</b>
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        AlertDialog dialog = builder.create();</b>
&nbsp;        
&nbsp;        // Override the positive button to handle authentication
<b class="nc">&nbsp;        dialog.setOnShowListener(dialogInterface -&gt; {</b>
<b class="nc">&nbsp;            Button loginButton = dialog.getButton(AlertDialog.BUTTON_POSITIVE);</b>
<b class="nc">&nbsp;            loginButton.setOnClickListener(v -&gt; {</b>
<b class="nc">&nbsp;                String user = username.getText().toString().trim();</b>
<b class="nc">&nbsp;                String pass = password.getText().toString().trim();</b>
&nbsp;
<b class="nc">&nbsp;                if (user.isEmpty() || pass.isEmpty()) {</b>
<b class="nc">&nbsp;                    Toast.makeText(this, &quot;Please enter both username and password&quot;, Toast.LENGTH_SHORT).show();</b>
&nbsp;                    return;
&nbsp;                }
&nbsp;
&nbsp;                // Disable the login button and show progress
<b class="nc">&nbsp;                loginButton.setEnabled(false);</b>
<b class="nc">&nbsp;                loginButton.setText(&quot;Logging in...&quot;);</b>
&nbsp;
&nbsp;                // Authenticate with the new API
<b class="nc">&nbsp;                authApiClient.authenticate(user, pass, new AuthApiClient.AuthCallback() {</b>
&nbsp;                    @Override
&nbsp;                    public void onSuccess(uk.trigpointing.android.api.AuthResponse authResponse) {
<b class="nc">&nbsp;                        runOnUiThread(() -&gt; {</b>
<b class="nc">&nbsp;                            Log.i(TAG, &quot;API authentication successful for user: &quot; + authResponse.getUser().getName());</b>
&nbsp;                            
&nbsp;                            // Store the API authentication data
<b class="nc">&nbsp;                            authPreferences.storeAuthData(authResponse);</b>
&nbsp;                            
&nbsp;                            // Also store legacy credentials for backward compatibility
<b class="nc">&nbsp;                            SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(MainActivity.this);</b>
<b class="nc">&nbsp;                            SharedPreferences.Editor editor = prefs.edit();</b>
<b class="nc">&nbsp;                            editor.putString(&quot;username&quot;, user);</b>
<b class="nc">&nbsp;                            editor.putString(&quot;plaintextpassword&quot;, pass);</b>
<b class="nc">&nbsp;                            editor.apply();</b>
&nbsp;
&nbsp;                            // Update UI and close dialog
<b class="nc">&nbsp;                            updateUserDisplay();</b>
<b class="nc">&nbsp;                            invalidateOptionsMenu();</b>
<b class="nc">&nbsp;                            dialog.dismiss();</b>
&nbsp;                            
&nbsp;                            // Start sync
<b class="nc">&nbsp;                            doSync();</b>
&nbsp;                            
<b class="nc">&nbsp;                            Toast.makeText(MainActivity.this, &quot;Login successful!&quot;, Toast.LENGTH_SHORT).show();</b>
&nbsp;                        });
&nbsp;                    }
&nbsp;
&nbsp;                    @Override
&nbsp;                    public void onError(String errorMessage) {
<b class="nc">&nbsp;                        runOnUiThread(() -&gt; {</b>
<b class="nc">&nbsp;                            Log.w(TAG, &quot;API authentication failed: &quot; + errorMessage);</b>
&nbsp;                            
&nbsp;                            // Re-enable the login button
<b class="nc">&nbsp;                            loginButton.setEnabled(true);</b>
<b class="nc">&nbsp;                            loginButton.setText(&quot;Login&quot;);</b>
&nbsp;                            
&nbsp;                            // Close current dialog and show new one with error
<b class="nc">&nbsp;                            dialog.dismiss();</b>
<b class="nc">&nbsp;                            showLoginDialog(errorMessage);</b>
&nbsp;                        });
&nbsp;                    }
&nbsp;                });
&nbsp;            });
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        dialog.show();</b>
&nbsp;    }
&nbsp;
&nbsp;    private void doLogout() {
&nbsp;        // Clear new API authentication data
<b class="nc">&nbsp;        authPreferences.clearAuthData();</b>
&nbsp;        
&nbsp;        // Clear legacy authentication data
<b class="nc">&nbsp;        SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(this);</b>
<b class="nc">&nbsp;        SharedPreferences.Editor editor = prefs.edit();</b>
<b class="nc">&nbsp;        editor.remove(&quot;username&quot;);</b>
<b class="nc">&nbsp;        editor.remove(&quot;plaintextpassword&quot;);</b>
<b class="nc">&nbsp;        editor.apply();</b>
&nbsp;
&nbsp;        // Clear user logs from database
<b class="nc">&nbsp;        DbHelper dbHelper = new DbHelper(this);</b>
<b class="nc">&nbsp;        dbHelper.open();</b>
<b class="nc">&nbsp;        dbHelper.clearUserLogs();</b>
&nbsp;        dbHelper.close();
&nbsp;
<b class="nc">&nbsp;        updateUserDisplay();</b>
<b class="nc">&nbsp;        invalidateOptionsMenu();</b>
&nbsp;        
<b class="nc">&nbsp;        Toast.makeText(this, &quot;Logged out successfully&quot;, Toast.LENGTH_SHORT).show();</b>
&nbsp;    }
&nbsp; 
&nbsp;    
&nbsp;    
&nbsp;	@Override
&nbsp;	protected void onResume() {
<b class="nc">&nbsp;		Log.i(TAG, &quot;onResume: Refreshing counts and user display&quot;);</b>
<b class="nc">&nbsp;		super.onResume();</b>
<b class="nc">&nbsp;		invalidateOptionsMenu();</b>
<b class="nc">&nbsp;		updateUserDisplay();</b>
<b class="nc">&nbsp;		populateCounts();</b>
<b class="nc">&nbsp;		checkAndPopulateDatabase();</b>
<b class="nc">&nbsp;		checkAndPerformAutoSync();</b>
&nbsp;	}
&nbsp;
&nbsp;
&nbsp;    private void doSync() {
<b class="nc">&nbsp;		Log.i(TAG, &quot;doSync&quot;);</b>
<b class="nc">&nbsp;		new SyncTask(MainActivity.this, MainActivity.this).execute(false);</b>
&nbsp;    }
&nbsp;    
&nbsp;
&nbsp;	@Override
&nbsp;	public void onSynced(int status) {
<b class="nc">&nbsp;		Log.i(TAG, &quot;onSynced&quot;);</b>
<b class="nc">&nbsp;		populateCounts();</b>
&nbsp;	}
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
<b class="nc">&nbsp;	private final ExecutorService executor = Executors.newSingleThreadExecutor();</b>
&nbsp;	
&nbsp;	private void updateUserDisplay() {
<b class="nc">&nbsp;		Log.i(TAG, &quot;updateUserDisplay: Updating user display&quot;);</b>
&nbsp;		try {
<b class="nc">&nbsp;			View countSection = findViewById(R.id.count_section);</b>
<b class="nc">&nbsp;			SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(this);</b>
<b class="nc">&nbsp;			boolean devMode = prefs.getBoolean(&quot;dev_mode&quot;, false);</b>
&nbsp;			
&nbsp;			String displayName;
<b class="nc">&nbsp;			boolean isLoggedIn = false;</b>
&nbsp;			
&nbsp;			// Check if we have API authentication data first
<b class="nc">&nbsp;			if (authPreferences.isLoggedIn()) {</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;updateUserDisplay: User is logged in via API&quot;);</b>
&nbsp;				
<b class="nc">&nbsp;				if (devMode) {</b>
<b class="nc">&nbsp;					displayName = authPreferences.getDisplayNameWithId();</b>
<b class="nc">&nbsp;					Log.i(TAG, &quot;updateUserDisplay: Developer mode - showing name with ID: &quot; + displayName);</b>
&nbsp;				} else {
<b class="nc">&nbsp;					displayName = authPreferences.getDisplayName();</b>
<b class="nc">&nbsp;					Log.i(TAG, &quot;updateUserDisplay: Normal mode - showing name: &quot; + displayName);</b>
&nbsp;				}
<b class="nc">&nbsp;				isLoggedIn = true;</b>
&nbsp;			} else {
&nbsp;				// Fallback to legacy username for backward compatibility
<b class="nc">&nbsp;				String legacyUsername = prefs.getString(&quot;username&quot;, &quot;&quot;);</b>
<b class="nc">&nbsp;				if (!legacyUsername.trim().isEmpty()) {</b>
<b class="nc">&nbsp;					Log.i(TAG, &quot;updateUserDisplay: Using legacy username: &quot; + legacyUsername);</b>
<b class="nc">&nbsp;					displayName = legacyUsername;</b>
<b class="nc">&nbsp;					if (devMode) {</b>
<b class="nc">&nbsp;						displayName += &quot; (legacy)&quot;;</b>
&nbsp;					}
<b class="nc">&nbsp;					isLoggedIn = true;</b>
&nbsp;				} else {
<b class="nc">&nbsp;					Log.i(TAG, &quot;updateUserDisplay: No authentication found&quot;);</b>
<b class="nc">&nbsp;					displayName = &quot;Not logged in&quot;;</b>
<b class="nc">&nbsp;					isLoggedIn = false;</b>
&nbsp;				}
&nbsp;			}
&nbsp;			
<b class="nc">&nbsp;			mUserName.setText(displayName);</b>
&nbsp;			
<b class="nc">&nbsp;			if (isLoggedIn) {</b>
<b class="nc">&nbsp;				countSection.setVisibility(View.VISIBLE);</b>
<b class="nc">&nbsp;				mSyncBtn.setVisibility(View.VISIBLE);</b>
<b class="nc">&nbsp;				updateUserMap();</b>
&nbsp;			} else {
<b class="nc">&nbsp;				countSection.setVisibility(View.INVISIBLE);</b>
<b class="nc">&nbsp;				mSyncBtn.setVisibility(View.INVISIBLE);</b>
<b class="nc">&nbsp;				mUserMapImage.setVisibility(View.GONE);</b>
&nbsp;			}
&nbsp;			
&nbsp;					// AR View is available to all users
<b class="nc">&nbsp;		mARViewBtn.setVisibility(View.VISIBLE);</b>
&nbsp;			
&nbsp;		} catch (Exception e) {
<b class="nc">&nbsp;			Log.e(TAG, &quot;updateUserDisplay: Error updating user display&quot;, e);</b>
<b class="nc">&nbsp;			e.printStackTrace();</b>
<b class="nc">&nbsp;			mUserName.setText(&quot;Not logged in&quot;);</b>
&nbsp;		}
&nbsp;	}
&nbsp;	
&nbsp;	private void updateUserMap() {
<b class="nc">&nbsp;		Log.i(TAG, &quot;updateUserMap: Updating user map image&quot;);</b>
&nbsp;		try {
&nbsp;			// Only load map if user is logged in via API
<b class="nc">&nbsp;			if (authPreferences.isLoggedIn()) {</b>
<b class="nc">&nbsp;				User user = authPreferences.getUser();</b>
<b class="nc">&nbsp;				if (user != null) {</b>
<b class="nc">&nbsp;					String mapUrl = &quot;https://trigpointing.uk/pics/make_map.php?u=&quot; + user.getId() + &quot;&amp;v=y&quot;;</b>
<b class="nc">&nbsp;					Log.i(TAG, &quot;updateUserMap: Loading map for user ID &quot; + user.getId() + &quot; from URL: &quot; + mapUrl);</b>
&nbsp;					
&nbsp;					// Load the image using Coil
<b class="nc">&nbsp;					ImageRequest request = new ImageRequest.Builder(this)</b>
<b class="nc">&nbsp;							.data(mapUrl)</b>
<b class="nc">&nbsp;							.target(mUserMapImage)</b>
<b class="nc">&nbsp;							.placeholder(android.R.drawable.ic_menu_mapmode) // Show placeholder while loading</b>
<b class="nc">&nbsp;							.error(android.R.drawable.ic_dialog_alert) // Show error icon if loading fails</b>
<b class="nc">&nbsp;							.build();</b>
&nbsp;					
&nbsp;					// Show the ImageView and load the image
<b class="nc">&nbsp;					mUserMapImage.setVisibility(View.VISIBLE);</b>
<b class="nc">&nbsp;					ImageLoader imageLoader = Coil.imageLoader(this);</b>
<b class="nc">&nbsp;					imageLoader.enqueue(request);</b>
&nbsp;					
&nbsp;					// Add click listener to open full map view
<b class="nc">&nbsp;					mUserMapImage.setOnClickListener(v -&gt; {</b>
<b class="nc">&nbsp;						String fullMapUrl = &quot;https://trigpointing.uk/pics/make_map.php?u=&quot; + user.getId() + &quot;&amp;v=y&quot;;</b>
<b class="nc">&nbsp;						android.content.Intent intent = new android.content.Intent(android.content.Intent.ACTION_VIEW, android.net.Uri.parse(fullMapUrl));</b>
<b class="nc">&nbsp;						startActivity(intent);</b>
&nbsp;					});
&nbsp;				} else {
<b class="nc">&nbsp;					Log.w(TAG, &quot;updateUserMap: User object is null, hiding map&quot;);</b>
<b class="nc">&nbsp;					mUserMapImage.setVisibility(View.GONE);</b>
&nbsp;				}
&nbsp;			} else {
<b class="nc">&nbsp;				Log.i(TAG, &quot;updateUserMap: User not logged in via API, hiding map&quot;);</b>
<b class="nc">&nbsp;				mUserMapImage.setVisibility(View.GONE);</b>
&nbsp;			}
&nbsp;		} catch (Exception e) {
<b class="nc">&nbsp;			Log.e(TAG, &quot;updateUserMap: Error updating user map&quot;, e);</b>
<b class="nc">&nbsp;			e.printStackTrace();</b>
<b class="nc">&nbsp;			mUserMapImage.setVisibility(View.GONE);</b>
&nbsp;		}
&nbsp;	}
&nbsp;	
&nbsp;	private void populateCounts() {
<b class="nc">&nbsp;		Log.i(TAG, &quot;populateCounts: Starting count population&quot;);</b>
&nbsp;		// Show loading state
<b class="nc">&nbsp;		runOnUiThread(() -&gt; {</b>
&nbsp;			try {
<b class="nc">&nbsp;				Log.i(TAG, &quot;populateCounts: Setting loading state&quot;);</b>
<b class="nc">&nbsp;				mPillarIcon.setImageResource(R.drawable.t_pillar);</b>
<b class="nc">&nbsp;				mPillarCount.setText(&quot;&quot;);</b>
<b class="nc">&nbsp;				mFbmIcon.setImageResource(R.drawable.t_fbm);</b>
<b class="nc">&nbsp;				mFbmCount.setText(&quot;&quot;);</b>
<b class="nc">&nbsp;				mPassiveIcon.setImageResource(R.drawable.t_passive);</b>
<b class="nc">&nbsp;				mPassiveCount.setText(&quot;&quot;);</b>
<b class="nc">&nbsp;				mIntersectedIcon.setImageResource(R.drawable.t_intersected);</b>
<b class="nc">&nbsp;				mIntersectedCount.setText(&quot;&quot;);</b>
<b class="nc">&nbsp;				mUnsyncedIcon.setVisibility(View.INVISIBLE);</b>
<b class="nc">&nbsp;				mUnsyncedCount.setText(&quot;&quot;);</b>
<b class="nc">&nbsp;				mPhotosIcon.setVisibility(View.INVISIBLE);</b>
<b class="nc">&nbsp;				mPhotosCount.setText(&quot;&quot;);</b>
<b class="nc">&nbsp;				                mSyncBtn.setTextColor(ContextCompat.getColor(this, android.R.color.primary_text_light));</b>
&nbsp;			} catch (NotFoundException e) {
<b class="nc">&nbsp;				Log.e(TAG, &quot;populateCounts: Error setting loading state&quot;, e);</b>
<b class="nc">&nbsp;				e.printStackTrace();</b>
&nbsp;			}
&nbsp;		});
&nbsp;		
&nbsp;		// Run database operations in background
<b class="nc">&nbsp;		CompletableFuture.supplyAsync(() -&gt; {</b>
<b class="nc">&nbsp;			Log.i(TAG, &quot;populateCounts: Starting database operations&quot;);</b>
<b class="nc">&nbsp;			DbHelper mDb = new DbHelper(MainActivity.this);</b>
&nbsp;			try {
<b class="nc">&nbsp;				Log.i(TAG, &quot;populateCounts: Opening database&quot;);</b>
<b class="nc">&nbsp;				mDb.open();</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;populateCounts: Counting pillars&quot;);</b>
<b class="nc">&nbsp;				int nPillar = mDb.countLoggedPillars();</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;populateCounts: Counting FBMs&quot;);</b>
<b class="nc">&nbsp;				int nFbm = mDb.countLoggedFbms();</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;populateCounts: Counting passives&quot;);</b>
<b class="nc">&nbsp;				int nPassive = mDb.countLoggedPassives();</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;populateCounts: Counting intersected&quot;);</b>
<b class="nc">&nbsp;				int nIntersected = mDb.countLoggedIntersecteds();</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;populateCounts: Counting unsynced&quot;);</b>
<b class="nc">&nbsp;				int nUnsynced = mDb.countUnsynced();</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;populateCounts: Counting photos&quot;);</b>
<b class="nc">&nbsp;				int nPhotos = mDb.countPhotos();</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;populateCounts: Closing database&quot;);</b>
&nbsp;				mDb.close();
&nbsp;				
<b class="nc">&nbsp;				Log.i(TAG, &quot;populateCounts: Database counts - Pillars: &quot; + nPillar + &quot;, FBMs: &quot; + nFbm + &quot;, Passives: &quot; + nPassive + &quot;, Intersected: &quot; + nIntersected + &quot;, Unsynced: &quot; + nUnsynced + &quot;, Photos: &quot; + nPhotos);</b>
<b class="nc">&nbsp;				return new int[]{nPillar, nFbm, nPassive, nIntersected, nUnsynced, nPhotos};</b>
&nbsp;			} catch (SQLException e) {
<b class="nc">&nbsp;				Log.e(TAG, &quot;populateCounts: SQLException during database operations&quot;, e);</b>
<b class="nc">&nbsp;				e.printStackTrace();</b>
<b class="nc">&nbsp;				return new int[]{0, 0, 0, 0, 0, 0};</b>
&nbsp;			} catch (Exception e) {
<b class="nc">&nbsp;				Log.e(TAG, &quot;populateCounts: Unexpected exception during database operations&quot;, e);</b>
<b class="nc">&nbsp;				e.printStackTrace();</b>
<b class="nc">&nbsp;				return new int[]{0, 0, 0, 0, 0, 0};</b>
&nbsp;			}
<b class="nc">&nbsp;		}, executor).thenAcceptAsync(counts -&gt; {</b>
&nbsp;			// Update UI on main thread
<b class="nc">&nbsp;			runOnUiThread(() -&gt; {</b>
&nbsp;				try {
<b class="nc">&nbsp;					Log.i(TAG, &quot;populateCounts: Updating UI with counts&quot;);</b>
<b class="nc">&nbsp;					int nPillar = counts[0];</b>
<b class="nc">&nbsp;					int nFbm = counts[1];</b>
<b class="nc">&nbsp;					int nPassive = counts[2];</b>
<b class="nc">&nbsp;					int nIntersected = counts[3];</b>
<b class="nc">&nbsp;					int nUnsynced = counts[4];</b>
<b class="nc">&nbsp;					int nPhotos = counts[5];</b>
&nbsp;					
<b class="nc">&nbsp;					mPillarCount.setText(String.valueOf(nPillar));</b>
<b class="nc">&nbsp;					mFbmCount.setText(String.valueOf(nFbm));</b>
<b class="nc">&nbsp;					mPassiveCount.setText(String.valueOf(nPassive));</b>
<b class="nc">&nbsp;					mIntersectedCount.setText(String.valueOf(nIntersected));</b>
&nbsp;					
<b class="nc">&nbsp;					if (nUnsynced &gt; 0) {</b>
<b class="nc">&nbsp;						mUnsyncedIcon.setVisibility(View.VISIBLE);</b>
<b class="nc">&nbsp;						mUnsyncedCount.setText(String.valueOf(nUnsynced));</b>
<b class="nc">&nbsp;						                mSyncBtn.setTextColor(ContextCompat.getColor(this, R.color.syncNow));</b>
&nbsp;					}
&nbsp;					
<b class="nc">&nbsp;					if (nPhotos &gt; 0) {</b>
<b class="nc">&nbsp;						mPhotosIcon.setVisibility(View.VISIBLE);</b>
<b class="nc">&nbsp;						mPhotosCount.setText(String.valueOf(nPhotos));</b>
&nbsp;					}
&nbsp;					
<b class="nc">&nbsp;					Log.i(TAG, &quot;populateCounts: UI update complete&quot;);</b>
&nbsp;				} catch (Exception e) {
<b class="nc">&nbsp;					Log.e(TAG, &quot;populateCounts: Error updating UI&quot;, e);</b>
<b class="nc">&nbsp;					e.printStackTrace();</b>
&nbsp;				}
&nbsp;			});
<b class="nc">&nbsp;		}).exceptionally(throwable -&gt; {</b>
<b class="nc">&nbsp;			Log.e(TAG, &quot;populateCounts: Exception in async operation&quot;, throwable);</b>
<b class="nc">&nbsp;			throwable.printStackTrace();</b>
<b class="nc">&nbsp;			return null;</b>
&nbsp;		});
&nbsp;	}
&nbsp;	
&nbsp;	private void checkAndPopulateDatabase() {
<b class="nc">&nbsp;		Log.i(TAG, &quot;checkAndPopulateDatabase: Checking if database needs population&quot;);</b>
&nbsp;		
<b class="nc">&nbsp;		CompletableFuture.supplyAsync(() -&gt; {</b>
<b class="nc">&nbsp;			DbHelper mDb = new DbHelper(MainActivity.this);</b>
&nbsp;			try {
<b class="nc">&nbsp;				mDb.open();</b>
<b class="nc">&nbsp;				boolean isPopulated = mDb.isTrigTablePopulated();</b>
&nbsp;				mDb.close();
<b class="nc">&nbsp;				return isPopulated;</b>
&nbsp;			} catch (Exception e) {
<b class="nc">&nbsp;				Log.e(TAG, &quot;checkAndPopulateDatabase: Error checking database&quot;, e);</b>
<b class="nc">&nbsp;				return false;</b>
&nbsp;			}
<b class="nc">&nbsp;		}, executor).thenAcceptAsync(isPopulated -&gt; {</b>
<b class="nc">&nbsp;			if (!isPopulated) {</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;checkAndPopulateDatabase: Database is empty, starting automatic population&quot;);</b>
<b class="nc">&nbsp;				runOnUiThread(() -&gt; {</b>
<b class="nc">&nbsp;					Toast.makeText(MainActivity.this, &quot;Database is empty. Starting automatic download...&quot;, Toast.LENGTH_LONG).show();</b>
<b class="nc">&nbsp;					Intent intent = new Intent(MainActivity.this, DownloadTrigsActivity.class);</b>
<b class="nc">&nbsp;					startActivity(intent);</b>
&nbsp;				});
&nbsp;			} else {
<b class="nc">&nbsp;				Log.i(TAG, &quot;checkAndPopulateDatabase: Database is already populated&quot;);</b>
&nbsp;			}
&nbsp;		});
&nbsp;	}
&nbsp;	
&nbsp;	private void checkAndPerformAutoSync() {
<b class="nc">&nbsp;		Log.i(TAG, &quot;checkAndPerformAutoSync: Checking if auto sync is enabled&quot;);</b>
&nbsp;		
<b class="nc">&nbsp;		SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(this);</b>
<b class="nc">&nbsp;		boolean autoSyncEnabled = prefs.getBoolean(&quot;auto_sync&quot;, false);</b>
<b class="nc">&nbsp;		boolean autoSyncAlreadyRun = prefs.getBoolean(AUTO_SYNC_RUN, false);</b>
&nbsp;		
<b class="nc">&nbsp;		Log.i(TAG, &quot;checkAndPerformAutoSync: Auto sync enabled: &quot; + autoSyncEnabled + &quot;, already run: &quot; + autoSyncAlreadyRun);</b>
&nbsp;		
<b class="nc">&nbsp;		if (autoSyncEnabled &amp;&amp; !autoSyncAlreadyRun) {</b>
<b class="nc">&nbsp;			Log.i(TAG, &quot;checkAndPerformAutoSync: Auto sync is enabled and not yet run, starting sync&quot;);</b>
&nbsp;			// Check if user has credentials
<b class="nc">&nbsp;			String username = prefs.getString(&quot;username&quot;, &quot;&quot;);</b>
<b class="nc">&nbsp;			String password = prefs.getString(&quot;plaintextpassword&quot;, &quot;&quot;);</b>
&nbsp;			
<b class="nc">&nbsp;			if (!username.trim().isEmpty() &amp;&amp; !password.trim().isEmpty()) {</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;checkAndPerformAutoSync: Credentials found, performing auto sync&quot;);</b>
&nbsp;				// Mark that auto sync has been run
<b class="nc">&nbsp;				prefs.edit().putBoolean(AUTO_SYNC_RUN, true).apply();</b>
<b class="nc">&nbsp;				new SyncTask(MainActivity.this, MainActivity.this).execute(false);</b>
&nbsp;			} else {
<b class="nc">&nbsp;				Log.i(TAG, &quot;checkAndPerformAutoSync: No credentials found, skipping auto sync&quot;);</b>
&nbsp;			}
<b class="nc">&nbsp;		} else if (autoSyncEnabled) {</b>
<b class="nc">&nbsp;			Log.i(TAG, &quot;checkAndPerformAutoSync: Auto sync is enabled but already run this session&quot;);</b>
&nbsp;		} else {
<b class="nc">&nbsp;			Log.i(TAG, &quot;checkAndPerformAutoSync: Auto sync is disabled&quot;);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;
&nbsp;}
&nbsp;
&nbsp;	
&nbsp;	
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-08-25 13:52</div>
</div>
</body>
</html>
