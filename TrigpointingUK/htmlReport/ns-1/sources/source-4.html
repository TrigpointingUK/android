


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DbHelper</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">uk.trigpointing.android</a>
</div>

<h1>Coverage Summary for Class: DbHelper (uk.trigpointing.android)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DbHelper</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/50)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/215)
  </span>
</td>
</tr>
  <tr>
    <td class="name">DbHelper$DatabaseHelper</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/35)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/54)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/234)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package uk.trigpointing.android;
&nbsp;
&nbsp;import uk.trigpointing.android.mapping.BoundingBox;
&nbsp;
&nbsp;import android.content.ContentValues;
&nbsp;import android.content.Context;
&nbsp;import android.content.SharedPreferences;
&nbsp;import android.database.Cursor;
&nbsp;import android.database.SQLException;
&nbsp;import android.database.sqlite.SQLiteDatabase;
&nbsp;import android.database.sqlite.SQLiteOpenHelper;
&nbsp;import android.location.Location;
&nbsp;import androidx.preference.PreferenceManager;
&nbsp;import android.util.Log;
&nbsp;import android.widget.Toast;
&nbsp;
&nbsp;import uk.trigpointing.android.filter.Filter;
&nbsp;import uk.trigpointing.android.types.Condition;
&nbsp;import uk.trigpointing.android.types.PhotoSubject;
&nbsp;import uk.trigpointing.android.types.Trig;
&nbsp;
&nbsp;public class DbHelper {
&nbsp;	private static final String TAG					= &quot;DbHelper&quot;;
&nbsp;
&nbsp;	private static final int 	DATABASE_VERSION 	= 12;
&nbsp;	private static final String DATABASE_NAME		= &quot;trigpointinguk&quot;;
&nbsp;	public  static final String TRIG_TABLE			= &quot;trig&quot;;
&nbsp;	public 	static final String TRIG_ID				= &quot;_id&quot;;
&nbsp;	public 	static final String TRIG_NAME			= &quot;name&quot;;
&nbsp;	public 	static final String TRIG_WAYPOINT		= &quot;waypoint&quot;;
&nbsp;	public 	static final String TRIG_LAT			= &quot;lat&quot;;
&nbsp;	public 	static final String TRIG_LON			= &quot;lon&quot;;
&nbsp;	public 	static final String TRIG_TYPE			= &quot;type&quot;;
&nbsp;	public 	static final String TRIG_CONDITION		= &quot;condition&quot;;
&nbsp;	public 	static final String TRIG_LOGGED			= &quot;logged&quot;;
&nbsp;	public 	static final String TRIG_CURRENT		= &quot;current&quot;;
&nbsp;	public 	static final String TRIG_HISTORIC		= &quot;historic&quot;;
&nbsp;	public 	static final String TRIG_FB				= &quot;fb&quot;;
&nbsp;	public  static final String LOG_TABLE			= &quot;log&quot;;
&nbsp;	public 	static final String LOG_ID				= &quot;_id&quot;;
&nbsp;	public 	static final String LOG_YEAR			= &quot;year&quot;;
&nbsp;	public 	static final String LOG_MONTH			= &quot;month&quot;;
&nbsp;	public 	static final String LOG_DAY				= &quot;day&quot;;
&nbsp;	public  static final String LOG_SENDTIME        = &quot;sendtime&quot;;
&nbsp;	public 	static final String LOG_HOUR			= &quot;hour&quot;;
&nbsp;	public 	static final String LOG_MINUTES			= &quot;minutes&quot;;
&nbsp;	public 	static final String LOG_GRIDREF			= &quot;gridref&quot;;
&nbsp;	public 	static final String LOG_FB				= &quot;fb&quot;;
&nbsp;	public 	static final String LOG_CONDITION		= &quot;condition&quot;;
&nbsp;	public  static final String LOG_SCORE   		= &quot;score&quot;;
&nbsp;	public 	static final String LOG_COMMENT			= &quot;comment&quot;;
&nbsp;	public 	static final String LOG_FLAGADMINS		= &quot;flagadmins&quot;;
&nbsp;	public 	static final String LOG_FLAGUSERS		= &quot;flagusers&quot;;
&nbsp;	public  static final String PHOTO_TABLE         = &quot;photo&quot;;
&nbsp;	public  static final String PHOTO_ID			= &quot;_id&quot;;
&nbsp;	public  static final String PHOTO_TRIG          = &quot;trig&quot;;
&nbsp;	public  static final String PHOTO_ICON          = &quot;icon&quot;;
&nbsp;	public  static final String PHOTO_PHOTO         = &quot;photo&quot;;
&nbsp;	public  static final String PHOTO_NAME          = &quot;name&quot;;
&nbsp;	public  static final String PHOTO_DESCR         = &quot;descr&quot;;
&nbsp;	public  static final String PHOTO_SUBJECT       = &quot;subject&quot;;
&nbsp;	public  static final String PHOTO_ISPUBLIC      = &quot;ispublic&quot;;
&nbsp;	public  static final String PHOTO_TUKLOGID      = &quot;tuklogid&quot;;
&nbsp;	public  static final String MARK_TABLE          = &quot;mark&quot;;
&nbsp;	public  static final String MARK_ID			    = &quot;_id&quot;;	
&nbsp;	public  static final String JOIN_UNSYNCED       = &quot;unsynced&quot;;
&nbsp;	public  static final String JOIN_MARKED         = &quot;marked&quot;;
&nbsp;
&nbsp;
&nbsp;	public  static final String DEFAULT_MAP_COUNT   = &quot;500&quot;;
&nbsp;
&nbsp;
&nbsp;	private static final String TRIG_CREATE = &quot;create table &quot; + TRIG_TABLE + &quot;(&quot;
&nbsp;		+ TRIG_ID 		 + &quot; integer primary key, &quot;
&nbsp;		+ TRIG_NAME		 + &quot; text not null, &quot;
&nbsp;		+ TRIG_WAYPOINT  + &quot; text not null, &quot;
&nbsp;		+ TRIG_LAT		 + &quot; real not null, &quot;
&nbsp;		+ TRIG_LON		 + &quot; real not null, &quot; 
&nbsp;		+ TRIG_TYPE		 + &quot; integer not null, &quot;
&nbsp;		+ TRIG_CONDITION + &quot; char(1) not null, &quot;
&nbsp;		+ TRIG_LOGGED    + &quot; condition char(1) not null, &quot;
&nbsp;		+ TRIG_CURRENT   + &quot; integer not null, &quot;
&nbsp;		+ TRIG_HISTORIC  + &quot; integer not null, &quot; 
&nbsp;		+ TRIG_FB		 + &quot; text&quot;
&nbsp;		+ &quot;);&quot;;
&nbsp;
&nbsp;	private static final String LOG_CREATE = &quot;create table &quot; + LOG_TABLE + &quot;(&quot;
&nbsp;		+ LOG_ID		 + &quot; integer primary key, &quot;
&nbsp;		+ LOG_YEAR	     + &quot; integer not null, &quot;
&nbsp;		+ LOG_MONTH		 + &quot; integer not null, &quot;
&nbsp;		+ LOG_DAY		 + &quot; integer not null, &quot;
&nbsp;		+ LOG_SENDTIME	 + &quot; integer not null, &quot;
&nbsp;		+ LOG_HOUR		 + &quot; integer not null, &quot;
&nbsp;		+ LOG_MINUTES	 + &quot; integer not null, &quot;
&nbsp;		+ LOG_GRIDREF    + &quot; text, &quot; 
&nbsp;		+ LOG_FB	     + &quot; text, &quot;
&nbsp;		+ LOG_CONDITION  + &quot; char(1) not null, &quot;
&nbsp;		+ LOG_SCORE      + &quot; integer not null, &quot;
&nbsp;		+ LOG_COMMENT    + &quot; text, &quot;
&nbsp;		+ LOG_FLAGADMINS + &quot; integer not null, &quot;
&nbsp;		+ LOG_FLAGUSERS  + &quot; integer not null&quot;
&nbsp;		+ &quot;);&quot;;
&nbsp;
&nbsp;	private static final String PHOTO_CREATE = &quot;create table &quot; + PHOTO_TABLE + &quot;(&quot; 
&nbsp;		+ PHOTO_ID 		 + &quot; integer primary key autoincrement, &quot;
&nbsp;		+ PHOTO_TRIG 	 + &quot; integer not null, &quot;
&nbsp;		+ PHOTO_ICON 	 + &quot; string not null, &quot;
&nbsp;		+ PHOTO_PHOTO 	 + &quot; string not null, &quot;
&nbsp;		+ PHOTO_NAME 	 + &quot; string not null, &quot;
&nbsp;		+ PHOTO_DESCR    + &quot; string not null, &quot;
&nbsp;		+ PHOTO_SUBJECT  + &quot; char(1) not null, &quot; 
&nbsp;		+ PHOTO_ISPUBLIC + &quot; integer not null, &quot;
&nbsp;		+ PHOTO_TUKLOGID + &quot; integer not null &quot;
&nbsp;		+ &quot;);&quot;;
&nbsp;
&nbsp;	private static final String MARK_CREATE = &quot;create table &quot; + MARK_TABLE + &quot;(&quot; 
&nbsp;			+ MARK_ID 		 + &quot; integer primary key&quot;
&nbsp;			+ &quot;);&quot;;
&nbsp;	
&nbsp;	private DatabaseHelper mDbHelper;
&nbsp;	public SQLiteDatabase mDb;
&nbsp;    private final SharedPreferences mPrefs;
&nbsp;    	
&nbsp;	private final Context mCtx;
&nbsp;
&nbsp;
&nbsp;	private static class DatabaseHelper extends SQLiteOpenHelper {
&nbsp;		Context mCtx;
&nbsp;		DatabaseHelper(Context context) {
<b class="nc">&nbsp;			super(context, DATABASE_NAME, null, DATABASE_VERSION);</b>
<b class="nc">&nbsp;			this.mCtx = context;</b>
&nbsp;		}
&nbsp;		@Override
&nbsp;		public void onCreate(SQLiteDatabase db) {
<b class="nc">&nbsp;			Log.i(TAG, &quot;Creating database&quot;);</b>
<b class="nc">&nbsp;			db.execSQL(TRIG_CREATE);</b>
<b class="nc">&nbsp;			db.execSQL(LOG_CREATE);</b>
<b class="nc">&nbsp;			db.execSQL(PHOTO_CREATE);</b>
<b class="nc">&nbsp;			db.execSQL(MARK_CREATE);</b>
&nbsp;		}
&nbsp;		@Override
&nbsp;		public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
<b class="nc">&nbsp;			if (oldVersion==11 &amp;&amp; newVersion==12) {</b>
<b class="nc">&nbsp;				Log.w(TAG, &quot;Upgrading from 11 to 12 - require a resync!&quot;);</b>
<b class="nc">&nbsp;				Toast.makeText(mCtx, &quot;Database updated - please sync logs&quot;, Toast.LENGTH_LONG).show();</b>
<b class="nc">&nbsp;				ContentValues args = new ContentValues();</b>
<b class="nc">&nbsp;				args.put(TRIG_LOGGED, Condition.TRIGNOTLOGGED.code());</b>
<b class="nc">&nbsp;				db.update(TRIG_TABLE, args, null, null);</b>
&nbsp;				return;
&nbsp;			}
<b class="nc">&nbsp;			Log.w(TAG, &quot;Upgrading database from version &quot; + oldVersion + &quot; to &quot;</b>
&nbsp;					+ newVersion + &quot;, which will destroy all old data&quot;);
<b class="nc">&nbsp;			db.execSQL(&quot;DROP TABLE IF EXISTS &quot; + TRIG_TABLE);</b>
<b class="nc">&nbsp;			db.execSQL(&quot;DROP TABLE IF EXISTS &quot; + LOG_TABLE);</b>
<b class="nc">&nbsp;			db.execSQL(&quot;DROP TABLE IF EXISTS &quot; + PHOTO_TABLE);</b>
<b class="nc">&nbsp;			db.execSQL(&quot;DROP TABLE IF EXISTS &quot; + MARK_TABLE);</b>
<b class="nc">&nbsp;			onCreate(db);</b>
&nbsp;		}
&nbsp;	}
&nbsp;	
&nbsp;    /**
&nbsp;     * Constructor - takes the context to allow the database to be
&nbsp;     * opened/created
&nbsp;     * 
&nbsp;     * @param ctx the Context within which to work
&nbsp;     */
<b class="nc">&nbsp;	public DbHelper(Context ctx) {</b>
<b class="nc">&nbsp;		this.mCtx = ctx;</b>
<b class="nc">&nbsp;		mPrefs = PreferenceManager.getDefaultSharedPreferences(mCtx);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Open the trigpointinguk database. If it cannot be opened, try to create a new
&nbsp;	 * instance of the database. If it cannot be created, throw an exception to
&nbsp;	 * signal the failure
&nbsp;	 * 
&nbsp;	 * @return this (self reference, allowing this to be chained in an initialisation call)
&nbsp;	 * @throws SQLException if the database could be neither opened or created
&nbsp;	 */
&nbsp;	public DbHelper open() throws SQLException {
<b class="nc">&nbsp;		Log.i(TAG, &quot;open: Opening database&quot;);</b>
<b class="nc">&nbsp;		mDbHelper = new DatabaseHelper(mCtx);</b>
<b class="nc">&nbsp;		mDb = mDbHelper.getWritableDatabase();</b>
<b class="nc">&nbsp;		Log.i(TAG, &quot;open: Database opened successfully&quot;);</b>
<b class="nc">&nbsp;		return this;</b>
&nbsp;	}
&nbsp;
&nbsp;	public void close() {
<b class="nc">&nbsp;		Log.i(TAG, &quot;close: Closing database&quot;);</b>
<b class="nc">&nbsp;		mDbHelper.close();</b>
<b class="nc">&nbsp;		Log.i(TAG, &quot;close: Database closed&quot;);</b>
&nbsp;	}
&nbsp;
&nbsp;
&nbsp;	/**
&nbsp;	 * Create a new trig using the data provided. If the trig is
&nbsp;	 * successfully created return the new rowId, otherwise return
&nbsp;	 * a -1 to indicate failure.
&nbsp;	 * 
&nbsp;	 * @param id
&nbsp;	 * @return rowId or -1 if failed
&nbsp;	 */
&nbsp;	public long createTrig(long id, String name, String waypoint, Double lat, Double lon, Trig.Physical type, Condition condition, Condition logged, Trig.Current current, Trig.Historic historic, String fb) {
<b class="nc">&nbsp;		ContentValues initialValues = new ContentValues();</b>
<b class="nc">&nbsp;		initialValues.put(TRIG_ID			, id);</b>
<b class="nc">&nbsp;		initialValues.put(TRIG_NAME			, name);</b>
<b class="nc">&nbsp;		initialValues.put(TRIG_WAYPOINT		, waypoint);</b>
<b class="nc">&nbsp;		initialValues.put(TRIG_LAT			, lat);</b>
<b class="nc">&nbsp;		initialValues.put(TRIG_LON			, lon);</b>
<b class="nc">&nbsp;		initialValues.put(TRIG_TYPE			, type.code());</b>
<b class="nc">&nbsp;		initialValues.put(TRIG_CONDITION	, condition.code());</b>
<b class="nc">&nbsp;		initialValues.put(TRIG_LOGGED		, logged.code());</b>
<b class="nc">&nbsp;		initialValues.put(TRIG_CURRENT		, current.code());</b>
<b class="nc">&nbsp;		initialValues.put(TRIG_HISTORIC		, historic.code());</b>
<b class="nc">&nbsp;		initialValues.put(TRIG_FB			, fb);</b>
<b class="nc">&nbsp;		return mDb.insert(TRIG_TABLE, null, initialValues);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Update Trig Log
&nbsp;	 * 
&nbsp;	 * @return true if updated, false otherwise
&nbsp;	 */
&nbsp;	public boolean updateTrigLog(long id, Condition logged) {
<b class="nc">&nbsp;		ContentValues args = new ContentValues();</b>
<b class="nc">&nbsp;		args.put(TRIG_LOGGED, logged.code());</b>
<b class="nc">&nbsp;		return mDb.update(TRIG_TABLE, args, TRIG_ID + &quot;=&quot; + id, null) &gt; 0;</b>
&nbsp;	}
&nbsp;
&nbsp;	public boolean deleteAllTrigLogs() {
<b class="nc">&nbsp;		ContentValues args = new ContentValues();</b>
<b class="nc">&nbsp;		args.put(TRIG_LOGGED, Condition.TRIGNOTLOGGED.code());</b>
<b class="nc">&nbsp;		return mDb.update(TRIG_TABLE, args, null, null) &gt; 0;</b>
&nbsp;	}
&nbsp;	
&nbsp;
&nbsp;	/**
&nbsp;	 * Delete all trigs
&nbsp;	 * 
&nbsp;	 * @return true if deleted, false otherwise
&nbsp;	 */
&nbsp;	public boolean deleteAll() {
<b class="nc">&nbsp;		return mDb.delete(TRIG_TABLE, null, null) &gt; 0;</b>
&nbsp;	}
&nbsp;
&nbsp;	public void clearUserLogs() {
<b class="nc">&nbsp;		Log.i(TAG, &quot;clearUserLogs: Clearing all user logs, photos, and marks&quot;);</b>
&nbsp;		try {
&nbsp;			// Delete all records from the log, photo, and mark tables
<b class="nc">&nbsp;			mDb.delete(LOG_TABLE, null, null);</b>
<b class="nc">&nbsp;			mDb.delete(PHOTO_TABLE, null, null);</b>
<b class="nc">&nbsp;			mDb.delete(MARK_TABLE, null, null);</b>
&nbsp;
&nbsp;			// Reset the &#39;logged&#39; status for all trigpoints
<b class="nc">&nbsp;			ContentValues args = new ContentValues();</b>
<b class="nc">&nbsp;			args.put(TRIG_LOGGED, Condition.TRIGNOTLOGGED.code());</b>
<b class="nc">&nbsp;			mDb.update(TRIG_TABLE, args, null, null);</b>
&nbsp;
<b class="nc">&nbsp;			Log.i(TAG, &quot;clearUserLogs: User data cleared successfully&quot;);</b>
&nbsp;		} catch (SQLException e) {
<b class="nc">&nbsp;			Log.e(TAG, &quot;clearUserLogs: Error clearing user data&quot;, e);</b>
&nbsp;		}
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * Return a Cursor suitable for the triglist screen
&nbsp;	 * 
&nbsp;	 * @return Cursor 
&nbsp;	 */
&nbsp;	public Cursor fetchTrigList(Location loc) {
&nbsp;		String strOrder;	
&nbsp;   
<b class="nc">&nbsp;		if (null != loc) {</b>
<b class="nc">&nbsp;			strOrder = String.format(&quot;(%s-%s)*(%s-%s) + %s * (%s-%s)*(%s-%s) LIMIT %s&quot;, </b>
<b class="nc">&nbsp;					loc.getLatitude(), </b>
&nbsp;					TRIG_LAT, 
<b class="nc">&nbsp;					loc.getLatitude(), </b>
&nbsp;					TRIG_LAT, 
<b class="nc">&nbsp;					Math.pow(Math.cos(Math.toRadians(loc.getLatitude())),2), </b>
<b class="nc">&nbsp;					loc.getLongitude(), </b>
&nbsp;					TRIG_LON, 
<b class="nc">&nbsp;					loc.getLongitude(), </b>
&nbsp;					TRIG_LON, 
<b class="nc">&nbsp;					mPrefs.getString(&quot;listentries&quot;, &quot;100&quot;));</b>
&nbsp;		} else {
<b class="nc">&nbsp;			strOrder = TRIG_NAME + &quot; LIMIT &quot; +  mPrefs.getString(&quot;listentries&quot;, &quot;100&quot;);</b>
&nbsp;		}
<b class="nc">&nbsp;		Log.i(TAG, strOrder);</b>
&nbsp;		
<b class="nc">&nbsp;		String strWhere = new Filter(mCtx).filterWhere(&quot;WHERE&quot;);</b>
<b class="nc">&nbsp;		Log.i(TAG, &quot;fetchTrigList: Filter where clause: &quot; + strWhere);</b>
&nbsp;		
&nbsp;		// Debug: Log the current filter settings
<b class="nc">&nbsp;		SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(mCtx);</b>
<b class="nc">&nbsp;		int filterType = prefs.getInt(Filter.FILTERTYPE, 0);</b>
<b class="nc">&nbsp;		int filterRadio = prefs.getInt(Filter.FILTERRADIO, 0);</b>
<b class="nc">&nbsp;		String filterRadioText = prefs.getString(Filter.FILTERRADIOTEXT, &quot;&quot;);</b>
<b class="nc">&nbsp;		Log.i(TAG, &quot;fetchTrigList: Filter settings - Type: &quot; + filterType + &quot;, Radio: &quot; + filterRadio + &quot;, RadioText: &#39;&quot; + filterRadioText + &quot;&#39;&quot;);</b>
&nbsp;		
<b class="nc">&nbsp;		final String qry = &quot;SELECT &quot;+</b>
&nbsp;				TRIG_TABLE +&quot;.&quot;+ TRIG_ID +&quot;, &quot;+
&nbsp;				TRIG_TABLE +&quot;.&quot;+ TRIG_NAME +&quot;, &quot;+
&nbsp;				TRIG_TABLE +&quot;.&quot;+ TRIG_LAT +&quot;, &quot;+
&nbsp;				TRIG_TABLE +&quot;.&quot;+ TRIG_LON +&quot;, &quot;+
&nbsp;				TRIG_TABLE +&quot;.&quot;+ TRIG_TYPE +&quot;, &quot;+
&nbsp;				TRIG_TABLE +&quot;.&quot;+ TRIG_CONDITION +&quot;, &quot;+
&nbsp;				TRIG_TABLE +&quot;.&quot;+ TRIG_LOGGED + &quot;, &quot;+
&nbsp;				LOG_TABLE  +&quot;.&quot;+ LOG_CONDITION + &quot; AS &quot; + JOIN_UNSYNCED + &quot;, &quot; +
&nbsp;				MARK_TABLE  +&quot;.&quot;+ MARK_ID + &quot; AS &quot; + JOIN_MARKED + &quot; &quot; +
&nbsp;				&quot;FROM &quot; + TRIG_TABLE + &quot; &quot;+
&nbsp;				&quot;LEFT OUTER JOIN &quot; + LOG_TABLE + &quot; &quot;+
&nbsp;				&quot;ON &quot; + TRIG_TABLE + &quot;.&quot; + TRIG_ID + &quot;=&quot; + LOG_TABLE + &quot;.&quot; + LOG_ID + &quot; &quot; +
&nbsp;				&quot;LEFT OUTER JOIN &quot; + MARK_TABLE + &quot; &quot;+
&nbsp;				&quot;ON &quot; + TRIG_TABLE + &quot;.&quot; + TRIG_ID + &quot;=&quot; + MARK_TABLE + &quot;.&quot; + MARK_ID + &quot; &quot; +
&nbsp;				strWhere + &quot; &quot; +
&nbsp;				&quot;ORDER BY &quot; + strOrder;
<b class="nc">&nbsp;		Log.i(TAG, qry);</b>
<b class="nc">&nbsp;		return mDb.rawQuery(qry, null);</b>
&nbsp;
&nbsp;	}
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	/**
&nbsp;	 * Return a Cursor suitable for the map screen
&nbsp;	 * 
&nbsp;	 * @return Cursor 
&nbsp;	 */
&nbsp;	public Cursor fetchTrigMapList (BoundingBox box) {
&nbsp;		// Calculate the center of the bounding box for distance-based sorting
<b class="nc">&nbsp;		double centerLat = (box.getLatNorth() + box.getLatSouth()) / 2.0;</b>
<b class="nc">&nbsp;		double centerLon = (box.getLonEast() + box.getLonWest()) / 2.0;</b>
&nbsp;		
&nbsp;		// Create distance-based ordering using approximate distance formula
&nbsp;		// (lat-centerLat)^2 + (lon-centerLon)^2 gives relative distance squared
<b class="nc">&nbsp;		String strOrder = String.format(&quot;((%s - %f) * (%s - %f) + (%s - %f) * (%s - %f)) limit %s&quot;, </b>
<b class="nc">&nbsp;				TRIG_LAT, centerLat, TRIG_LAT, centerLat,</b>
<b class="nc">&nbsp;				TRIG_LON, centerLon, TRIG_LON, centerLon,</b>
<b class="nc">&nbsp;				mPrefs.getString(&quot;mapcount&quot;, DEFAULT_MAP_COUNT));	</b>
&nbsp;   
<b class="nc">&nbsp;		String strWhere = String.format(&quot;WHERE %s between %s and %s  and  %s between %s and %s&quot;,</b>
&nbsp;				TRIG_LON, 
<b class="nc">&nbsp;				box.getLonWest(), </b>
<b class="nc">&nbsp;				box.getLonEast(), </b>
&nbsp;				TRIG_LAT, 
<b class="nc">&nbsp;				box.getLatSouth(), </b>
<b class="nc">&nbsp;				box.getLatNorth()); </b>
&nbsp;
<b class="nc">&nbsp;		strWhere += new Filter(mCtx).filterWhere(&quot;AND&quot;);</b>
<b class="nc">&nbsp;		Log.i(TAG, strWhere);</b>
<b class="nc">&nbsp;		Log.i(TAG, &quot;lat limit &quot; + mPrefs.getString(&quot;mapcount&quot;, DEFAULT_MAP_COUNT));</b>
&nbsp;		
<b class="nc">&nbsp;		final String qry = &quot;SELECT &quot;+</b>
&nbsp;				TRIG_TABLE +&quot;.&quot;+ TRIG_ID +&quot;, &quot;+
&nbsp;				TRIG_TABLE +&quot;.&quot;+ TRIG_NAME +&quot;, &quot;+
&nbsp;				TRIG_TABLE +&quot;.&quot;+ TRIG_LAT +&quot;, &quot;+
&nbsp;				TRIG_TABLE +&quot;.&quot;+ TRIG_LON +&quot;, &quot;+
&nbsp;				TRIG_TABLE +&quot;.&quot;+ TRIG_TYPE +&quot;, &quot;+
&nbsp;				TRIG_TABLE +&quot;.&quot;+ TRIG_CONDITION +&quot;, &quot;+
&nbsp;				TRIG_TABLE +&quot;.&quot;+ TRIG_LOGGED + &quot;, &quot;+
&nbsp;				LOG_TABLE  +&quot;.&quot;+ LOG_CONDITION + &quot; AS &quot; + JOIN_UNSYNCED + &quot;, &quot; +
&nbsp;				MARK_TABLE  +&quot;.&quot;+ MARK_ID + &quot; AS &quot; + JOIN_MARKED + &quot; &quot; +
&nbsp;				&quot;FROM &quot; + TRIG_TABLE + &quot; &quot;+
&nbsp;				&quot;LEFT OUTER JOIN &quot; + LOG_TABLE + &quot; &quot;+
&nbsp;				&quot;ON &quot; + TRIG_TABLE + &quot;.&quot; + TRIG_ID + &quot;=&quot; + LOG_TABLE + &quot;.&quot; + LOG_ID + &quot; &quot; +
&nbsp;				&quot;LEFT OUTER JOIN &quot; + MARK_TABLE + &quot; &quot;+
&nbsp;				&quot;ON &quot; + TRIG_TABLE + &quot;.&quot; + TRIG_ID + &quot;=&quot; + MARK_TABLE + &quot;.&quot; + MARK_ID + &quot; &quot; +
&nbsp;				strWhere + &quot; &quot; +
&nbsp;				&quot;ORDER BY &quot; + strOrder;
<b class="nc">&nbsp;		Log.i(TAG, qry);</b>
<b class="nc">&nbsp;		return mDb.rawQuery(qry, null);</b>
&nbsp;		
&nbsp;		
&nbsp;/*		return mDb.query(TRIG_TABLE, new String[] {
&nbsp;				TRIG_ID, 
&nbsp;				TRIG_NAME, 
&nbsp;				TRIG_LAT, 
&nbsp;				TRIG_LON, 
&nbsp;				TRIG_TYPE, 
&nbsp;				TRIG_CONDITION, 
&nbsp;				TRIG_LOGGED}, 
&nbsp;				strWhere, null, null, null, strOrder);
&nbsp;*/	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * Return a Cursor suitable for the triglist screen
&nbsp;	 * 
&nbsp;	 * @return Cursor 
&nbsp;	 */
&nbsp;	public Cursor fetchTrigInfo (long id) {
<b class="nc">&nbsp;		return mDb.query(TRIG_TABLE, new String[] {</b>
&nbsp;				TRIG_ID, 
&nbsp;				TRIG_NAME, 
&nbsp;				TRIG_LAT, 
&nbsp;				TRIG_LON, 
&nbsp;				TRIG_TYPE, 
&nbsp;				TRIG_CONDITION, 
&nbsp;				TRIG_LOGGED, 
&nbsp;				TRIG_CURRENT, 
&nbsp;				TRIG_HISTORIC, 
&nbsp;				TRIG_FB}, 
&nbsp;				TRIG_ID + &quot;=&quot;+id, 
&nbsp;				null, null, null, null);
&nbsp;	}
&nbsp;	
&nbsp;	/**
&nbsp;	 * Returns whether the trig table contains data
&nbsp;	 * 
&nbsp;	 * @return Boolean 
&nbsp;	 */
&nbsp;	public Boolean isTrigTablePopulated () {
<b class="nc">&nbsp;		Log.i(TAG, &quot;isTrigTablePopulated: Checking if trig table is populated&quot;);</b>
&nbsp;		try {
<b class="nc">&nbsp;			Cursor cursor = mDb.rawQuery(&quot;SELECT COUNT(*) FROM &quot; + TRIG_TABLE, null);</b>
<b class="nc">&nbsp;			if (cursor.moveToFirst()) {</b>
<b class="nc">&nbsp;				int count = cursor.getInt(0);</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;isTrigTablePopulated: Table has &quot; + count + &quot; records&quot;);</b>
&nbsp;				cursor.close();
<b class="nc">&nbsp;				return count &gt; 0;</b>
&nbsp;			}
&nbsp;			cursor.close();
<b class="nc">&nbsp;			Log.i(TAG, &quot;isTrigTablePopulated: No results found&quot;);</b>
<b class="nc">&nbsp;			return false;</b>
&nbsp;		} catch (Exception e) {
<b class="nc">&nbsp;			Log.e(TAG, &quot;isTrigTablePopulated: Exception occurred&quot;, e);</b>
<b class="nc">&nbsp;			e.printStackTrace();</b>
<b class="nc">&nbsp;			return false;</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Returns number of logged pillars
&nbsp;	 * 
&nbsp;	 * @return int
&nbsp;	 */
&nbsp;	public int countLoggedPillars () {
<b class="nc">&nbsp;		Log.i(TAG, &quot;countLoggedPillars: Starting count&quot;);</b>
<b class="nc">&nbsp;        try (Cursor c = mDb.query(TRIG_TABLE, new String[]{TRIG_ID},</b>
<b class="nc">&nbsp;                TRIG_TYPE + &quot;=&#39;&quot; + Trig.Physical.PILLAR.code() + &quot;&#39; and &quot; + TRIG_LOGGED + &quot;!= &#39;&quot; + Condition.TRIGNOTLOGGED.code() + &quot;&#39;&quot;,</b>
&nbsp;                null, null, null, null)) {
<b class="nc">&nbsp;            int count = c.getCount();</b>
<b class="nc">&nbsp;            Log.i(TAG, &quot;countLoggedPillars: Count = &quot; + count);</b>
<b class="nc">&nbsp;            return count;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            Log.e(TAG, &quot;countLoggedPillars: Exception occurred&quot;, e);</b>
<b class="nc">&nbsp;            e.printStackTrace();</b>
<b class="nc">&nbsp;            return 0;</b>
&nbsp;        }
&nbsp;	}
&nbsp;	/**
&nbsp;	 * Returns number of logged FBMs
&nbsp;	 * 
&nbsp;	 * @return int
&nbsp;	 */
&nbsp;	public int countLoggedFbms () {
<b class="nc">&nbsp;		Log.i(TAG, &quot;countLoggedFbms&quot;);</b>
<b class="nc">&nbsp;        try (Cursor c = mDb.query(TRIG_TABLE, new String[]{TRIG_ID},</b>
<b class="nc">&nbsp;                TRIG_TYPE + &quot;=&#39;&quot; + Trig.Physical.FBM.code() + &quot;&#39; and &quot; + TRIG_LOGGED + &quot;!= &#39;&quot; + Condition.TRIGNOTLOGGED.code() + &quot;&#39;&quot;,</b>
&nbsp;                null, null, null, null)) {
<b class="nc">&nbsp;            return c.getCount();</b>
&nbsp;        }
&nbsp;	}
&nbsp;	/**
&nbsp;	 * Returns number of logged Intersecteds
&nbsp;	 * 
&nbsp;	 * @return int
&nbsp;	 */
&nbsp;	public int countLoggedIntersecteds () {
<b class="nc">&nbsp;		Log.i(TAG, &quot;countLoggedIntersecteds&quot;);</b>
<b class="nc">&nbsp;        try (Cursor c = mDb.query(TRIG_TABLE, new String[]{TRIG_ID},</b>
<b class="nc">&nbsp;                TRIG_TYPE + &quot;=&#39;&quot; + Trig.Physical.INTERSECTED.code() + &quot;&#39; and &quot; + TRIG_LOGGED + &quot;!= &#39;&quot; + Condition.TRIGNOTLOGGED.code() + &quot;&#39;&quot;,</b>
&nbsp;                null, null, null, null)) {
<b class="nc">&nbsp;            return c.getCount();</b>
&nbsp;        }
&nbsp;	}
&nbsp;	/**
&nbsp;	 * Returns number of logged Passives
&nbsp;	 * 
&nbsp;	 * @return int
&nbsp;	 */
&nbsp;	public int countLoggedPassives () {
<b class="nc">&nbsp;		Log.i(TAG, &quot;countLoggedPassives&quot;);</b>
<b class="nc">&nbsp;        try (Cursor c = mDb.query(TRIG_TABLE, new String[]{TRIG_ID},</b>
<b class="nc">&nbsp;                TRIG_TYPE + &quot; NOT IN (&#39;&quot; + Trig.Physical.PILLAR.code() + &quot;&#39;,&#39;&quot; +</b>
<b class="nc">&nbsp;                        Trig.Physical.INTERSECTED.code() + &quot;&#39;,&#39;&quot; + Trig.Physical.FBM.code() + &quot;&#39;) &quot; +</b>
<b class="nc">&nbsp;                        &quot;and &quot; + TRIG_LOGGED + &quot;!= &#39;&quot; + Condition.TRIGNOTLOGGED.code() + &quot;&#39;&quot;,</b>
&nbsp;                null, null, null, null)) {
<b class="nc">&nbsp;            return c.getCount();</b>
&nbsp;        }
&nbsp;	}
&nbsp;	/**
&nbsp;	 * Returns number of unsynced logs
&nbsp;	 * 
&nbsp;	 * @return int
&nbsp;	 */
&nbsp;	public int countUnsynced () {
<b class="nc">&nbsp;		Log.i(TAG, &quot;countUnsynced&quot;);</b>
<b class="nc">&nbsp;        try (Cursor c = mDb.query(LOG_TABLE, new String[]{LOG_ID},</b>
&nbsp;                null,
&nbsp;                null, null, null, null)) {
<b class="nc">&nbsp;            return c.getCount();</b>
&nbsp;        }
&nbsp;	}
&nbsp;	/**
&nbsp;	 * Returns number of unsynced photos
&nbsp;	 * 
&nbsp;	 * @return int
&nbsp;	 */
&nbsp;	public int countPhotos () {
<b class="nc">&nbsp;		Log.i(TAG, &quot;countPhotos&quot;);</b>
<b class="nc">&nbsp;        try (Cursor c = mDb.query(PHOTO_TABLE, new String[]{PHOTO_ID},</b>
&nbsp;                null,
&nbsp;                null, null, null, null)) {
<b class="nc">&nbsp;            return c.getCount();</b>
&nbsp;        }
&nbsp;	}
&nbsp;	
&nbsp;	
&nbsp;	/**
&nbsp;	 * Create a new log.  If the record is
&nbsp;	 * successfully created return the new rowId, otherwise return
&nbsp;	 * a -1 to indicate failure.
&nbsp;	 * 
&nbsp;	 * @param id Log id
&nbsp;	 * @return rowId or -1 if failed
&nbsp;	 */
&nbsp;	public long createLog(long id, int year, int month, int day, int sendtime, int hour, int minutes, String gridref, String fb, 
&nbsp;						Condition condition, int score, String comment, int flagadmins, int flagusers) {
<b class="nc">&nbsp;		Log.i(TAG, &quot;createLog - &quot; + id);</b>
&nbsp;		
<b class="nc">&nbsp;		ContentValues initialValues = new ContentValues();</b>
<b class="nc">&nbsp;		initialValues.put(LOG_ID			, id);</b>
<b class="nc">&nbsp;		initialValues.put(LOG_YEAR			, year);</b>
<b class="nc">&nbsp;		initialValues.put(LOG_MONTH			, month);</b>
<b class="nc">&nbsp;		initialValues.put(LOG_DAY			, day);</b>
<b class="nc">&nbsp;		initialValues.put(LOG_SENDTIME		, sendtime);</b>
<b class="nc">&nbsp;		initialValues.put(LOG_HOUR			, hour);</b>
<b class="nc">&nbsp;		initialValues.put(LOG_MINUTES		, minutes);</b>
<b class="nc">&nbsp;		initialValues.put(LOG_GRIDREF		, gridref);</b>
<b class="nc">&nbsp;		initialValues.put(LOG_FB			, fb);</b>
<b class="nc">&nbsp;		initialValues.put(LOG_CONDITION		, condition.code());</b>
<b class="nc">&nbsp;		initialValues.put(LOG_SCORE			, score);</b>
<b class="nc">&nbsp;		initialValues.put(LOG_COMMENT		, comment);</b>
<b class="nc">&nbsp;		initialValues.put(LOG_FLAGADMINS	, flagadmins);</b>
<b class="nc">&nbsp;		initialValues.put(LOG_FLAGUSERS		, flagusers);</b>
<b class="nc">&nbsp;		return mDb.insert(LOG_TABLE, null, initialValues);</b>
&nbsp;	}
&nbsp;
&nbsp;	
&nbsp;	
&nbsp;
&nbsp;	/**
&nbsp;	 * Delete individual log
&nbsp;	 * 
&nbsp;	 * @return true if deleted, false otherwise
&nbsp;	 */
&nbsp;	public boolean deleteLog(long id) {
<b class="nc">&nbsp;		return mDb.delete(LOG_TABLE, LOG_ID + &quot;=&quot; + id, null) &gt; 0;</b>
&nbsp;	}
&nbsp;
&nbsp;
&nbsp;	/**
&nbsp;     * Return a Cursor positioned at the log that matches the given id
&nbsp;     * 
&nbsp;     * @param id of log to retrieve
&nbsp;     * @return Cursor positioned to matching log, if found
&nbsp;     * @throws SQLException if note could not be found/retrieved
&nbsp;     */
&nbsp;    public Cursor fetchLog(long id) throws SQLException {
&nbsp;
<b class="nc">&nbsp;        Cursor mCursor =</b>
<b class="nc">&nbsp;            mDb.query(true, LOG_TABLE, new String[] {</b>
&nbsp;            		LOG_ID, 
&nbsp;            		LOG_YEAR, 
&nbsp;            		LOG_MONTH, 
&nbsp;            		LOG_DAY, 
&nbsp;            		LOG_SENDTIME, 
&nbsp;            		LOG_HOUR, 
&nbsp;            		LOG_MINUTES, 
&nbsp;            		LOG_GRIDREF, 
&nbsp;            		LOG_FB, 
&nbsp;            		LOG_CONDITION, 
&nbsp;            		LOG_COMMENT, 
&nbsp;            		LOG_SCORE, 
&nbsp;            		LOG_COMMENT, 
&nbsp;            		LOG_FLAGADMINS, 
&nbsp;            		LOG_FLAGUSERS},
&nbsp;                    LOG_ID + &quot;=&quot; + id, null,
&nbsp;                    null, null, null, null);
<b class="nc">&nbsp;        if (mCursor != null) {</b>
<b class="nc">&nbsp;            if (! mCursor.moveToFirst()) {</b>
&nbsp;            	// No log row found
<b class="nc">&nbsp;            	return null;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return mCursor;</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;
&nbsp;	/**
&nbsp;     * Return a Cursor positioned at the log that matches the given id
&nbsp;     * 
&nbsp;     * @param trigId of log to retrieve
&nbsp;     * @return Cursor positioned to matching log, if found
&nbsp;     * @throws SQLException if note could not be found/retrieved
&nbsp;     */
&nbsp;    public Cursor fetchLogs(Long trigId) throws SQLException {
&nbsp;
<b class="nc">&nbsp;    	String condition = null;</b>
<b class="nc">&nbsp;    	if (trigId != null) {</b>
&nbsp;    		// only a single trig
<b class="nc">&nbsp;    		condition = LOG_ID + &quot;=&quot; + trigId;</b>
&nbsp;    	}
<b class="nc">&nbsp;        Cursor mCursor =</b>
<b class="nc">&nbsp;            mDb.query(true, LOG_TABLE, new String[] {</b>
&nbsp;            		LOG_ID, 
&nbsp;            		LOG_YEAR, 
&nbsp;            		LOG_MONTH, 
&nbsp;            		LOG_DAY, 
&nbsp;            		LOG_SENDTIME,
&nbsp;            		LOG_HOUR, 
&nbsp;            		LOG_MINUTES, 
&nbsp;            		LOG_GRIDREF, 
&nbsp;            		LOG_FB, 
&nbsp;            		LOG_CONDITION, 
&nbsp;            		LOG_COMMENT, 
&nbsp;            		LOG_SCORE, 
&nbsp;            		LOG_COMMENT, 
&nbsp;            		LOG_FLAGADMINS, 
&nbsp;            		LOG_FLAGUSERS}
&nbsp;                    , condition, null, null, null, null, null);
<b class="nc">&nbsp;        if (mCursor != null) {</b>
<b class="nc">&nbsp;            if (! mCursor.moveToFirst()) {</b>
&nbsp;            	// No log row found
<b class="nc">&nbsp;            	return null;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return mCursor;</b>
&nbsp;    }
&nbsp;
&nbsp;    
&nbsp;
&nbsp;	
&nbsp;	/**
&nbsp;	 * Create a new photo.  If the record is
&nbsp;	 * successfully created return the new rowId, otherwise return
&nbsp;	 * a -1 to indicate failure.
&nbsp;	 * 
&nbsp;	 * @param trigId
&nbsp;	 * @param name 
&nbsp;	 * @param descr 
&nbsp;	 * @param icon 
&nbsp;	 * @param photo 
&nbsp;	 * @param subject 
&nbsp;	 * @param ispublic 
&nbsp;	 * @return rowId or -1 if failed
&nbsp;	 */
&nbsp;	public long createPhoto(long trigId, String name, String descr, String icon, String photo, PhotoSubject subject, int ispublic) {
<b class="nc">&nbsp;		Log.i(TAG, &quot;createPhoto&quot;);</b>
&nbsp;		
<b class="nc">&nbsp;		ContentValues initialValues = new ContentValues();</b>
<b class="nc">&nbsp;		initialValues.put(PHOTO_TRIG		, trigId);</b>
<b class="nc">&nbsp;		initialValues.put(PHOTO_NAME		, name);</b>
<b class="nc">&nbsp;		initialValues.put(PHOTO_DESCR		, descr);</b>
<b class="nc">&nbsp;		initialValues.put(PHOTO_ICON		, icon);</b>
<b class="nc">&nbsp;		initialValues.put(PHOTO_PHOTO		, photo);</b>
<b class="nc">&nbsp;		initialValues.put(PHOTO_SUBJECT		, subject.code());</b>
<b class="nc">&nbsp;		initialValues.put(PHOTO_ISPUBLIC	, ispublic);</b>
<b class="nc">&nbsp;		initialValues.put(PHOTO_TUKLOGID    , 0);</b>
<b class="nc">&nbsp;		return mDb.insert(PHOTO_TABLE, null, initialValues);</b>
&nbsp;	}
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;	 * Update a photo.  If the record is
&nbsp;	 * successfully updated return the new rowId, otherwise return
&nbsp;	 * a -1 to indicate failure.
&nbsp;	 * 
&nbsp;	 * @param photoId
&nbsp;	 * @param trigId
&nbsp;	 * @param name
&nbsp;	 * @param descr
&nbsp;	 * @param icon 
&nbsp;	 * @param photo 
&nbsp;	 * @param subject 
&nbsp;	 * @param ispublic 
&nbsp;	 * @return rowId or -1 if failed
&nbsp;	 */
&nbsp;	public long updatePhoto(long photoId, long trigId, String name, String descr, String icon, String photo, PhotoSubject subject, int ispublic) {
<b class="nc">&nbsp;		Log.i(TAG, &quot;updatePhoto&quot;);</b>
&nbsp;		
<b class="nc">&nbsp;		ContentValues newValues = new ContentValues();</b>
<b class="nc">&nbsp;		newValues.put(PHOTO_TRIG		, trigId);</b>
<b class="nc">&nbsp;		newValues.put(PHOTO_NAME		, name);</b>
<b class="nc">&nbsp;		newValues.put(PHOTO_DESCR		, descr);</b>
<b class="nc">&nbsp;		newValues.put(PHOTO_ICON		, icon);</b>
<b class="nc">&nbsp;		newValues.put(PHOTO_PHOTO		, photo);</b>
<b class="nc">&nbsp;		newValues.put(PHOTO_SUBJECT		, subject.code());</b>
<b class="nc">&nbsp;		newValues.put(PHOTO_ISPUBLIC	, ispublic);</b>
<b class="nc">&nbsp;		newValues.put(PHOTO_TUKLOGID    , 0);</b>
<b class="nc">&nbsp;		return mDb.update(PHOTO_TABLE, newValues, PHOTO_ID + &quot;=&quot; + photoId, null);</b>
&nbsp;	}
&nbsp;
&nbsp;	
&nbsp;	/**
&nbsp;	 * Update all photos for a trig with the T:UK log number.  If the records are
&nbsp;	 * successfully updated return the number of rows updated, otherwise return
&nbsp;	 * a -1 to indicate failure.
&nbsp;	 * 
&nbsp;	 * @param trigId
&nbsp;	 * @param tukLogId
&nbsp;	 * @return rowId or -1 if failed
&nbsp;	 */
&nbsp;	public long updatePhotos(long trigId, long tukLogId) {
<b class="nc">&nbsp;		Log.i(TAG, &quot;updatePhotos&quot;);</b>
<b class="nc">&nbsp;		ContentValues newValues = new ContentValues();</b>
<b class="nc">&nbsp;		newValues.put(PHOTO_TUKLOGID	, tukLogId);</b>
&nbsp;		
<b class="nc">&nbsp;		return mDb.update(PHOTO_TABLE, newValues, PHOTO_TRIG + &quot;= ?&quot;, new String[]{String.valueOf(trigId)});</b>
&nbsp;	}
&nbsp;
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;
&nbsp;	/**
&nbsp;	 * Delete individual photo
&nbsp;	 * 
&nbsp;	 * @return true if deleted, false otherwise
&nbsp;	 */
&nbsp;	public boolean deletePhoto(long id) {
<b class="nc">&nbsp;		return mDb.delete(PHOTO_TABLE, PHOTO_ID + &quot;=&quot; + id, null) &gt; 0;</b>
&nbsp;	}
&nbsp;
&nbsp;
&nbsp;
&nbsp;	/**
&nbsp;	 * Delete all photo records for trigpoint
&nbsp;	 * 
&nbsp;	 * @return true if deleted, false otherwise
&nbsp;	 */
&nbsp;	public boolean deletePhotosForTrig(long trigId) {
<b class="nc">&nbsp;		return mDb.delete(PHOTO_TABLE, PHOTO_TRIG + &quot;=&quot; + trigId, null) &gt; 0;</b>
&nbsp;	}
&nbsp;
&nbsp;
&nbsp;	
&nbsp;	/**
&nbsp;     * Return a Cursor positioned at the photo that matches the given id
&nbsp;     * 
&nbsp;     * @param photo_id of photo to retrieve
&nbsp;     * @return Cursor positioned to matching photo, if found
&nbsp;     * @throws SQLException if photo could not be found/retrieved
&nbsp;     */
&nbsp;    public Cursor fetchPhoto(long photo_id) throws SQLException {
&nbsp;
<b class="nc">&nbsp;        Cursor mCursor =</b>
<b class="nc">&nbsp;            mDb.query(true, </b>
&nbsp;            		PHOTO_TABLE, 
&nbsp;            		new String[] {	PHOTO_ID, 
&nbsp;            						PHOTO_TRIG, 
&nbsp;            						PHOTO_ICON,
&nbsp;            						PHOTO_PHOTO,
&nbsp;            						PHOTO_NAME, 
&nbsp;            						PHOTO_DESCR, 
&nbsp;            						PHOTO_SUBJECT,
&nbsp;            						PHOTO_ISPUBLIC}
&nbsp;                    , PHOTO_ID + &quot;=&quot; + photo_id, null,
&nbsp;                    null, null, null, null);
&nbsp;        
<b class="nc">&nbsp;        if (mCursor != null) {</b>
<b class="nc">&nbsp;            if (! mCursor.moveToFirst()) {</b>
&nbsp;            	// No photo row found
<b class="nc">&nbsp;            	return null;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return mCursor;</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;	/**
&nbsp;     * Return a Cursor positioned at the first photo for the given trigpoint
&nbsp;     * (or all trigpoints, if null)
&nbsp;     * 
&nbsp;     * @param trig_id of trigpoint to retrieve
&nbsp;     * @return Cursor positioned to matching photo, if found
&nbsp;     * @throws SQLException if photo could not be found/retrieved
&nbsp;     */
&nbsp;    public Cursor fetchPhotos(Long trig_id) throws SQLException {
&nbsp;
<b class="nc">&nbsp;    	String condition = null;</b>
<b class="nc">&nbsp;    	if (trig_id != null) {</b>
&nbsp;    		// only a single trig
<b class="nc">&nbsp;    		condition = PHOTO_TRIG + &quot;=&quot; + trig_id;</b>
&nbsp;    	}
&nbsp;    	
<b class="nc">&nbsp;        Cursor mCursor =</b>
<b class="nc">&nbsp;            mDb.query(true, </b>
&nbsp;            		PHOTO_TABLE, 
&nbsp;            		new String[] {	PHOTO_ID, 
&nbsp;            						PHOTO_TRIG, 
&nbsp;            						PHOTO_ICON,
&nbsp;            						PHOTO_PHOTO,
&nbsp;            						PHOTO_NAME, 
&nbsp;            						PHOTO_DESCR, 
&nbsp;            						PHOTO_SUBJECT,
&nbsp;            						PHOTO_ISPUBLIC,
&nbsp;            						PHOTO_TUKLOGID}
&nbsp;                    , condition, null,
&nbsp;                    null, null, null, null);
&nbsp;        
<b class="nc">&nbsp;        if (mCursor != null) {</b>
<b class="nc">&nbsp;            if (! mCursor.moveToFirst()) {</b>
&nbsp;            	// No photo row found
<b class="nc">&nbsp;            	return null;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return mCursor;</b>
&nbsp;    }
&nbsp;
&nbsp;	
&nbsp;    public Boolean setMarkedTrig(long trig_id, Boolean mark) {
<b class="nc">&nbsp;		Log.i(TAG, &quot;setMarkedTrig - &quot; + trig_id + &quot; - &quot; + mark);</b>
&nbsp;		
<b class="nc">&nbsp;		if (mark) {</b>
<b class="nc">&nbsp;			ContentValues initialValues = new ContentValues();</b>
<b class="nc">&nbsp;			initialValues.put(MARK_ID			, trig_id);</b>
<b class="nc">&nbsp;			mDb.insert(MARK_TABLE, null, initialValues);</b>
<b class="nc">&nbsp;			return true;</b>
&nbsp;		} else {
<b class="nc">&nbsp;			mDb.delete(MARK_TABLE, MARK_ID + &quot;=&quot; + trig_id, null);</b>
<b class="nc">&nbsp;			return false;</b>
&nbsp;		}
&nbsp;    }
&nbsp;    public Boolean isMarkedTrig(long trig_id) {
<b class="nc">&nbsp;		Log.i(TAG, &quot;isMarkedTrig - &quot; + trig_id);</b>
&nbsp;		
<b class="nc">&nbsp;		Cursor c = null;</b>
&nbsp;		try {
<b class="nc">&nbsp;			c =  mDb.query(MARK_TABLE, new String[] {MARK_ID}, MARK_ID + &quot;=&quot; + trig_id, null, null, null, null);</b>
<b class="nc">&nbsp;            return c.getCount() != 0;</b>
&nbsp;        } finally {
<b class="nc">&nbsp;			if (c != null) {</b>
&nbsp;				c.close();
&nbsp;			}
&nbsp;		}
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Delete the entire database file
&nbsp;     */
&nbsp;    public void deleteDatabase() {
<b class="nc">&nbsp;        Log.i(TAG, &quot;deleteDatabase: Deleting database file&quot;);</b>
&nbsp;        try {
<b class="nc">&nbsp;            if (mDb != null &amp;&amp; mDb.isOpen()) {</b>
<b class="nc">&nbsp;                mDb.close();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (mDbHelper != null) {</b>
<b class="nc">&nbsp;                mDbHelper.close();</b>
&nbsp;            }
<b class="nc">&nbsp;            boolean deleted = mCtx.deleteDatabase(DATABASE_NAME);</b>
<b class="nc">&nbsp;            Log.i(TAG, &quot;deleteDatabase: Database deletion result: &quot; + deleted);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            Log.e(TAG, &quot;deleteDatabase: Error deleting database&quot;, e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-08-25 13:52</div>
</div>
</body>
</html>
