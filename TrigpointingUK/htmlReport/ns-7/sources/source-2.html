


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DownloadMapsActivity</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">uk.trigpointing.android.mapping</a>
</div>

<h1>Coverage Summary for Class: DownloadMapsActivity (uk.trigpointing.android.mapping)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DownloadMapsActivity</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/46)
  </span>
</td>
</tr>
  <tr>
    <td class="name">DownloadMapsActivity$Companion</td>
  </tr>
  <tr>
    <td class="name">DownloadMapsActivity$downloadAndExtract$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/35)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DownloadMapsActivity$downloadAndExtract$1$1$countingInputStream$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DownloadMapsActivity$downloadAndExtract$1$1$countingInputStream$1$read$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DownloadMapsActivity$downloadAndExtract$1$1$countingInputStream$1$read$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DownloadMapsActivity$downloadAndExtract$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DownloadMapsActivity$fetchMapDownloads$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DownloadMapsActivity$fetchMapDownloads$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DownloadMapsActivity$MapDownloadAdapter</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DownloadMapsActivity$MapDownloadAdapter$ViewHolder</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/27)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DownloadMapsActivity$setupCacheUsage$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DownloadMapsActivity$setupCacheUsage$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">DownloadMapsActivity$showError$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/31)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/62)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/167)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package uk.trigpointing.android.mapping
&nbsp;
&nbsp;import android.content.Intent
&nbsp;import android.net.Uri
&nbsp;import android.os.Bundle
&nbsp;import android.provider.Settings
&nbsp;import android.util.Log
&nbsp;import android.view.LayoutInflater
&nbsp;import android.view.View
&nbsp;import android.view.ViewGroup
&nbsp;import android.widget.Button
&nbsp;import android.widget.ProgressBar
&nbsp;import android.widget.TextView
&nbsp;import android.widget.Toast
&nbsp;import androidx.appcompat.app.AppCompatActivity
&nbsp;import androidx.lifecycle.lifecycleScope
&nbsp;import androidx.recyclerview.widget.LinearLayoutManager
&nbsp;import androidx.recyclerview.widget.RecyclerView
&nbsp;import com.fasterxml.jackson.databind.ObjectMapper
&nbsp;import com.fasterxml.jackson.dataformat.yaml.YAMLFactory
&nbsp;import kotlinx.coroutines.Dispatchers
&nbsp;import kotlinx.coroutines.launch
&nbsp;import kotlinx.coroutines.withContext
&nbsp;import okhttp3.OkHttpClient
&nbsp;import okhttp3.Request
&nbsp;import org.apache.commons.compress.archivers.tar.TarArchiveInputStream
&nbsp;import uk.trigpointing.android.R
&nbsp;import uk.trigpointing.android.common.BaseActivity
&nbsp;import java.io.BufferedInputStream
&nbsp;import java.io.File
&nbsp;import java.io.FileOutputStream
&nbsp;import java.io.InputStream
&nbsp;import java.text.DecimalFormat
&nbsp;
<b class="nc">&nbsp;class DownloadMapsActivity : BaseActivity() {</b>
&nbsp;
&nbsp;    private lateinit var recyclerView: RecyclerView
&nbsp;    private lateinit var progressBar: ProgressBar
&nbsp;    private lateinit var adapter: MapDownloadAdapter
&nbsp;    private lateinit var cacheUsageText: TextView
&nbsp;    private lateinit var clearCacheLink: TextView
&nbsp;    private lateinit var tileCacheDir: File
&nbsp;
&nbsp;    override fun onCreate(savedInstanceState: Bundle?) {
<b class="nc">&nbsp;        super.onCreate(savedInstanceState)</b>
<b class="nc">&nbsp;        setContentView(R.layout.activity_download_maps)</b>
<b class="nc">&nbsp;        supportActionBar?.setDisplayHomeAsUpEnabled(true)</b>
&nbsp;
&nbsp;        // Initialize tile cache directory
<b class="nc">&nbsp;        tileCacheDir = File(cacheDir, &quot;map_tiles&quot;)</b>
<b class="nc">&nbsp;        if (!tileCacheDir.exists()) {</b>
<b class="nc">&nbsp;            tileCacheDir.mkdirs()</b>
&nbsp;        }
&nbsp;
&nbsp;        // Initialize UI components
<b class="nc">&nbsp;        recyclerView = findViewById(R.id.recyclerView)</b>
<b class="nc">&nbsp;        progressBar = findViewById(R.id.progressBar)</b>
<b class="nc">&nbsp;        cacheUsageText = findViewById(R.id.cacheUsageText)</b>
<b class="nc">&nbsp;        clearCacheLink = findViewById(R.id.clearCacheLink)</b>
&nbsp;        
<b class="nc">&nbsp;        recyclerView.layoutManager = LinearLayoutManager(this)</b>
&nbsp;
&nbsp;        // Set up cache usage display and clear link
<b class="nc">&nbsp;        setupCacheUsage()</b>
&nbsp;        
<b class="nc">&nbsp;        fetchMapDownloads()</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun fetchMapDownloads() {
<b class="nc">&nbsp;        progressBar.visibility = View.VISIBLE</b>
<b class="nc">&nbsp;        lifecycleScope.launch(Dispatchers.IO) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                val client = OkHttpClient()</b>
<b class="nc">&nbsp;                val request = Request.Builder().url(YAML_URL).build()</b>
<b class="nc">&nbsp;                val response = client.newCall(request).execute()</b>
&nbsp;
<b class="nc">&nbsp;                if (response.isSuccessful) {</b>
<b class="nc">&nbsp;                    val yamlString = response.body?.string()</b>
<b class="nc">&nbsp;                    val mapper = ObjectMapper(YAMLFactory())</b>
<b class="nc">&nbsp;                    val list = mapper.readValue(yamlString, MapDownload.MapDownloadsList::class.java)</b>
<b class="nc">&nbsp;                    withContext(Dispatchers.Main) {</b>
<b class="nc">&nbsp;                        progressBar.visibility = View.GONE</b>
<b class="nc">&nbsp;                        adapter = MapDownloadAdapter(list.maps) { mapDownload -&gt;</b>
<b class="nc">&nbsp;                            downloadAndExtract(mapDownload)</b>
&nbsp;                        }
<b class="nc">&nbsp;                        recyclerView.adapter = adapter</b>
&nbsp;                    }
&nbsp;                } else {
<b class="nc">&nbsp;                    showError(&quot;Failed to load map list&quot;)</b>
&nbsp;                }
&nbsp;            } catch (e: Exception) {
<b class="nc">&nbsp;                Log.e(TAG, &quot;Failed to fetch YAML&quot;, e)</b>
<b class="nc">&nbsp;                showError(&quot;Failed to load map list&quot;)</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun downloadAndExtract(mapDownload: MapDownload) {
<b class="nc">&nbsp;        lifecycleScope.launch(Dispatchers.IO) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                val client = OkHttpClient()</b>
<b class="nc">&nbsp;                val request = Request.Builder().url(mapDownload.fileUrl).build()</b>
<b class="nc">&nbsp;                val response = client.newCall(request).execute()</b>
<b class="nc">&nbsp;                val body = response.body</b>
&nbsp;
<b class="nc">&nbsp;                if (response.isSuccessful &amp;&amp; body != null) {</b>
<b class="nc">&nbsp;                    val totalSize = body.contentLength()</b>
<b class="nc">&nbsp;                    var downloadedBytes = 0L</b>
<b class="nc">&nbsp;                    var extractedFileCount = 0</b>
&nbsp;                    
<b class="nc">&nbsp;                    Log.d(TAG, &quot;Starting download of ${mapDownload.name}, total size: $totalSize bytes&quot;)</b>
&nbsp;
<b class="nc">&nbsp;                    body.byteStream().use { inputStream -&gt;</b>
&nbsp;                        // Create a counting input stream to track actual bytes read
<b class="nc">&nbsp;                        val countingInputStream = object : InputStream() {</b>
&nbsp;                            override fun read(): Int {
<b class="nc">&nbsp;                                val byte = inputStream.read()</b>
<b class="nc">&nbsp;                                if (byte != -1) {</b>
<b class="nc">&nbsp;                                    downloadedBytes++</b>
&nbsp;                                    // Update progress every 64KB to avoid too many UI updates
<b class="nc">&nbsp;                                    if (downloadedBytes % 65536 == 0L || downloadedBytes == totalSize) {</b>
<b class="nc">&nbsp;                                        val progress = if (totalSize &gt; 0) {</b>
<b class="nc">&nbsp;                                            ((downloadedBytes * 100) / totalSize).toInt().coerceIn(0, 100)</b>
<b class="nc">&nbsp;                                        } else 0</b>
&nbsp;                                        
<b class="nc">&nbsp;                                        lifecycleScope.launch(Dispatchers.Main) {</b>
<b class="nc">&nbsp;                                            adapter.updateProgress(mapDownload, progress)</b>
&nbsp;                                        }
&nbsp;                                    }
&nbsp;                                }
<b class="nc">&nbsp;                                return byte</b>
&nbsp;                            }
&nbsp;                            
&nbsp;                            override fun read(b: ByteArray, off: Int, len: Int): Int {
<b class="nc">&nbsp;                                val bytesRead = inputStream.read(b, off, len)</b>
<b class="nc">&nbsp;                                if (bytesRead &gt; 0) {</b>
<b class="nc">&nbsp;                                    downloadedBytes += bytesRead</b>
&nbsp;                                    // Update progress every 64KB to avoid too many UI updates
<b class="nc">&nbsp;                                    if (downloadedBytes % 65536 &lt; bytesRead || downloadedBytes == totalSize) {</b>
<b class="nc">&nbsp;                                        val progress = if (totalSize &gt; 0) {</b>
<b class="nc">&nbsp;                                            ((downloadedBytes * 100) / totalSize).toInt().coerceIn(0, 100)</b>
<b class="nc">&nbsp;                                        } else 0</b>
&nbsp;                                        
<b class="nc">&nbsp;                                        lifecycleScope.launch(Dispatchers.Main) {</b>
<b class="nc">&nbsp;                                            adapter.updateProgress(mapDownload, progress)</b>
&nbsp;                                        }
&nbsp;                                    }
&nbsp;                                }
<b class="nc">&nbsp;                                return bytesRead</b>
&nbsp;                            }
&nbsp;                        }
&nbsp;                        
<b class="nc">&nbsp;                        BufferedInputStream(countingInputStream).use { bufferedInputStream -&gt;</b>
<b class="nc">&nbsp;                            TarArchiveInputStream(bufferedInputStream).use { tarInput -&gt;</b>
<b class="nc">&nbsp;                                var entry = tarInput.nextTarEntry</b>
<b class="nc">&nbsp;                                while (entry != null) {</b>
<b class="nc">&nbsp;                                    if (!entry.isDirectory) {</b>
<b class="nc">&nbsp;                                        val outputFile = File(cacheDir, entry.name)</b>
<b class="nc">&nbsp;                                        outputFile.parentFile?.mkdirs()</b>
<b class="nc">&nbsp;                                        FileOutputStream(outputFile).use { fos -&gt;</b>
<b class="nc">&nbsp;                                            val buffer = ByteArray(4096)</b>
<b class="nc">&nbsp;                                            var len: Int</b>
<b class="nc">&nbsp;                                            while (tarInput.read(buffer).also { len = it } != -1) {</b>
<b class="nc">&nbsp;                                                fos.write(buffer, 0, len)</b>
&nbsp;                                            }
<b class="nc">&nbsp;                                        }</b>
<b class="nc">&nbsp;                                        extractedFileCount++</b>
<b class="nc">&nbsp;                                        Log.v(TAG, &quot;Extracted file ${extractedFileCount}: ${entry.name}&quot;)</b>
&nbsp;                                    }
<b class="nc">&nbsp;                                    entry = tarInput.nextTarEntry</b>
&nbsp;                                }
<b class="nc">&nbsp;                            }</b>
<b class="nc">&nbsp;                        }</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                    
<b class="nc">&nbsp;                    Log.d(TAG, &quot;Download complete: ${mapDownload.name}, extracted $extractedFileCount files&quot;)</b>
&nbsp;                    
<b class="nc">&nbsp;                    withContext(Dispatchers.Main) {</b>
&nbsp;                        // Update cache usage display
<b class="nc">&nbsp;                        setupCacheUsage()</b>
&nbsp;                        
<b class="nc">&nbsp;                        Toast.makeText(this@DownloadMapsActivity, &quot;${mapDownload.name} download complete! Extracted $extractedFileCount files.&quot;, Toast.LENGTH_LONG).show()</b>
<b class="nc">&nbsp;                        adapter.updateProgress(mapDownload, 100) // Mark as complete</b>
&nbsp;                        // Don&#39;t automatically close activity - let user see completion and navigate back manually
&nbsp;                    }
&nbsp;                } else {
<b class="nc">&nbsp;                    showError(&quot;Download failed - HTTP ${response.code}&quot;)</b>
&nbsp;                }
&nbsp;            } catch (e: Exception) {
<b class="nc">&nbsp;                Log.e(TAG, &quot;Download/Extraction failed for ${mapDownload.name}&quot;, e)</b>
<b class="nc">&nbsp;                showError(&quot;Download failed: ${e.message}&quot;)</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun showError(message: String) {
<b class="nc">&nbsp;        withContext(Dispatchers.Main) {</b>
<b class="nc">&nbsp;            progressBar.visibility = View.GONE</b>
<b class="nc">&nbsp;            Toast.makeText(this@DownloadMapsActivity, message, Toast.LENGTH_SHORT).show()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private class MapDownloadAdapter(
<b class="nc">&nbsp;        private val mapDownloads: List&lt;MapDownload&gt;,</b>
<b class="nc">&nbsp;        private val onDownloadClick: (MapDownload) -&gt; Unit</b>
<b class="nc">&nbsp;    ) : RecyclerView.Adapter&lt;MapDownloadAdapter.ViewHolder&gt;() {</b>
&nbsp;
<b class="nc">&nbsp;        private val progressMap = mutableMapOf&lt;String, Int&gt;()</b>
&nbsp;
&nbsp;        fun updateProgress(mapDownload: MapDownload, progress: Int) {
<b class="nc">&nbsp;            progressMap[mapDownload.name] = progress</b>
<b class="nc">&nbsp;            val index = mapDownloads.indexOf(mapDownload)</b>
<b class="nc">&nbsp;            if (index != -1) {</b>
<b class="nc">&nbsp;                notifyItemChanged(index)</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): ViewHolder {
<b class="nc">&nbsp;            val view = LayoutInflater.from(parent.context).inflate(R.layout.list_item_map_download, parent, false)</b>
<b class="nc">&nbsp;            return ViewHolder(view)</b>
&nbsp;        }
&nbsp;
&nbsp;        override fun onBindViewHolder(holder: ViewHolder, position: Int) {
<b class="nc">&nbsp;            val mapDownload = mapDownloads[position]</b>
<b class="nc">&nbsp;            holder.bind(mapDownload, progressMap.getOrDefault(mapDownload.name, -1))</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        override fun getItemCount() = mapDownloads.size</b>
&nbsp;
<b class="nc">&nbsp;        inner class ViewHolder(itemView: View) : RecyclerView.ViewHolder(itemView) {</b>
<b class="nc">&nbsp;            private val mapName: TextView = itemView.findViewById(R.id.mapName)</b>
<b class="nc">&nbsp;            private val mapDescription: TextView = itemView.findViewById(R.id.mapDescription)</b>
<b class="nc">&nbsp;            private val mapSize: TextView = itemView.findViewById(R.id.mapSize)</b>
<b class="nc">&nbsp;            private val downloadButton: Button = itemView.findViewById(R.id.downloadButton)</b>
<b class="nc">&nbsp;            private val downloadProgressBar: ProgressBar = itemView.findViewById(R.id.downloadProgressBar)</b>
&nbsp;
&nbsp;            fun bind(mapDownload: MapDownload, progress: Int) {
<b class="nc">&nbsp;                mapName.text = mapDownload.name</b>
<b class="nc">&nbsp;                mapDescription.text = mapDownload.description</b>
<b class="nc">&nbsp;                val df = DecimalFormat(&quot;#.##&quot;)</b>
<b class="nc">&nbsp;                val sizeInMB = df.format(mapDownload.fileSize.toDouble() / (1024 * 1024))</b>
<b class="nc">&nbsp;                mapSize.text = &quot;Size: $sizeInMB MB&quot;</b>
&nbsp;
<b class="nc">&nbsp;                when {</b>
<b class="nc">&nbsp;                    progress in 0..99 -&gt; {</b>
<b class="nc">&nbsp;                        downloadProgressBar.visibility = View.VISIBLE</b>
<b class="nc">&nbsp;                        downloadProgressBar.progress = progress</b>
<b class="nc">&nbsp;                        downloadButton.isEnabled = false</b>
<b class="nc">&nbsp;                        downloadButton.text = &quot;Downloading...&quot;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    progress &gt;= 100 -&gt; {</b>
<b class="nc">&nbsp;                        downloadProgressBar.visibility = View.GONE</b>
<b class="nc">&nbsp;                        downloadButton.isEnabled = false</b>
<b class="nc">&nbsp;                        downloadButton.text = &quot;Downloaded&quot;</b>
&nbsp;                    }
&nbsp;                    else -&gt; {
<b class="nc">&nbsp;                        downloadProgressBar.visibility = View.GONE</b>
<b class="nc">&nbsp;                        downloadButton.isEnabled = true</b>
<b class="nc">&nbsp;                        downloadButton.text = &quot;Download&quot;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                downloadButton.setOnClickListener {</b>
<b class="nc">&nbsp;                    if (adapterPosition != RecyclerView.NO_POSITION) {</b>
<b class="nc">&nbsp;                        onDownloadClick(mapDownloads[adapterPosition])</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun setupCacheUsage() {
&nbsp;        // Calculate and display cache usage in background
<b class="nc">&nbsp;        lifecycleScope.launch(Dispatchers.IO) {</b>
<b class="nc">&nbsp;            val stats = getDirectoryStats(tileCacheDir)</b>
<b class="nc">&nbsp;            val totalSize = stats[0]</b>
<b class="nc">&nbsp;            val fileCount = stats[1]</b>
&nbsp;
<b class="nc">&nbsp;            withContext(Dispatchers.Main) {</b>
<b class="nc">&nbsp;                updateCacheUsageDisplay(totalSize, fileCount)</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // Set up clear cache link click handler
<b class="nc">&nbsp;        clearCacheLink.setOnClickListener {</b>
<b class="nc">&nbsp;            openAppSettings()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun updateCacheUsageDisplay(totalSize: Long, fileCount: Long) {
<b class="nc">&nbsp;        val df = DecimalFormat(&quot;#.##&quot;)</b>
<b class="nc">&nbsp;        val sizeInMB = df.format(totalSize.toDouble() / (1024 * 1024))</b>
&nbsp;        
<b class="nc">&nbsp;        val cacheText = getString(R.string.cacheUsageFormat, &quot;${sizeInMB}MB&quot;, fileCount.toInt())</b>
<b class="nc">&nbsp;        cacheUsageText.text = cacheText</b>
&nbsp;        
&nbsp;        // Show clear cache link if there are tiles to clear
<b class="nc">&nbsp;        if (fileCount &gt; 0) {</b>
<b class="nc">&nbsp;            clearCacheLink.visibility = View.VISIBLE</b>
&nbsp;        } else {
<b class="nc">&nbsp;            clearCacheLink.visibility = View.GONE</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun getDirectoryStats(directory: File): LongArray {
<b class="nc">&nbsp;        var size = 0L</b>
<b class="nc">&nbsp;        var count = 0L</b>
&nbsp;        
<b class="nc">&nbsp;        if (directory.isDirectory &amp;&amp; directory.listFiles() != null) {</b>
<b class="nc">&nbsp;            directory.listFiles()?.forEach { file -&gt;</b>
<b class="nc">&nbsp;                if (file.isFile) {</b>
<b class="nc">&nbsp;                    size += file.length()</b>
<b class="nc">&nbsp;                    count++</b>
<b class="nc">&nbsp;                } else if (file.isDirectory) {</b>
<b class="nc">&nbsp;                    val subDirStats = getDirectoryStats(file)</b>
<b class="nc">&nbsp;                    size += subDirStats[0]</b>
<b class="nc">&nbsp;                    count += subDirStats[1]</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        return longArrayOf(size, count)</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun openAppSettings() {
&nbsp;        try {
<b class="nc">&nbsp;            val intent = Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS)</b>
<b class="nc">&nbsp;            intent.data = Uri.parse(&quot;package:$packageName&quot;)</b>
<b class="nc">&nbsp;            startActivity(intent)</b>
&nbsp;        } catch (e: Exception) {
<b class="nc">&nbsp;            Log.e(TAG, &quot;Failed to open app settings&quot;, e)</b>
<b class="nc">&nbsp;            Toast.makeText(this, &quot;Unable to open app settings&quot;, Toast.LENGTH_SHORT).show()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    companion object {
&nbsp;        private const val TAG = &quot;DownloadMapsActivity&quot;
&nbsp;        private const val YAML_URL = &quot;https://trigpointinguk-maps.s3.eu-west-1.amazonaws.com/map_downloads.yaml&quot;
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-08-25 13:52</div>
</div>
</body>
</html>
