


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > PhotoMetadataDialog</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">uk.trigpointing.android.logging</a>
</div>

<h1>Coverage Summary for Class: PhotoMetadataDialog (uk.trigpointing.android.logging)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">PhotoMetadataDialog</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/39)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/93)
  </span>
</td>
</tr>
  <tr>
    <td class="name">PhotoMetadataDialog$Companion</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PhotoMetadataDialog$WhenMappings</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/39)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/98)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package uk.trigpointing.android.logging
&nbsp;
&nbsp;import android.app.Dialog
&nbsp;import android.graphics.BitmapFactory
&nbsp;import android.os.Bundle
&nbsp;import android.view.LayoutInflater
&nbsp;import android.view.View
&nbsp;import android.view.ViewGroup
&nbsp;import android.widget.*
&nbsp;import androidx.fragment.app.DialogFragment
&nbsp;import com.google.android.material.dialog.MaterialAlertDialogBuilder
&nbsp;import uk.trigpointing.android.DbHelper
&nbsp;import uk.trigpointing.android.R
&nbsp;import uk.trigpointing.android.types.PhotoSubject
&nbsp;import java.io.File
&nbsp;
&nbsp;/**
&nbsp; * Dialog for editing photo metadata
&nbsp; */
<b class="nc">&nbsp;class PhotoMetadataDialog : DialogFragment() {</b>
&nbsp;    
&nbsp;    private lateinit var imageView: ImageView
&nbsp;    private lateinit var subjectSpinner: Spinner
&nbsp;    private lateinit var captionEditText: EditText
&nbsp;    private lateinit var publicCheckBox: CheckBox
&nbsp;    
&nbsp;    private var photoId: Long = 0
&nbsp;    private var photoPath: String? = null
&nbsp;    private var thumbPath: String? = null
&nbsp;    private var trigId: Long = 0
&nbsp;    
&nbsp;    private var onSaveCallback: ((PhotoManager.PhotoMetadata) -&gt; Unit)? = null
&nbsp;    private var onDeleteCallback: (() -&gt; Unit)? = null
&nbsp;    
&nbsp;    companion object {
&nbsp;        private const val ARG_PHOTO_ID = &quot;photo_id&quot;
&nbsp;        
&nbsp;        fun newInstance(photoId: Long): PhotoMetadataDialog {
<b class="nc">&nbsp;            return PhotoMetadataDialog().apply {</b>
<b class="nc">&nbsp;                arguments = Bundle().apply {</b>
<b class="nc">&nbsp;                    putLong(ARG_PHOTO_ID, photoId)</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    override fun onCreate(savedInstanceState: Bundle?) {
<b class="nc">&nbsp;        super.onCreate(savedInstanceState)</b>
<b class="nc">&nbsp;        photoId = arguments?.getLong(ARG_PHOTO_ID) ?: 0</b>
&nbsp;    }
&nbsp;    
&nbsp;    override fun onCreateDialog(savedInstanceState: Bundle?): Dialog {
<b class="nc">&nbsp;        val inflater = LayoutInflater.from(requireContext())</b>
<b class="nc">&nbsp;        val view = inflater.inflate(R.layout.dialog_photo_metadata, null)</b>
&nbsp;        
<b class="nc">&nbsp;        setupViews(view)</b>
<b class="nc">&nbsp;        loadPhotoData()</b>
&nbsp;        
<b class="nc">&nbsp;        return MaterialAlertDialogBuilder(requireContext())</b>
<b class="nc">&nbsp;            .setTitle(&quot;Photo Details&quot;)</b>
<b class="nc">&nbsp;            .setView(view)</b>
<b class="nc">&nbsp;            .setPositiveButton(&quot;Save&quot;) { _, _ -&gt;</b>
<b class="nc">&nbsp;                saveMetadata()</b>
&nbsp;            }
<b class="nc">&nbsp;            .setNegativeButton(&quot;Cancel&quot;, null)</b>
<b class="nc">&nbsp;            .setNeutralButton(&quot;Delete&quot;) { _, _ -&gt;</b>
<b class="nc">&nbsp;                confirmDelete()</b>
&nbsp;            }
<b class="nc">&nbsp;            .create()</b>
&nbsp;    }
&nbsp;    
&nbsp;    private fun setupViews(view: View) {
<b class="nc">&nbsp;        imageView = view.findViewById(R.id.photo_preview)</b>
<b class="nc">&nbsp;        subjectSpinner = view.findViewById(R.id.subject_spinner)</b>
<b class="nc">&nbsp;        captionEditText = view.findViewById(R.id.caption_edit)</b>
<b class="nc">&nbsp;        publicCheckBox = view.findViewById(R.id.public_checkbox)</b>
&nbsp;        
&nbsp;        // Setup subject spinner
<b class="nc">&nbsp;        val subjects = PhotoSubject.values().filter { it != PhotoSubject.NOSUBJECT }</b>
<b class="nc">&nbsp;        val adapter = ArrayAdapter(</b>
<b class="nc">&nbsp;            requireContext(),</b>
<b class="nc">&nbsp;            android.R.layout.simple_spinner_item,</b>
<b class="nc">&nbsp;            subjects.map { getSubjectDisplayName(it) }</b>
&nbsp;        )
<b class="nc">&nbsp;        adapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item)</b>
<b class="nc">&nbsp;        subjectSpinner.adapter = adapter</b>
&nbsp;        
&nbsp;        // Set default selection to TRIGPOINT
<b class="nc">&nbsp;        val defaultIndex = subjects.indexOf(PhotoSubject.TRIGPOINT)</b>
<b class="nc">&nbsp;        if (defaultIndex &gt;= 0) {</b>
<b class="nc">&nbsp;            subjectSpinner.setSelection(defaultIndex)</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    private fun getSubjectDisplayName(subject: PhotoSubject): String {
<b class="nc">&nbsp;        return when (subject) {</b>
<b class="nc">&nbsp;            PhotoSubject.TRIGPOINT -&gt; &quot;Trigpoint&quot;</b>
<b class="nc">&nbsp;            PhotoSubject.FLUSHBRACKET -&gt; &quot;Flush Bracket&quot;</b>
<b class="nc">&nbsp;            PhotoSubject.LANDSCAPE -&gt; &quot;Landscape&quot;</b>
<b class="nc">&nbsp;            PhotoSubject.PEOPLE -&gt; &quot;People&quot;</b>
<b class="nc">&nbsp;            PhotoSubject.NOSUBJECT -&gt; &quot;Other&quot;</b>
<b class="nc">&nbsp;            else -&gt; subject.toString()</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    private fun loadPhotoData() {
<b class="nc">&nbsp;        val db = DbHelper(requireContext())</b>
&nbsp;        try {
<b class="nc">&nbsp;            db.open()</b>
<b class="nc">&nbsp;            val cursor = db.fetchPhoto(photoId)</b>
<b class="nc">&nbsp;            if (cursor != null &amp;&amp; cursor.moveToFirst()) {</b>
<b class="nc">&nbsp;                trigId = cursor.getLong(cursor.getColumnIndexOrThrow(DbHelper.PHOTO_TRIG))</b>
<b class="nc">&nbsp;                thumbPath = cursor.getString(cursor.getColumnIndexOrThrow(DbHelper.PHOTO_ICON))</b>
<b class="nc">&nbsp;                photoPath = cursor.getString(cursor.getColumnIndexOrThrow(DbHelper.PHOTO_PHOTO))</b>
<b class="nc">&nbsp;                val caption = cursor.getString(cursor.getColumnIndexOrThrow(DbHelper.PHOTO_NAME))</b>
<b class="nc">&nbsp;                val subjectCode = cursor.getString(cursor.getColumnIndexOrThrow(DbHelper.PHOTO_SUBJECT))</b>
<b class="nc">&nbsp;                val isPublic = cursor.getInt(cursor.getColumnIndexOrThrow(DbHelper.PHOTO_ISPUBLIC)) &gt; 0</b>
&nbsp;                cursor.close()
&nbsp;                
&nbsp;                // Load thumbnail
<b class="nc">&nbsp;                thumbPath?.let { path -&gt;</b>
<b class="nc">&nbsp;                    if (File(path).exists()) {</b>
<b class="nc">&nbsp;                        val bitmap = BitmapFactory.decodeFile(path)</b>
<b class="nc">&nbsp;                        imageView.setImageBitmap(bitmap)</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
&nbsp;                
&nbsp;                // Set caption
<b class="nc">&nbsp;                captionEditText.setText(caption)</b>
&nbsp;                
&nbsp;                // Set subject
<b class="nc">&nbsp;                val subject = PhotoSubject.fromCode(subjectCode)</b>
<b class="nc">&nbsp;                val subjects = PhotoSubject.values().filter { it != PhotoSubject.NOSUBJECT }</b>
<b class="nc">&nbsp;                val subjectIndex = subjects.indexOf(subject)</b>
<b class="nc">&nbsp;                if (subjectIndex &gt;= 0) {</b>
<b class="nc">&nbsp;                    subjectSpinner.setSelection(subjectIndex)</b>
&nbsp;                }
&nbsp;                
&nbsp;                // Set public checkbox
<b class="nc">&nbsp;                publicCheckBox.isChecked = isPublic</b>
&nbsp;            }
&nbsp;        } catch (e: Exception) {
<b class="nc">&nbsp;            e.printStackTrace()</b>
&nbsp;        } finally {
&nbsp;            db.close()
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    private fun saveMetadata() {
<b class="nc">&nbsp;        val subjects = PhotoSubject.values().filter { it != PhotoSubject.NOSUBJECT }</b>
<b class="nc">&nbsp;        val selectedSubject = subjects[subjectSpinner.selectedItemPosition]</b>
&nbsp;        
<b class="nc">&nbsp;        val metadata = PhotoManager.PhotoMetadata(</b>
<b class="nc">&nbsp;            subject = selectedSubject,</b>
<b class="nc">&nbsp;            caption = captionEditText.text.toString(),</b>
<b class="nc">&nbsp;            isPublic = publicCheckBox.isChecked</b>
&nbsp;        )
&nbsp;        
&nbsp;        // Update database
<b class="nc">&nbsp;        val db = DbHelper(requireContext())</b>
&nbsp;        try {
<b class="nc">&nbsp;            db.open()</b>
<b class="nc">&nbsp;            db.updatePhoto(</b>
<b class="nc">&nbsp;                photoId,</b>
<b class="nc">&nbsp;                trigId,</b>
<b class="nc">&nbsp;                metadata.caption,</b>
<b class="nc">&nbsp;                &quot;&quot;, // description not used</b>
<b class="nc">&nbsp;                thumbPath ?: &quot;&quot;,</b>
<b class="nc">&nbsp;                photoPath ?: &quot;&quot;,</b>
<b class="nc">&nbsp;                metadata.subject,</b>
<b class="nc">&nbsp;                if (metadata.isPublic) 1 else 0</b>
&nbsp;            )
&nbsp;        } finally {
&nbsp;            db.close()
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        onSaveCallback?.invoke(metadata)</b>
&nbsp;    }
&nbsp;    
&nbsp;    private fun confirmDelete() {
<b class="nc">&nbsp;        MaterialAlertDialogBuilder(requireContext())</b>
<b class="nc">&nbsp;            .setTitle(&quot;Delete Photo&quot;)</b>
<b class="nc">&nbsp;            .setMessage(&quot;Are you sure you want to delete this photo? This action cannot be undone.&quot;)</b>
<b class="nc">&nbsp;            .setPositiveButton(&quot;Delete&quot;) { _, _ -&gt;</b>
<b class="nc">&nbsp;                deletePhoto()</b>
&nbsp;            }
<b class="nc">&nbsp;            .setNegativeButton(&quot;Cancel&quot;, null)</b>
<b class="nc">&nbsp;            .show()</b>
&nbsp;    }
&nbsp;    
&nbsp;    private fun deletePhoto() {
<b class="nc">&nbsp;        val db = DbHelper(requireContext())</b>
&nbsp;        try {
<b class="nc">&nbsp;            db.open()</b>
&nbsp;            
&nbsp;            // Delete files
<b class="nc">&nbsp;            thumbPath?.let { File(it).delete() }</b>
<b class="nc">&nbsp;            photoPath?.let { File(it).delete() }</b>
&nbsp;            
&nbsp;            // Delete from database
<b class="nc">&nbsp;            db.deletePhoto(photoId)</b>
&nbsp;        } finally {
&nbsp;            db.close()
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        onDeleteCallback?.invoke()</b>
&nbsp;    }
&nbsp;    
&nbsp;    fun setCallbacks(
&nbsp;        onSave: (PhotoManager.PhotoMetadata) -&gt; Unit,
&nbsp;        onDelete: () -&gt; Unit
&nbsp;    ) {
<b class="nc">&nbsp;        onSaveCallback = onSave</b>
<b class="nc">&nbsp;        onDeleteCallback = onDelete</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-08-25 13:52</div>
</div>
</body>
</html>
