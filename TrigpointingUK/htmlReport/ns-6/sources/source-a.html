


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > SyncTask</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">uk.trigpointing.android.logging</a>
</div>

<h1>Coverage Summary for Class: SyncTask (uk.trigpointing.android.logging)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">SyncTask</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/107)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/280)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package uk.trigpointing.android.logging;
&nbsp;
&nbsp;import java.io.BufferedInputStream;
&nbsp;import java.io.BufferedReader;
&nbsp;import java.io.File;
&nbsp;import java.io.IOException;
&nbsp;import java.io.InputStream;
&nbsp;import java.io.InputStreamReader;
&nbsp;import java.net.URL;
&nbsp;import java.net.URLConnection;
&nbsp;import java.net.URLEncoder;
&nbsp;import java.util.zip.GZIPInputStream;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import org.json.JSONException;
&nbsp;import org.json.JSONObject;
&nbsp;
&nbsp;import androidx.appcompat.app.AlertDialog;
&nbsp;import android.content.Context;
&nbsp;import android.content.SharedPreferences;
&nbsp;import android.content.pm.PackageManager.NameNotFoundException;
&nbsp;import android.database.Cursor;
&nbsp;import java.util.concurrent.CompletableFuture;
&nbsp;import java.util.concurrent.ExecutorService;
&nbsp;import java.util.concurrent.Executors;
&nbsp;import android.os.Handler;
&nbsp;import android.os.Looper;
&nbsp;import androidx.preference.PreferenceManager;
&nbsp;import android.util.Log;
&nbsp;import android.widget.Toast;
&nbsp;import android.widget.ProgressBar;
&nbsp;import android.widget.TextView;
&nbsp;import android.widget.LinearLayout;
&nbsp;import android.view.ViewGroup;
&nbsp;import android.util.TypedValue;
&nbsp;
&nbsp;import uk.trigpointing.android.DbHelper;
&nbsp;import uk.trigpointing.android.R;
&nbsp;import uk.trigpointing.android.common.CountingMultipartEntity.ProgressListener;
&nbsp;import uk.trigpointing.android.common.ProgressRequestBody;
&nbsp;import okhttp3.FormBody;
&nbsp;import okhttp3.MediaType;
&nbsp;import okhttp3.MultipartBody;
&nbsp;import okhttp3.OkHttpClient;
&nbsp;import okhttp3.Request;
&nbsp;import okhttp3.RequestBody;
&nbsp;import okhttp3.Response;
&nbsp;import uk.trigpointing.android.types.Condition;
&nbsp;
&nbsp;
&nbsp;
&nbsp;public class SyncTask implements ProgressListener {
&nbsp;	public static final String TAG =&quot;SyncTask&quot;;
&nbsp;	private Context 			mCtx;
&nbsp;	private SharedPreferences 	mPrefs;
&nbsp;    private AlertDialog 		progressDialog;
&nbsp;    private ProgressBar 		progressBar;
&nbsp;    private TextView   		progressText;
<b class="nc">&nbsp;	private final ExecutorService executor = Executors.newSingleThreadExecutor();</b>
<b class="nc">&nbsp;	private final Handler mainHandler = new Handler(Looper.getMainLooper());</b>
<b class="nc">&nbsp;	private boolean mIsAutoSyncAfterDownload = false;</b>
&nbsp;	
&nbsp;	private void updateProgress(int type, int... values) {
<b class="nc">&nbsp;        mainHandler.post(() -&gt; {</b>
&nbsp;            String message;
<b class="nc">&nbsp;            if (progressDialog == null) {</b>
<b class="nc">&nbsp;                showDialog(&quot;&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            switch (type) {</b>
&nbsp;            case MAX:
<b class="nc">&nbsp;                if (progressBar != null) {</b>
<b class="nc">&nbsp;                    progressBar.setIndeterminate(false);</b>
<b class="nc">&nbsp;                    progressBar.setMax(values[0]);</b>
<b class="nc">&nbsp;                    progressBar.setProgress(0);</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            case PROGRESS:
<b class="nc">&nbsp;                if (progressBar != null) {</b>
<b class="nc">&nbsp;                    progressBar.setProgress(values[0]);</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            case MESSAGE:
<b class="nc">&nbsp;                message = mCtx.getResources().getString(values[0]);</b>
<b class="nc">&nbsp;                if (progressText != null) {</b>
<b class="nc">&nbsp;                    progressText.setText(message);</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            case MESSAGECOUNT:
<b class="nc">&nbsp;                message = &quot;Uploading photo &quot; + values[0] + &quot; of &quot; + values[1];</b>
<b class="nc">&nbsp;                if (progressText != null) {</b>
<b class="nc">&nbsp;                    progressText.setText(message);</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            case BLANKPROGRESS:
<b class="nc">&nbsp;                if (progressBar != null) {</b>
<b class="nc">&nbsp;                    progressBar.setMax(1);</b>
&nbsp;                }
&nbsp;                break;
&nbsp;            }
&nbsp;        });
&nbsp;	}
&nbsp;
<b class="nc">&nbsp;	private	DbHelper 			mDb = null;</b>
&nbsp;	private SyncListener		mSyncListener;
&nbsp;	
<b class="nc">&nbsp;    private static boolean 		mLock = false;</b>
&nbsp;    private int 				mAppVersion;
&nbsp;    private int 				mMax;		// Maximum count of things being synced, for progress bar
&nbsp;    private String				mUsername;
&nbsp;    private String				mPassword;
&nbsp;    private String				mErrorMessage;
&nbsp;    
&nbsp;    private int					mActiveByteCount; // byte count from currently transferring photo
&nbsp;    private int					mPreviousByteCount; // byte count from previously transferred photos
&nbsp;    
&nbsp;    private static final int 	MAX 			= 1;
&nbsp;    private static final int 	PROGRESS 		= 2;
&nbsp;    private static final int 	MESSAGE			= 3;
&nbsp;    private static final int 	BLANKPROGRESS	= 4;
&nbsp;    private static final int 	MESSAGECOUNT	= 5;
&nbsp;    
&nbsp;    private static final String PREFS_LOGCOUNT  =&quot;logCount&quot;;
&nbsp;    
&nbsp;    public static final int 	SUCCESS 	= 0;
&nbsp;    public static final int 	NOROWS 		= 1;
&nbsp;    public static final int 	ERROR 		= 2;
&nbsp;    public static final int 	CANCELLED 	= 3;
&nbsp;    
&nbsp;    
&nbsp;    
<b class="nc">&nbsp;	public SyncTask(Context pCtx, SyncListener listener) {</b>
<b class="nc">&nbsp;		this.mCtx = pCtx;</b>
<b class="nc">&nbsp;		this.mSyncListener = listener;</b>
&nbsp;		try {
<b class="nc">&nbsp;			mAppVersion = mCtx.getPackageManager().getPackageInfo(mCtx.getPackageName(), 0).versionCode;</b>
&nbsp;		} catch (NameNotFoundException e) {
<b class="nc">&nbsp;			Log.e(TAG,&quot;Couldn&#39;t get versionCode!&quot;);</b>
<b class="nc">&nbsp;			mAppVersion = 99999;</b>
&nbsp;		}
&nbsp;	}
&nbsp;	
&nbsp;	public void detach() {
<b class="nc">&nbsp;        mCtx = null;</b>
<b class="nc">&nbsp;        mSyncListener = null;</b>
<b class="nc">&nbsp;        if (progressDialog != null) { progressDialog.dismiss(); }</b>
&nbsp;	}
&nbsp;	
&nbsp;	public void attach(Context pCtx, SyncListener listener) {
<b class="nc">&nbsp;		this.mCtx = pCtx;</b>
<b class="nc">&nbsp;		this.mSyncListener = listener;</b>
<b class="nc">&nbsp;        showDialog(&quot;Continuing sync&quot;);</b>
&nbsp;	}
&nbsp;	
&nbsp;	public void execute(Long... trigId) {
<b class="nc">&nbsp;		execute(false, trigId);</b>
&nbsp;	}
&nbsp;	
&nbsp;	public void execute(boolean isAutoSyncAfterDownload, Long... trigId) {
<b class="nc">&nbsp;		mIsAutoSyncAfterDownload = isAutoSyncAfterDownload;</b>
&nbsp;		
&nbsp;		// Pre-execution logic (equivalent to onPreExecute)
<b class="nc">&nbsp;		if (mCtx == null) {</b>
<b class="nc">&nbsp;			Toast.makeText(mCtx, &quot;Sync failed!&quot;, Toast.LENGTH_LONG).show();</b>
<b class="nc">&nbsp;			if (mSyncListener != null) {</b>
<b class="nc">&nbsp;				mSyncListener.onSynced(ERROR);</b>
&nbsp;			}
&nbsp;			return;
&nbsp;		}
&nbsp;		
&nbsp;		// Check that we have a username and password, so that we can sync existing logs
<b class="nc">&nbsp;		mPrefs = PreferenceManager.getDefaultSharedPreferences(mCtx);</b>
<b class="nc">&nbsp;		String username = mPrefs.getString(&quot;username&quot;, &quot;&quot;);</b>
<b class="nc">&nbsp;		String password = mPrefs.getString(&quot;plaintextpassword&quot;, &quot;&quot;);</b>
&nbsp;		
<b class="nc">&nbsp;		if (username.trim().isEmpty() || password.trim().isEmpty()) {</b>
<b class="nc">&nbsp;			Log.i(TAG, &quot;execute: Missing credentials, calling onSynced with ERROR status&quot;);</b>
&nbsp;			// Only show toast if this isn&#39;t an automatic sync after download
<b class="nc">&nbsp;			if (!mIsAutoSyncAfterDownload) {</b>
<b class="nc">&nbsp;				Toast.makeText(mCtx, R.string.toastPleaseLogin, Toast.LENGTH_LONG).show();</b>
&nbsp;			}
&nbsp;			// Always call onSynced callback, even when credentials are missing
<b class="nc">&nbsp;			if (mSyncListener != null) {</b>
<b class="nc">&nbsp;				mSyncListener.onSynced(ERROR);</b>
&nbsp;			}
&nbsp;			return;
&nbsp;		}
<b class="nc">&nbsp;		showDialog(&quot;Connecting to T:UK&quot;);</b>
<b class="nc">&nbsp;		mErrorMessage = &quot;&quot;;</b>
&nbsp;		
<b class="nc">&nbsp;		CompletableFuture.supplyAsync(() -&gt; {</b>
<b class="nc">&nbsp;			Log.d(TAG, &quot;doInBackground&quot;);</b>
&nbsp;			
&nbsp;			// Make sure only one SyncTask runs at a time
<b class="nc">&nbsp;			if (mLock) {</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;SyncTask already running&quot;);</b>
<b class="nc">&nbsp;				return ERROR;</b>
&nbsp;			}
<b class="nc">&nbsp;			mLock = true;</b>
&nbsp;
&nbsp;			// Open database connection
<b class="nc">&nbsp;			mDb = new DbHelper(mCtx);</b>
<b class="nc">&nbsp;			mDb.open();</b>
&nbsp;			
&nbsp;			try {
&nbsp;				// Get details from Prefs
<b class="nc">&nbsp;				mUsername = mPrefs.getString(&quot;username&quot;, &quot;&quot;);</b>
<b class="nc">&nbsp;				mPassword = mPrefs.getString(&quot;plaintextpassword&quot;, &quot;&quot;);</b>
&nbsp;				// Credentials already validated at the beginning of execute()
&nbsp;
<b class="nc">&nbsp;				if (ERROR == sendLogsToTUK(trigId)) {</b>
<b class="nc">&nbsp;					return ERROR;</b>
&nbsp;				}
<b class="nc">&nbsp;				if (ERROR == sendPhotosToTUK(trigId)) {</b>
<b class="nc">&nbsp;					return ERROR;</b>
&nbsp;				}
<b class="nc">&nbsp;				mDb.close();</b>
<b class="nc">&nbsp;				mDb.open();</b>
<b class="nc">&nbsp;				if (trigId.length == 0) {</b>
<b class="nc">&nbsp;					if (ERROR == readLogsFromTUK()) {</b>
<b class="nc">&nbsp;						return ERROR;</b>
&nbsp;					}
&nbsp;				}
&nbsp;			} finally {
<b class="nc">&nbsp;				mDb.close();</b>
<b class="nc">&nbsp;				mLock = false;		</b>
&nbsp;			}
&nbsp;
<b class="nc">&nbsp;			return SUCCESS;</b>
&nbsp;        }, executor)
<b class="nc">&nbsp;        .thenAcceptAsync(result -&gt; {</b>
<b class="nc">&nbsp;			Log.d(TAG, &quot;onPostExecute &quot; + result);</b>
&nbsp;			// Post-execution logic (equivalent to onPostExecute)
<b class="nc">&nbsp;			if (result == SUCCESS) {</b>
<b class="nc">&nbsp;				Toast.makeText(mCtx, &quot;Synced with TrigpointingUK &quot; + mErrorMessage, Toast.LENGTH_SHORT).show();</b>
&nbsp;			} else {
<b class="nc">&nbsp;				Toast.makeText(mCtx, &quot;Error syncing with TrigpointingUK - &quot; + mErrorMessage, Toast.LENGTH_LONG).show();					</b>
&nbsp;			}
&nbsp;			try {
<b class="nc">&nbsp;                if (progressDialog != null) {progressDialog.dismiss();}</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;				Log.e(TAG, &quot;Exception dismissing dialog - &quot; + e.getMessage());</b>
&nbsp;			}
<b class="nc">&nbsp;			if (mSyncListener != null) {</b>
<b class="nc">&nbsp;				mSyncListener.onSynced(result);</b>
&nbsp;			}
<b class="nc">&nbsp;        }, r -&gt; mainHandler.post(r));</b>
&nbsp;	}
&nbsp;	
&nbsp;
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	Integer sendLogsToTUK(Long... trigId) {
<b class="nc">&nbsp;		Log.d(TAG, &quot;sendLogsToTUK&quot;);</b>
<b class="nc">&nbsp;		Long trig_id = null;</b>
&nbsp;		
<b class="nc">&nbsp;		if (trigId != null &amp;&amp; trigId.length &gt;= 1) {</b>
<b class="nc">&nbsp;			trig_id = trigId[0];</b>
&nbsp;		}
&nbsp;		
<b class="nc">&nbsp;		updateProgress(MESSAGE, R.string.syncToTUK);</b>
<b class="nc">&nbsp;		Cursor c = mDb.fetchLogs(trig_id);</b>
<b class="nc">&nbsp;		if (c==null) {</b>
<b class="nc">&nbsp;			return NOROWS;</b>
&nbsp;		}
&nbsp;		
<b class="nc">&nbsp;		updateProgress(MAX, c.getCount());</b>
<b class="nc">&nbsp;		updateProgress(PROGRESS, 0);</b>
&nbsp;		
<b class="nc">&nbsp;		int i=0;</b>
&nbsp;		do {
<b class="nc">&nbsp;			if (SUCCESS != sendLogToTUK(c)) {</b>
<b class="nc">&nbsp;				return ERROR;</b>
&nbsp;			}
<b class="nc">&nbsp;			updateProgress(PROGRESS, ++i);</b>
<b class="nc">&nbsp;		} while (c.moveToNext());</b>
&nbsp;		
&nbsp;		c.close();
<b class="nc">&nbsp;		return SUCCESS;</b>
&nbsp;	}
&nbsp;	
&nbsp;	
&nbsp;	Integer sendPhotosToTUK(Long... trigId) {
<b class="nc">&nbsp;		Log.d(TAG, &quot;sendPhotosToTUK&quot;);</b>
<b class="nc">&nbsp;		Long trig_id = null;</b>
<b class="nc">&nbsp;		mPreviousByteCount = 0;</b>
<b class="nc">&nbsp;		mActiveByteCount = 0;</b>
&nbsp;		
<b class="nc">&nbsp;		if (trigId != null &amp;&amp; trigId.length &gt;= 1) {</b>
<b class="nc">&nbsp;			trig_id = trigId[0];</b>
&nbsp;		}
&nbsp;
<b class="nc">&nbsp;		updateProgress(MESSAGE, R.string.syncPhotosToTUK);</b>
<b class="nc">&nbsp;		Cursor c = mDb.fetchPhotos(trig_id);</b>
<b class="nc">&nbsp;		if (c==null) {</b>
<b class="nc">&nbsp;			return NOROWS;</b>
&nbsp;		}
&nbsp;		
&nbsp;		// whiz through the cursor, totalling file sizes 
<b class="nc">&nbsp;		int totalBytes=0;</b>
&nbsp;		do {
<b class="nc">&nbsp;			totalBytes += new File(c.getString(c.getColumnIndex(DbHelper.PHOTO_PHOTO))).length();</b>
<b class="nc">&nbsp;		} while (c.moveToNext());</b>
&nbsp;		// reset cursor
<b class="nc">&nbsp;		c.moveToFirst();</b>
&nbsp;		
<b class="nc">&nbsp;		updateProgress(MAX, totalBytes);</b>
<b class="nc">&nbsp;		updateProgress(PROGRESS, 0);</b>
&nbsp;		
<b class="nc">&nbsp;		int i = 1;</b>
&nbsp;		do {
<b class="nc">&nbsp;			updateProgress(MESSAGECOUNT, i++, c.getCount());</b>
<b class="nc">&nbsp;			if (SUCCESS != sendPhotoToTUK(c)) {</b>
<b class="nc">&nbsp;				return ERROR;</b>
&nbsp;			}
<b class="nc">&nbsp;			mPreviousByteCount += mActiveByteCount;</b>
<b class="nc">&nbsp;			mActiveByteCount = 0;</b>
<b class="nc">&nbsp;		} while (c.moveToNext());</b>
&nbsp;		
&nbsp;		c.close();
<b class="nc">&nbsp;		return SUCCESS;</b>
&nbsp;	}
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	Integer sendLogToTUK(Cursor c) {
<b class="nc">&nbsp;		Log.i(TAG, &quot;sendLogToTUK&quot;);</b>
&nbsp;		
<b class="nc">&nbsp;		long trigId = c.getInt(c.getColumnIndex(DbHelper.LOG_ID));</b>
&nbsp;		
&nbsp;        // Build form body
<b class="nc">&nbsp;        FormBody formBody = new FormBody.Builder(StandardCharsets.UTF_8)</b>
<b class="nc">&nbsp;                .add(&quot;username&quot;, mUsername)</b>
<b class="nc">&nbsp;                .add(&quot;password&quot;, mPassword)</b>
<b class="nc">&nbsp;                .add(&quot;id&quot;, c.getString(c.getColumnIndex(DbHelper.LOG_ID)))</b>
<b class="nc">&nbsp;                .add(&quot;year&quot;, c.getString(c.getColumnIndex(DbHelper.LOG_YEAR)))</b>
<b class="nc">&nbsp;                .add(&quot;month&quot;, c.getString(c.getColumnIndex(DbHelper.LOG_MONTH)))</b>
<b class="nc">&nbsp;                .add(&quot;day&quot;, c.getString(c.getColumnIndex(DbHelper.LOG_DAY)))</b>
<b class="nc">&nbsp;                .add(&quot;sendtime&quot;, c.getString(c.getColumnIndex(DbHelper.LOG_SENDTIME)))</b>
<b class="nc">&nbsp;                .add(&quot;hour&quot;, c.getString(c.getColumnIndex(DbHelper.LOG_HOUR)))</b>
<b class="nc">&nbsp;                .add(&quot;minutes&quot;, c.getString(c.getColumnIndex(DbHelper.LOG_MINUTES)))</b>
<b class="nc">&nbsp;                .add(&quot;comment&quot;, c.getString(c.getColumnIndex(DbHelper.LOG_COMMENT)))</b>
<b class="nc">&nbsp;                .add(&quot;gridref&quot;, c.getString(c.getColumnIndex(DbHelper.LOG_GRIDREF)))</b>
<b class="nc">&nbsp;                .add(&quot;fb&quot;, c.getString(c.getColumnIndex(DbHelper.LOG_FB)))</b>
<b class="nc">&nbsp;                .add(&quot;adminflag&quot;, c.getString(c.getColumnIndex(DbHelper.LOG_FLAGADMINS)))</b>
<b class="nc">&nbsp;                .add(&quot;userflag&quot;, c.getString(c.getColumnIndex(DbHelper.LOG_FLAGUSERS)))</b>
<b class="nc">&nbsp;                .add(&quot;score&quot;, c.getString(c.getColumnIndex(DbHelper.LOG_SCORE)))</b>
<b class="nc">&nbsp;                .add(&quot;condition&quot;, c.getString(c.getColumnIndex(DbHelper.LOG_CONDITION)))</b>
<b class="nc">&nbsp;                .add(&quot;sendemail&quot;, String.valueOf(mPrefs.getBoolean(&quot;sendLogEmails&quot;, false)))</b>
<b class="nc">&nbsp;                .add(&quot;appversion&quot;, String.valueOf(mAppVersion))</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;		try {
<b class="nc">&nbsp;            OkHttpClient client = new OkHttpClient();</b>
<b class="nc">&nbsp;            Request request = new Request.Builder()</b>
<b class="nc">&nbsp;                    .url(&quot;https://trigpointing.uk/trigs/android-sync-log.php&quot;)</b>
<b class="nc">&nbsp;                    .post(formBody)</b>
<b class="nc">&nbsp;                    .build();</b>
<b class="nc">&nbsp;            try (Response response = client.newCall(request).execute()) {</b>
<b class="nc">&nbsp;                if (!response.isSuccessful()) {</b>
<b class="nc">&nbsp;                    Log.e(TAG, &quot;RC error - &quot; + response.code());</b>
<b class="nc">&nbsp;                    return ERROR;</b>
&nbsp;                }
<b class="nc">&nbsp;                String reply = response.body() != null ? response.body().string() : null;</b>
<b class="nc">&nbsp;	        Log.d(TAG, &quot;Reply from T:UK - &quot; + reply);</b>
<b class="nc">&nbsp;	        if (reply == null || reply == &quot;&quot;) {</b>
<b class="nc">&nbsp;	        	Log.e(TAG, &quot;No response received from T:UK&quot;);</b>
<b class="nc">&nbsp;	        	return ERROR;</b>
&nbsp;	        }
&nbsp;
&nbsp;	        // Parse the JSON response
&nbsp;	        try {
<b class="nc">&nbsp;				JSONObject jo = new JSONObject(reply);</b>
<b class="nc">&nbsp;				int status = jo.getInt(&quot;status&quot;);</b>
<b class="nc">&nbsp;				mErrorMessage = jo.getString(&quot;msg&quot;);</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;Status=&quot; + status + &quot;, msg=&quot; + mErrorMessage);</b>
&nbsp;				
<b class="nc">&nbsp;				if (status != 0) {</b>
<b class="nc">&nbsp;					return ERROR;</b>
&nbsp;				}
<b class="nc">&nbsp;				int logId = jo.getInt(&quot;log_id&quot;);</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;Successfully inserted log into T:UK - &quot; + logId);</b>
&nbsp;				// remove log from database
<b class="nc">&nbsp;				mDb.deleteLog(trigId);</b>
&nbsp;				// update photos for this trig with log id from T:UK
<b class="nc">&nbsp;				mDb.updatePhotos(trigId, logId);</b>
&nbsp;				// update local logged condition
<b class="nc">&nbsp;				mDb.updateTrigLog(trigId, Condition.fromCode(c.getString(c.getColumnIndex(DbHelper.LOG_CONDITION))));</b>
&nbsp;			} catch (JSONException e1) {
<b class="nc">&nbsp;				e1.printStackTrace();</b>
<b class="nc">&nbsp;				return ERROR;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        } catch (IOException e) {
<b class="nc">&nbsp;            return ERROR;</b>
&nbsp;		} catch (NumberFormatException e) {
<b class="nc">&nbsp;			Log.e(TAG, &quot;Unable to convert log_id received from T:UK into integer&quot;);</b>
<b class="nc">&nbsp;			return ERROR;</b>
&nbsp;		}
<b class="nc">&nbsp;		return SUCCESS;</b>
&nbsp;	}
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	Integer sendPhotoToTUK(Cursor c) {
<b class="nc">&nbsp;		Log.i(TAG, &quot;sendPhotoToTUK&quot;);</b>
&nbsp;		
<b class="nc">&nbsp;		Long	photoId 	= c.getLong  (c.getColumnIndex(DbHelper.PHOTO_ID));</b>
<b class="nc">&nbsp;    	String 	photoPath 	= c.getString(c.getColumnIndex(DbHelper.PHOTO_PHOTO));</b>
<b class="nc">&nbsp;    	String 	thumbPath 	= c.getString(c.getColumnIndex(DbHelper.PHOTO_ICON));</b>
&nbsp;
&nbsp;		try {
<b class="nc">&nbsp;            OkHttpClient client = new OkHttpClient();</b>
&nbsp;
<b class="nc">&nbsp;            MediaType JPEG = MediaType.parse(&quot;image/jpeg&quot;);</b>
<b class="nc">&nbsp;            File photoFile = new File(photoPath);</b>
<b class="nc">&nbsp;            RequestBody photoBody = new ProgressRequestBody(photoFile, JPEG, this);</b>
&nbsp;
<b class="nc">&nbsp;            MultipartBody.Builder mb = new MultipartBody.Builder()</b>
<b class="nc">&nbsp;                    .setType(MultipartBody.FORM)</b>
<b class="nc">&nbsp;                    .addFormDataPart(&quot;username&quot;, mUsername)</b>
<b class="nc">&nbsp;                    .addFormDataPart(&quot;password&quot;, mPassword)</b>
<b class="nc">&nbsp;                    .addFormDataPart(&quot;photoid&quot;, photoId.toString())</b>
<b class="nc">&nbsp;                    .addFormDataPart(&quot;tlog_id&quot;, c.getString(c.getColumnIndex(DbHelper.PHOTO_TUKLOGID)))</b>
<b class="nc">&nbsp;                    .addFormDataPart(&quot;trig&quot;, c.getString(c.getColumnIndex(DbHelper.PHOTO_TRIG)))</b>
<b class="nc">&nbsp;                    .addFormDataPart(&quot;name&quot;, c.getString(c.getColumnIndex(DbHelper.PHOTO_NAME)))</b>
<b class="nc">&nbsp;                    .addFormDataPart(&quot;descr&quot;, c.getString(c.getColumnIndex(DbHelper.PHOTO_DESCR)))</b>
<b class="nc">&nbsp;                    .addFormDataPart(&quot;subject&quot;, c.getString(c.getColumnIndex(DbHelper.PHOTO_SUBJECT)))</b>
<b class="nc">&nbsp;                    .addFormDataPart(&quot;ispublic&quot;, c.getString(c.getColumnIndex(DbHelper.PHOTO_ISPUBLIC)))</b>
<b class="nc">&nbsp;                    .addFormDataPart(&quot;appversion&quot;, String.valueOf(mAppVersion))</b>
<b class="nc">&nbsp;                    .addFormDataPart(&quot;photo&quot;, photoFile.getName(), photoBody);</b>
&nbsp;
<b class="nc">&nbsp;            Request request = new Request.Builder()</b>
<b class="nc">&nbsp;                    .url(&quot;https://trigpointing.uk/trigs/android-sync-photo.php&quot;)</b>
<b class="nc">&nbsp;                    .post(mb.build())</b>
<b class="nc">&nbsp;                    .build();</b>
&nbsp;
<b class="nc">&nbsp;            try (Response response = client.newCall(request).execute()) {</b>
<b class="nc">&nbsp;                if (!response.isSuccessful()) {</b>
<b class="nc">&nbsp;                    Log.e(TAG, &quot;RC error - &quot; + response.code());</b>
<b class="nc">&nbsp;                    return ERROR;</b>
&nbsp;                }
<b class="nc">&nbsp;                String reply = response.body() != null ? response.body().string() : null;</b>
<b class="nc">&nbsp;	        Log.i(TAG, &quot;Reply from T:UK - &quot; + reply);</b>
<b class="nc">&nbsp;	        if (reply == null || reply == &quot;&quot;) {</b>
<b class="nc">&nbsp;	        	Log.e(TAG, &quot;No response received from T:UK&quot;);</b>
<b class="nc">&nbsp;	        	return ERROR;</b>
&nbsp;	        }
&nbsp;
&nbsp;	        // Parse the JSON response
&nbsp;	        try {
<b class="nc">&nbsp;				JSONObject jo = new JSONObject(reply);</b>
<b class="nc">&nbsp;				int status = jo.getInt(&quot;status&quot;);</b>
<b class="nc">&nbsp;				mErrorMessage = jo.getString(&quot;msg&quot;);</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;Status=&quot; + status + &quot;, msg=&quot; + mErrorMessage);</b>
<b class="nc">&nbsp;				if (status != 0) {</b>
<b class="nc">&nbsp;					return ERROR;</b>
&nbsp;				}
<b class="nc">&nbsp;				int tukPhotoId = jo.getInt(&quot;photo_id&quot;);</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;Successfully uploaded photo to T:UK - &quot; + tukPhotoId);</b>
&nbsp;				// remove log from database
<b class="nc">&nbsp;				mDb.deletePhoto(photoId);</b>
&nbsp;				// remove files from cachedir
<b class="nc">&nbsp;				new File (photoPath).delete();</b>
<b class="nc">&nbsp;				new File (thumbPath).delete();</b>
&nbsp;	        } catch (JSONException e1) {
<b class="nc">&nbsp;				e1.printStackTrace();</b>
<b class="nc">&nbsp;				return ERROR;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        } catch (IOException e) {
<b class="nc">&nbsp;            return ERROR;</b>
&nbsp;		} catch (NumberFormatException e) {
<b class="nc">&nbsp;			Log.e(TAG, &quot;Unable to convert tukPhotoId received from T:UK into integer&quot;);</b>
<b class="nc">&nbsp;			return ERROR;</b>
&nbsp;		}
<b class="nc">&nbsp;		return SUCCESS;</b>
&nbsp;	}
&nbsp;	
&nbsp;	@Override
&nbsp;	public void transferred(long num) {
<b class="nc">&nbsp;		mActiveByteCount = (int) num;</b>
<b class="nc">&nbsp;					updateProgress(PROGRESS, mPreviousByteCount + mActiveByteCount);</b>
<b class="nc">&nbsp;		Log.d(TAG, &quot;Transferred bytes: &quot; + num);</b>
&nbsp;	}	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	Integer readLogsFromTUK() {
<b class="nc">&nbsp;		Log.d(TAG, &quot;readLogsFromTUK&quot;);</b>
&nbsp;
&nbsp;        String strLine;                
<b class="nc">&nbsp;		int i=0;</b>
&nbsp;		
&nbsp;		
&nbsp;		try {
<b class="nc">&nbsp;			updateProgress(BLANKPROGRESS);</b>
<b class="nc">&nbsp;			updateProgress(MESSAGE, R.string.syncLogsFromTUK);</b>
<b class="nc">&nbsp;			updateProgress(MAX, mPrefs.getInt(PREFS_LOGCOUNT, 1));</b>
<b class="nc">&nbsp;			URL url = new URL(&quot;https://trigpointing.uk/trigs/down-android-mylogs.php?username=&quot;+URLEncoder.encode(mUsername)+&quot;&amp;appversion=&quot;+mAppVersion);</b>
<b class="nc">&nbsp;			Log.d(TAG, &quot;Getting &quot; + url);</b>
<b class="nc">&nbsp;            URLConnection ucon = url.openConnection();</b>
<b class="nc">&nbsp;            InputStream is = ucon.getInputStream();</b>
<b class="nc">&nbsp;            GZIPInputStream zis = new GZIPInputStream(new BufferedInputStream(is));</b>
<b class="nc">&nbsp;            BufferedReader br = new BufferedReader(new InputStreamReader(zis));</b>
&nbsp;
<b class="nc">&nbsp;			mDb.mDb.beginTransaction();</b>
&nbsp;            
&nbsp;			// blank out any existing logs;
<b class="nc">&nbsp;			mDb.deleteAllTrigLogs();</b>
&nbsp;			
&nbsp;			// first record contains log count
<b class="nc">&nbsp;			if ((strLine=br.readLine()) != null) {</b>
<b class="nc">&nbsp;				mMax = Integer.parseInt(strLine);</b>
<b class="nc">&nbsp;				Log.i(TAG, &quot;Log count from TUK = &quot; + mMax);</b>
<b class="nc">&nbsp;				updateProgress(MAX, mMax);</b>
&nbsp;			}
&nbsp;			// read log records records
<b class="nc">&nbsp;			while ((strLine = br.readLine()) != null &amp;&amp; !strLine.trim().equals(&quot;&quot;))   {</b>
&nbsp;            	//Log.i(TAG,strLine);
<b class="nc">&nbsp;				String[] csv=strLine.split(&quot;\t&quot;);</b>
<b class="nc">&nbsp;				Condition logged		= Condition.fromCode(csv[0]);</b>
<b class="nc">&nbsp;				int id					= Integer.valueOf(csv[1]);</b>
<b class="nc">&nbsp;				mDb.updateTrigLog(id, logged);</b>
<b class="nc">&nbsp;				i++;</b>
&nbsp;				// Cancellation check removed - use CompletableFuture.cancel() if needed
<b class="nc">&nbsp;				updateProgress(PROGRESS, i);</b>
&nbsp;            }
<b class="nc">&nbsp;			mDb.mDb.setTransactionSuccessful();</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;        	Log.d(TAG, &quot;Error: &quot; + e);</b>
<b class="nc">&nbsp;        	i=-1;</b>
<b class="nc">&nbsp;        	mErrorMessage = e.getMessage();</b>
<b class="nc">&nbsp;        	return ERROR;</b>
&nbsp;        } finally {
<b class="nc">&nbsp;        	if (mDb != null &amp;&amp; mDb.mDb.inTransaction()) {</b>
<b class="nc">&nbsp;        		mDb.mDb.endTransaction();</b>
&nbsp;        	}
&nbsp;        }
&nbsp;
&nbsp;		// store the log count to pre-populate the progress bar next time
<b class="nc">&nbsp;		mPrefs.edit().putInt(PREFS_LOGCOUNT,i).apply();</b>
&nbsp;        
<b class="nc">&nbsp;		return SUCCESS;		</b>
&nbsp;	}
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;	
&nbsp;
&nbsp;    
&nbsp;    
&nbsp;    protected void showDialog(String message) {
&nbsp;        // Build a simple dialog with a horizontal ProgressBar and a message
<b class="nc">&nbsp;        LinearLayout container = new LinearLayout(mCtx);</b>
<b class="nc">&nbsp;        container.setOrientation(LinearLayout.VERTICAL);</b>
<b class="nc">&nbsp;        int paddingPx = (int) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, 24,</b>
<b class="nc">&nbsp;                mCtx.getResources().getDisplayMetrics());</b>
<b class="nc">&nbsp;        container.setPadding(paddingPx, paddingPx, paddingPx, paddingPx);</b>
&nbsp;
<b class="nc">&nbsp;        progressText = new TextView(mCtx);</b>
<b class="nc">&nbsp;        progressText.setText(message);</b>
<b class="nc">&nbsp;        container.addView(progressText, new LinearLayout.LayoutParams(</b>
&nbsp;                ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT));
&nbsp;
<b class="nc">&nbsp;        progressBar = new ProgressBar(mCtx, null, android.R.attr.progressBarStyleHorizontal);</b>
<b class="nc">&nbsp;        progressBar.setIndeterminate(false);</b>
<b class="nc">&nbsp;        container.addView(progressBar, new LinearLayout.LayoutParams(</b>
&nbsp;                ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT));
&nbsp;
<b class="nc">&nbsp;        progressDialog = new AlertDialog.Builder(mCtx)</b>
<b class="nc">&nbsp;                .setView(container)</b>
<b class="nc">&nbsp;                .setCancelable(true)</b>
<b class="nc">&nbsp;                .create();</b>
<b class="nc">&nbsp;        progressDialog.show();</b>
&nbsp;    }
&nbsp;    
&nbsp;
&nbsp;    
&nbsp;    
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-08-25 13:52</div>
</div>
</body>
</html>
