


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > TrigDetailsActivity</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">uk.trigpointing.android.trigdetails</a>
</div>

<h1>Coverage Summary for Class: TrigDetailsActivity (uk.trigpointing.android.trigdetails)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TrigDetailsActivity</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/180)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/347)
  </span>
</td>
</tr>
  <tr>
    <td class="name">TrigDetailsActivity$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/180)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/349)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package uk.trigpointing.android.trigdetails;
&nbsp;
&nbsp;import android.app.LocalActivityManager;
&nbsp;import android.content.Intent;
&nbsp;import android.net.Uri;
&nbsp;import android.content.res.Resources;
&nbsp;import android.os.Bundle;
&nbsp;import android.widget.TabHost;
&nbsp;import android.view.MenuItem;
&nbsp;import android.view.Menu;
&nbsp;import uk.trigpointing.android.R;
&nbsp;import uk.trigpointing.android.common.BaseActivity;
&nbsp;import uk.trigpointing.android.logging.LogTrigActivity;
&nbsp;import uk.trigpointing.android.DbHelper;
&nbsp;import androidx.browser.customtabs.CustomTabsIntent;
&nbsp;import androidx.activity.OnBackPressedCallback;
&nbsp;import android.widget.Toast;
&nbsp;import android.database.Cursor;
&nbsp;
<b class="nc">&nbsp;public class TrigDetailsActivity extends BaseActivity {</b>
&nbsp;
&nbsp;	private static final String TAG=&quot;TrigDetailsActivity&quot;;
&nbsp;    private LocalActivityManager mLocalActivityManager;
&nbsp;
&nbsp;	public void onCreate(Bundle savedInstanceState) {
&nbsp;	    try {
<b class="nc">&nbsp;	        android.util.Log.d(TAG, &quot;onCreate called with savedInstanceState: &quot; + (savedInstanceState != null ? &quot;not null&quot; : &quot;null&quot;));</b>
<b class="nc">&nbsp;	        super.onCreate(savedInstanceState);</b>
<b class="nc">&nbsp;	        setContentView(R.layout.trigdetails);</b>
&nbsp;	        
<b class="nc">&nbsp;	        if (getSupportActionBar() != null) {</b>
&nbsp;	            try {
<b class="nc">&nbsp;	                getSupportActionBar().setDisplayHomeAsUpEnabled(true);</b>
&nbsp;	            } catch (Exception e) {
<b class="nc">&nbsp;	                android.util.Log.w(TAG, &quot;Error setting up action bar: &quot; + e.getMessage());</b>
&nbsp;	            }
&nbsp;	        } else {
<b class="nc">&nbsp;	            android.util.Log.w(TAG, &quot;Action bar is null&quot;);</b>
&nbsp;	        }
&nbsp;	        
&nbsp;	        // Content positioning is now handled by BaseActivity
&nbsp;
<b class="nc">&nbsp;            Bundle extras = getIntent().getExtras();</b>
<b class="nc">&nbsp;            long ensuredTrigId = getIntent().getLongExtra(DbHelper.TRIG_ID, -1);</b>
<b class="nc">&nbsp;            if (extras == null) {</b>
<b class="nc">&nbsp;                extras = new Bundle();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (ensuredTrigId &gt; 0 &amp;&amp; !extras.containsKey(DbHelper.TRIG_ID)) {</b>
<b class="nc">&nbsp;                extras.putLong(DbHelper.TRIG_ID, ensuredTrigId);</b>
&nbsp;            }
&nbsp;            
&nbsp;            // Validate that we have a valid trig ID
<b class="nc">&nbsp;            if (ensuredTrigId &lt;= 0) {</b>
<b class="nc">&nbsp;                android.util.Log.w(TAG, &quot;No valid trig ID provided&quot;);</b>
<b class="nc">&nbsp;                showToast(&quot;Invalid trigpoint&quot;);</b>
<b class="nc">&nbsp;                finish();</b>
&nbsp;                return;
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            android.util.Log.d(TAG, &quot;Setting up tabs with trig ID: &quot; + ensuredTrigId);</b>
<b class="nc">&nbsp;            setupTabs(extras, savedInstanceState);</b>
&nbsp;            
&nbsp;            // Set up modern back navigation using OnBackPressedDispatcher
<b class="nc">&nbsp;            getOnBackPressedDispatcher().addCallback(this, new OnBackPressedCallback(true) {</b>
&nbsp;                @Override
&nbsp;                public void handleOnBackPressed() {
<b class="nc">&nbsp;                    finish();</b>
&nbsp;                }
&nbsp;            });
&nbsp;            
<b class="nc">&nbsp;            android.util.Log.d(TAG, &quot;onCreate completed successfully&quot;);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            android.util.Log.e(TAG, &quot;Error in onCreate: &quot; + e.getMessage(), e);</b>
<b class="nc">&nbsp;            showToast(&quot;Error initializing trig details&quot;);</b>
<b class="nc">&nbsp;            finish();</b>
&nbsp;        }
&nbsp;	}
&nbsp;
&nbsp;    private void setupTabs(Bundle extras, Bundle savedInstanceState) {
<b class="nc">&nbsp;        android.util.Log.d(TAG, &quot;setupTabs called&quot;);</b>
<b class="nc">&nbsp;        Resources res = getResources();</b>
<b class="nc">&nbsp;        TabHost tabHost = findViewById(android.R.id.tabhost);</b>
<b class="nc">&nbsp;        if (tabHost == null) {</b>
<b class="nc">&nbsp;            android.util.Log.e(TAG, &quot;TabHost not found in layout&quot;);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;        
&nbsp;        try {
<b class="nc">&nbsp;            android.util.Log.d(TAG, &quot;Creating LocalActivityManager&quot;);</b>
<b class="nc">&nbsp;            mLocalActivityManager = new LocalActivityManager(this, false);</b>
<b class="nc">&nbsp;            if (mLocalActivityManager != null) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    android.util.Log.d(TAG, &quot;Dispatching create to LocalActivityManager&quot;);</b>
<b class="nc">&nbsp;                    mLocalActivityManager.dispatchCreate(savedInstanceState);</b>
<b class="nc">&nbsp;                    android.util.Log.d(TAG, &quot;Setting up TabHost with LocalActivityManager&quot;);</b>
<b class="nc">&nbsp;                    tabHost.setup(mLocalActivityManager);</b>
<b class="nc">&nbsp;                    android.util.Log.d(TAG, &quot;TabHost setup completed successfully&quot;);</b>
&nbsp;                } catch (Exception e) {
<b class="nc">&nbsp;                    android.util.Log.e(TAG, &quot;Error setting up TabHost: &quot; + e.getMessage(), e);</b>
&nbsp;                    return;
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                android.util.Log.e(TAG, &quot;LocalActivityManager is null&quot;);</b>
&nbsp;                return;
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            android.util.Log.e(TAG, &quot;Error creating LocalActivityManager: &quot; + e.getMessage(), e);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        TabHost.TabSpec spec;
&nbsp;        Intent intent;
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            intent = new Intent().setClass(this, TrigDetailsInfoTab.class);</b>
<b class="nc">&nbsp;            if (intent != null) {</b>
<b class="nc">&nbsp;                if (extras != null) {</b>
<b class="nc">&nbsp;                    intent.putExtras(extras);</b>
&nbsp;                }
<b class="nc">&nbsp;                spec = tabHost.newTabSpec(&quot;info&quot;).setIndicator(&quot;&quot;,</b>
<b class="nc">&nbsp;                                getDrawableSafely(res, android.R.drawable.ic_menu_info_details))</b>
<b class="nc">&nbsp;                                .setContent(intent);</b>
<b class="nc">&nbsp;                if (spec != null) {</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        tabHost.addTab(spec);</b>
&nbsp;                    } catch (Exception e) {
<b class="nc">&nbsp;                        android.util.Log.w(TAG, &quot;Error adding info tab: &quot; + e.getMessage());</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            intent = new Intent().setClass(this, TrigDetailsLoglistTab.class);</b>
<b class="nc">&nbsp;            if (intent != null) {</b>
<b class="nc">&nbsp;                if (extras != null) {</b>
<b class="nc">&nbsp;                    intent.putExtras(extras);</b>
&nbsp;                }
<b class="nc">&nbsp;                spec = tabHost.newTabSpec(&quot;logs&quot;).setIndicator(&quot;&quot;,</b>
<b class="nc">&nbsp;                                  getDrawableSafely(res, android.R.drawable.ic_menu_agenda))</b>
<b class="nc">&nbsp;                              .setContent(intent);</b>
<b class="nc">&nbsp;                if (spec != null) {</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        tabHost.addTab(spec);</b>
&nbsp;                    } catch (Exception e) {
<b class="nc">&nbsp;                        android.util.Log.w(TAG, &quot;Error adding logs tab: &quot; + e.getMessage());</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            intent = new Intent().setClass(this, TrigDetailsAlbumTab.class);</b>
<b class="nc">&nbsp;            if (intent != null) {</b>
<b class="nc">&nbsp;                if (extras != null) {</b>
<b class="nc">&nbsp;                    intent.putExtras(extras);</b>
&nbsp;                }
<b class="nc">&nbsp;                spec = tabHost.newTabSpec(&quot;album&quot;).setIndicator(&quot;&quot;,</b>
<b class="nc">&nbsp;                                  getDrawableSafely(res, android.R.drawable.ic_menu_gallery))</b>
<b class="nc">&nbsp;                              .setContent(intent);</b>
<b class="nc">&nbsp;                if (spec != null) {</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        tabHost.addTab(spec);</b>
&nbsp;                    } catch (Exception e) {
<b class="nc">&nbsp;                        android.util.Log.w(TAG, &quot;Error adding album tab: &quot; + e.getMessage());</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            intent = new Intent().setClass(this, TrigDetailsOSMapTab.class);</b>
<b class="nc">&nbsp;            if (intent != null) {</b>
<b class="nc">&nbsp;                if (extras != null) {</b>
<b class="nc">&nbsp;                    intent.putExtras(extras);</b>
&nbsp;                }
<b class="nc">&nbsp;                spec = tabHost.newTabSpec(&quot;map&quot;).setIndicator(&quot;&quot;,</b>
<b class="nc">&nbsp;                                  getDrawableSafely(res, android.R.drawable.ic_menu_mapmode))</b>
<b class="nc">&nbsp;                              .setContent(intent);</b>
<b class="nc">&nbsp;                if (spec != null) {</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        tabHost.addTab(spec);</b>
&nbsp;                    } catch (Exception e) {
<b class="nc">&nbsp;                        android.util.Log.w(TAG, &quot;Error adding map tab: &quot; + e.getMessage());</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            intent = new Intent().setClass(this, LogTrigActivity.class);</b>
<b class="nc">&nbsp;            if (intent != null) {</b>
<b class="nc">&nbsp;                if (extras != null) {</b>
<b class="nc">&nbsp;                    intent.putExtras(extras);</b>
&nbsp;                }
<b class="nc">&nbsp;                spec = tabHost.newTabSpec(&quot;mylog&quot;).setIndicator(&quot;&quot;,</b>
<b class="nc">&nbsp;                                  getDrawableSafely(res, android.R.drawable.ic_menu_edit))</b>
<b class="nc">&nbsp;                              .setContent(intent);</b>
<b class="nc">&nbsp;                if (spec != null) {</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        tabHost.addTab(spec);</b>
&nbsp;                    } catch (Exception e) {
<b class="nc">&nbsp;                        android.util.Log.w(TAG, &quot;Error adding mylog tab: &quot; + e.getMessage());</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            try {
<b class="nc">&nbsp;                tabHost.setCurrentTab(0);</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                android.util.Log.w(TAG, &quot;Error setting current tab: &quot; + e.getMessage());</b>
&nbsp;            }
<b class="nc">&nbsp;            android.util.Log.d(TAG, &quot;Tabs setup completed successfully&quot;);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            android.util.Log.e(TAG, &quot;Error creating tabs: &quot; + e.getMessage(), e);</b>
<b class="nc">&nbsp;            showToast(&quot;Error setting up tabs&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    protected void onResume() {
<b class="nc">&nbsp;        super.onResume();</b>
<b class="nc">&nbsp;        android.util.Log.d(TAG, &quot;onResume called&quot;);</b>
&nbsp;        
&nbsp;        // Check if we need to recreate tabs (e.g., if LocalActivityManager is in a bad state)
<b class="nc">&nbsp;        if (mLocalActivityManager == null || !isLocalActivityManagerValid()) {</b>
<b class="nc">&nbsp;            android.util.Log.w(TAG, &quot;LocalActivityManager is null or invalid, attempting to recreate tabs&quot;);</b>
&nbsp;            try {
<b class="nc">&nbsp;                recreateTabs();</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                android.util.Log.e(TAG, &quot;Failed to recreate tabs: &quot; + e.getMessage(), e);</b>
&nbsp;            }
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (mLocalActivityManager != null) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                android.util.Log.d(TAG, &quot;Dispatching resume to LocalActivityManager&quot;);</b>
<b class="nc">&nbsp;                mLocalActivityManager.dispatchResume();</b>
<b class="nc">&nbsp;                android.util.Log.d(TAG, &quot;LocalActivityManager resume completed successfully&quot;);</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                android.util.Log.e(TAG, &quot;Error in LocalActivityManager dispatchResume: &quot; + e.getMessage(), e);</b>
&nbsp;                // Try to recover by recreating the LocalActivityManager
&nbsp;                try {
<b class="nc">&nbsp;                    android.util.Log.w(TAG, &quot;Attempting to recreate LocalActivityManager&quot;);</b>
<b class="nc">&nbsp;                    recreateLocalActivityManager();</b>
&nbsp;                    // After recreating, try to dispatch resume again
&nbsp;                    try {
<b class="nc">&nbsp;                        android.util.Log.d(TAG, &quot;Retrying dispatchResume after recreation&quot;);</b>
<b class="nc">&nbsp;                        mLocalActivityManager.dispatchResume();</b>
<b class="nc">&nbsp;                        android.util.Log.d(TAG, &quot;LocalActivityManager resume completed successfully after recreation&quot;);</b>
&nbsp;                    } catch (Exception retryException) {
<b class="nc">&nbsp;                        android.util.Log.e(TAG, &quot;Failed to dispatchResume after recreation: &quot; + retryException.getMessage());</b>
&nbsp;                    }
&nbsp;                } catch (Exception recoveryException) {
<b class="nc">&nbsp;                    android.util.Log.e(TAG, &quot;Failed to recover LocalActivityManager: &quot; + recoveryException.getMessage());</b>
&nbsp;                }
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            android.util.Log.w(TAG, &quot;LocalActivityManager is null in onResume&quot;);</b>
&nbsp;        }
&nbsp;        
&nbsp;        // Additional safety check - if we still don&#39;t have a valid LocalActivityManager, try to recreate everything
<b class="nc">&nbsp;        if (mLocalActivityManager == null || !isLocalActivityManagerValid()) {</b>
<b class="nc">&nbsp;            android.util.Log.w(TAG, &quot;LocalActivityManager still invalid after recovery attempts, forcing recreation&quot;);</b>
&nbsp;            try {
<b class="nc">&nbsp;                recreateTabs();</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                android.util.Log.e(TAG, &quot;Failed to recreate tabs after recovery: &quot; + e.getMessage(), e);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    protected void onPause() {
<b class="nc">&nbsp;        android.util.Log.d(TAG, &quot;onPause called&quot;);</b>
&nbsp;        
<b class="nc">&nbsp;        if (mLocalActivityManager != null) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                android.util.Log.d(TAG, &quot;Dispatching pause to LocalActivityManager&quot;);</b>
<b class="nc">&nbsp;                mLocalActivityManager.dispatchPause(isFinishing());</b>
<b class="nc">&nbsp;                android.util.Log.d(TAG, &quot;LocalActivityManager pause completed successfully&quot;);</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                android.util.Log.e(TAG, &quot;Error in LocalActivityManager dispatchPause: &quot; + e.getMessage(), e);</b>
&nbsp;                // If pause fails, the LocalActivityManager might be in a bad state
<b class="nc">&nbsp;                android.util.Log.w(TAG, &quot;LocalActivityManager pause failed, marking as invalid&quot;);</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            android.util.Log.w(TAG, &quot;LocalActivityManager is null in onPause&quot;);</b>
&nbsp;        }
&nbsp;        
&nbsp;        // Additional safety check - if we&#39;re not finishing, this might be a temporary pause (like opening browser)
<b class="nc">&nbsp;        if (!isFinishing()) {</b>
<b class="nc">&nbsp;            android.util.Log.d(TAG, &quot;Activity is pausing but not finishing (likely opening browser)&quot;);</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        super.onPause();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    protected void onSaveInstanceState(Bundle outState) {
<b class="nc">&nbsp;        android.util.Log.d(TAG, &quot;onSaveInstanceState called&quot;);</b>
&nbsp;        try {
&nbsp;            // LocalActivityManager doesn&#39;t have dispatchSaveInstanceState method
&nbsp;            // We just need to save our own state
<b class="nc">&nbsp;            if (mLocalActivityManager != null) {</b>
<b class="nc">&nbsp;                android.util.Log.d(TAG, &quot;LocalActivityManager exists, saving state&quot;);</b>
&nbsp;                // Save the trig ID if we have it
<b class="nc">&nbsp;                long trigId = getIntent().getLongExtra(DbHelper.TRIG_ID, -1);</b>
<b class="nc">&nbsp;                if (trigId &gt; 0) {</b>
<b class="nc">&nbsp;                    outState.putLong(&quot;saved_trig_id&quot;, trigId);</b>
<b class="nc">&nbsp;                    android.util.Log.d(TAG, &quot;Saved trig ID to state: &quot; + trigId);</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                android.util.Log.w(TAG, &quot;LocalActivityManager is null in onSaveInstanceState&quot;);</b>
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            android.util.Log.e(TAG, &quot;Error in onSaveInstanceState: &quot; + e.getMessage(), e);</b>
&nbsp;        }
<b class="nc">&nbsp;        super.onSaveInstanceState(outState);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    protected void onRestoreInstanceState(Bundle savedInstanceState) {
<b class="nc">&nbsp;        android.util.Log.d(TAG, &quot;onRestoreInstanceState called&quot;);</b>
&nbsp;        try {
<b class="nc">&nbsp;            super.onRestoreInstanceState(savedInstanceState);</b>
&nbsp;            // LocalActivityManager doesn&#39;t have dispatchRestoreInstanceState method
&nbsp;            // We just need to restore our own state
<b class="nc">&nbsp;            if (mLocalActivityManager != null) {</b>
<b class="nc">&nbsp;                android.util.Log.d(TAG, &quot;LocalActivityManager exists, state restored&quot;);</b>
&nbsp;                // Restore any additional state we need
<b class="nc">&nbsp;                if (savedInstanceState != null) {</b>
<b class="nc">&nbsp;                    long savedTrigId = savedInstanceState.getLong(&quot;saved_trig_id&quot;, -1);</b>
<b class="nc">&nbsp;                    if (savedTrigId &gt; 0) {</b>
<b class="nc">&nbsp;                        android.util.Log.d(TAG, &quot;Restored trig ID from state: &quot; + savedTrigId);</b>
&nbsp;                        // Update the intent with the saved trig ID if needed
<b class="nc">&nbsp;                        if (getIntent().getLongExtra(DbHelper.TRIG_ID, -1) != savedTrigId) {</b>
<b class="nc">&nbsp;                            getIntent().putExtra(DbHelper.TRIG_ID, savedTrigId);</b>
<b class="nc">&nbsp;                            android.util.Log.d(TAG, &quot;Updated intent with restored trig ID&quot;);</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                android.util.Log.w(TAG, &quot;LocalActivityManager is null in onRestoreInstanceState&quot;);</b>
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            android.util.Log.e(TAG, &quot;Error in onRestoreInstanceState: &quot; + e.getMessage(), e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Attempts to recreate the LocalActivityManager when it&#39;s in a bad state
&nbsp;     */
&nbsp;    private void recreateLocalActivityManager() {
&nbsp;        try {
<b class="nc">&nbsp;            android.util.Log.d(TAG, &quot;Recreating LocalActivityManager&quot;);</b>
&nbsp;            
&nbsp;            // Clean up the old one first
<b class="nc">&nbsp;            if (mLocalActivityManager != null) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    mLocalActivityManager.dispatchDestroy(false);</b>
&nbsp;                } catch (Exception e) {
<b class="nc">&nbsp;                    android.util.Log.w(TAG, &quot;Error destroying old LocalActivityManager: &quot; + e.getMessage());</b>
&nbsp;                }
&nbsp;            }
&nbsp;            
&nbsp;            // Create a new one
<b class="nc">&nbsp;            mLocalActivityManager = new LocalActivityManager(this, false);</b>
<b class="nc">&nbsp;            if (mLocalActivityManager != null) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    mLocalActivityManager.dispatchCreate(null);</b>
<b class="nc">&nbsp;                    android.util.Log.d(TAG, &quot;LocalActivityManager recreated successfully&quot;);</b>
&nbsp;                } catch (Exception e) {
<b class="nc">&nbsp;                    android.util.Log.e(TAG, &quot;Error dispatching create to new LocalActivityManager: &quot; + e.getMessage());</b>
&nbsp;                }
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            android.util.Log.e(TAG, &quot;Error recreating LocalActivityManager: &quot; + e.getMessage(), e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Attempts to recreate the tabs when the LocalActivityManager is in a bad state.
&nbsp;     * This is a wrapper for setupTabs to ensure it&#39;s called with the correct arguments.
&nbsp;     */
&nbsp;    private void recreateTabs() {
<b class="nc">&nbsp;        android.util.Log.d(TAG, &quot;Recreating tabs due to LocalActivityManager invalidity&quot;);</b>
&nbsp;        try {
<b class="nc">&nbsp;            Bundle extras = getIntent().getExtras();</b>
<b class="nc">&nbsp;            if (extras == null) {</b>
<b class="nc">&nbsp;                extras = new Bundle();</b>
&nbsp;            }
&nbsp;            
&nbsp;            // Get the trig ID from the intent
<b class="nc">&nbsp;            long trigId = getIntent().getLongExtra(DbHelper.TRIG_ID, -1);</b>
<b class="nc">&nbsp;            if (trigId &gt; 0 &amp;&amp; !extras.containsKey(DbHelper.TRIG_ID)) {</b>
<b class="nc">&nbsp;                extras.putLong(DbHelper.TRIG_ID, trigId);</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            Bundle savedInstanceState = null; // No need to pass savedInstanceState here, it&#39;s handled by onRestoreInstanceState</b>
<b class="nc">&nbsp;            setupTabs(extras, savedInstanceState);</b>
<b class="nc">&nbsp;            android.util.Log.d(TAG, &quot;Tabs recreated successfully&quot;);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            android.util.Log.e(TAG, &quot;Error recreating tabs: &quot; + e.getMessage(), e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    protected void onDestroy() {
<b class="nc">&nbsp;        android.util.Log.d(TAG, &quot;onDestroy called&quot;);</b>
&nbsp;        
<b class="nc">&nbsp;        if (mLocalActivityManager != null) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                android.util.Log.d(TAG, &quot;Dispatching destroy to LocalActivityManager&quot;);</b>
<b class="nc">&nbsp;                mLocalActivityManager.dispatchDestroy(isFinishing());</b>
<b class="nc">&nbsp;                android.util.Log.d(TAG, &quot;LocalActivityManager destroy completed successfully&quot;);</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                android.util.Log.e(TAG, &quot;Error in LocalActivityManager dispatchDestroy: &quot; + e.getMessage(), e);</b>
&nbsp;            } finally {
<b class="nc">&nbsp;                mLocalActivityManager = null;</b>
<b class="nc">&nbsp;                android.util.Log.d(TAG, &quot;LocalActivityManager set to null&quot;);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        } else {
<b class="nc">&nbsp;            android.util.Log.w(TAG, &quot;LocalActivityManager is null in onDestroy&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        super.onDestroy();</b>
&nbsp;    }
&nbsp;    
&nbsp;    @Override
&nbsp;    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
<b class="nc">&nbsp;        android.util.Log.d(TAG, &quot;onActivityResult: requestCode=&quot; + requestCode + &quot;, resultCode=&quot; + resultCode + &quot;, data=&quot; + (data != null ? &quot;present&quot; : &quot;null&quot;));</b>
<b class="nc">&nbsp;        super.onActivityResult(requestCode, resultCode, data);</b>
&nbsp;        
&nbsp;        // Forward the result to the current activity in the LocalActivityManager
<b class="nc">&nbsp;        if (mLocalActivityManager != null) {</b>
<b class="nc">&nbsp;            android.util.Log.d(TAG, &quot;Forwarding activity result to LocalActivityManager&quot;);</b>
&nbsp;            try {
&nbsp;                // Get the current activity ID from the TabHost
<b class="nc">&nbsp;                TabHost tabHost = findViewById(android.R.id.tabhost);</b>
<b class="nc">&nbsp;                if (tabHost != null) {</b>
<b class="nc">&nbsp;                    String currentTabTag = tabHost.getCurrentTabTag();</b>
<b class="nc">&nbsp;                    android.util.Log.d(TAG, &quot;Current tab: &quot; + currentTabTag);</b>
&nbsp;                    
&nbsp;                    // Get the activity for the current tab
<b class="nc">&nbsp;                    android.app.Activity currentActivity = mLocalActivityManager.getActivity(currentTabTag);</b>
<b class="nc">&nbsp;                    if (currentActivity != null) {</b>
<b class="nc">&nbsp;                        android.util.Log.d(TAG, &quot;Forwarding result to activity: &quot; + currentActivity.getClass().getSimpleName());</b>
&nbsp;                        // Use reflection to call the protected onActivityResult method
&nbsp;                        try {
<b class="nc">&nbsp;                            java.lang.reflect.Method method = android.app.Activity.class.getDeclaredMethod(</b>
&nbsp;                                &quot;onActivityResult&quot;, int.class, int.class, Intent.class);
<b class="nc">&nbsp;                            method.setAccessible(true);</b>
<b class="nc">&nbsp;                            method.invoke(currentActivity, requestCode, resultCode, data);</b>
<b class="nc">&nbsp;                            android.util.Log.d(TAG, &quot;Successfully forwarded activity result via reflection&quot;);</b>
&nbsp;                        } catch (Exception reflectEx) {
<b class="nc">&nbsp;                            android.util.Log.e(TAG, &quot;Failed to invoke onActivityResult via reflection&quot;, reflectEx);</b>
&nbsp;                        }
&nbsp;                    } else {
<b class="nc">&nbsp;                        android.util.Log.w(TAG, &quot;No activity found for current tab: &quot; + currentTabTag);</b>
&nbsp;                    }
&nbsp;                } else {
<b class="nc">&nbsp;                    android.util.Log.w(TAG, &quot;TabHost not found, cannot forward activity result&quot;);</b>
&nbsp;                }
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                android.util.Log.e(TAG, &quot;Error forwarding activity result: &quot; + e.getMessage(), e);</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            android.util.Log.w(TAG, &quot;LocalActivityManager is null, cannot forward activity result&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Checks if the LocalActivityManager is in a valid state
&nbsp;     */
&nbsp;    private boolean isLocalActivityManagerValid() {
<b class="nc">&nbsp;        if (mLocalActivityManager == null) {</b>
<b class="nc">&nbsp;            android.util.Log.w(TAG, &quot;LocalActivityManager is null&quot;);</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;        
&nbsp;        try {
&nbsp;            // Try to access a simple property to see if it&#39;s still valid
&nbsp;            // This is a basic check - if it throws an exception, it&#39;s in a bad state
<b class="nc">&nbsp;            return true;</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            android.util.Log.w(TAG, &quot;LocalActivityManager is in invalid state: &quot; + e.getMessage());</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean onCreateOptionsMenu(Menu menu) {
<b class="nc">&nbsp;        if (menu == null) {</b>
<b class="nc">&nbsp;            android.util.Log.w(TAG, &quot;Menu is null&quot;);</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;        
&nbsp;        try {
<b class="nc">&nbsp;            if (getMenuInflater() != null) {</b>
<b class="nc">&nbsp;                getMenuInflater().inflate(R.menu.trigdetails_actions, menu);</b>
<b class="nc">&nbsp;                return true;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                android.util.Log.w(TAG, &quot;Menu inflater is null&quot;);</b>
<b class="nc">&nbsp;                return false;</b>
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            android.util.Log.e(TAG, &quot;Error creating options menu: &quot; + e.getMessage(), e);</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean onOptionsItemSelected(MenuItem item) {
<b class="nc">&nbsp;        if (item == null) {</b>
<b class="nc">&nbsp;            android.util.Log.w(TAG, &quot;Menu item is null&quot;);</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (item.getItemId() == android.R.id.home) {</b>
<b class="nc">&nbsp;            finish();</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;        
&nbsp;        // Check if LocalActivityManager is in a valid state
<b class="nc">&nbsp;        if (!isLocalActivityManagerValid()) {</b>
<b class="nc">&nbsp;            android.util.Log.w(TAG, &quot;LocalActivityManager is not valid, attempting to recreate&quot;);</b>
&nbsp;            try {
<b class="nc">&nbsp;                recreateLocalActivityManager();</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                android.util.Log.e(TAG, &quot;Failed to recreate LocalActivityManager: &quot; + e.getMessage());</b>
<b class="nc">&nbsp;                showToast(&quot;Error: Application state is invalid&quot;);</b>
<b class="nc">&nbsp;                return true;</b>
&nbsp;            }
&nbsp;        }
&nbsp;        
&nbsp;        try {
<b class="nc">&nbsp;            long trigId = getIntent().getLongExtra(DbHelper.TRIG_ID, -1);</b>
<b class="nc">&nbsp;            if (trigId &lt;= 0) {</b>
<b class="nc">&nbsp;                showToast(&quot;Invalid trigpoint id&quot;);</b>
<b class="nc">&nbsp;                return true;</b>
&nbsp;            }
&nbsp;            
<b class="nc">&nbsp;            double[] coords = loadTrigLatLon(trigId);</b>
<b class="nc">&nbsp;            double lat = coords[0];</b>
<b class="nc">&nbsp;            double lon = coords[1];</b>
&nbsp;
<b class="nc">&nbsp;            int id = item.getItemId();</b>
<b class="nc">&nbsp;            if (id == R.id.action_open_web) {</b>
<b class="nc">&nbsp;                String url = &quot;https://trigpointing.uk/trig/&quot; + trigId;</b>
&nbsp;                try {
&nbsp;                    // Prefer in-app WebView to avoid external browser lifecycle issues
<b class="nc">&nbsp;                    Intent i = new Intent(this, uk.trigpointing.android.common.WebViewActivity.class);</b>
<b class="nc">&nbsp;                    i.putExtra(uk.trigpointing.android.common.WebViewActivity.EXTRA_URL, url);</b>
<b class="nc">&nbsp;                    startActivity(i);</b>
&nbsp;                } catch (Exception e) {
<b class="nc">&nbsp;                    android.util.Log.e(TAG, &quot;Error opening in-app web view: &quot; + e.getMessage(), e);</b>
&nbsp;                    // Fallback to previous external handling if WebViewActivity fails
&nbsp;                    try {
<b class="nc">&nbsp;                        openWebPage(url);</b>
&nbsp;                    } catch (Exception ex) {
<b class="nc">&nbsp;                        android.util.Log.e(TAG, &quot;Error opening web page: &quot; + ex.getMessage(), ex);</b>
<b class="nc">&nbsp;                        showToast(&quot;Error opening web page&quot;);</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                return true;</b>
<b class="nc">&nbsp;            } else if (id == R.id.action_navigate) {</b>
<b class="nc">&nbsp;                if (lat != 0d || lon != 0d) {</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        String nav = String.format(&quot;google.navigation:q=%f,%f&quot;, lat, lon);</b>
<b class="nc">&nbsp;                        Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(nav));</b>
<b class="nc">&nbsp;                        if (intent.resolveActivity(getPackageManager()) != null) {</b>
<b class="nc">&nbsp;                            startActivity(Intent.createChooser(intent, &quot;Navigate to trigpoint&quot;));</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            showToast(&quot;No navigation app found&quot;);</b>
&nbsp;                        }
&nbsp;                    } catch (Exception e) {
<b class="nc">&nbsp;                        android.util.Log.e(TAG, &quot;Error creating navigation intent: &quot; + e.getMessage(), e);</b>
<b class="nc">&nbsp;                        showToast(&quot;Error opening navigation&quot;);</b>
&nbsp;                    }
&nbsp;                } else {
<b class="nc">&nbsp;                    showToast(&quot;Unable to get trigpoint coordinates&quot;);</b>
&nbsp;                }
<b class="nc">&nbsp;                return true;</b>
<b class="nc">&nbsp;            } else if (id == R.id.action_radar) {</b>
<b class="nc">&nbsp;                if (lat != 0d || lon != 0d) {</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        Intent intent = new Intent(this, uk.trigpointing.android.radar.RadarActivity.class);</b>
<b class="nc">&nbsp;                        intent.putExtra(DbHelper.TRIG_ID, trigId);</b>
<b class="nc">&nbsp;                        intent.putExtra(DbHelper.TRIG_LAT, lat);</b>
<b class="nc">&nbsp;                        intent.putExtra(DbHelper.TRIG_LON, lon);</b>
<b class="nc">&nbsp;                        startActivity(intent);</b>
&nbsp;                    } catch (Exception e) {
<b class="nc">&nbsp;                        android.util.Log.e(TAG, &quot;Error creating radar intent: &quot; + e.getMessage(), e);</b>
<b class="nc">&nbsp;                        showToast(&quot;Error opening radar&quot;);</b>
&nbsp;                    }
&nbsp;                } else {
<b class="nc">&nbsp;                    showToast(&quot;Unable to get trigpoint coordinates&quot;);</b>
&nbsp;                }
<b class="nc">&nbsp;                return true;</b>
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            android.util.Log.e(TAG, &quot;Error handling menu action: &quot; + e.getMessage(), e);</b>
<b class="nc">&nbsp;            showToast(&quot;Error processing action&quot;);</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        return super.onOptionsItemSelected(item);</b>
&nbsp;    }
&nbsp;
&nbsp;    private double[] loadTrigLatLon(long trigId) {
<b class="nc">&nbsp;        double lat = 0d, lon = 0d;</b>
<b class="nc">&nbsp;        if (trigId &lt;= 0) return new double[]{lat, lon};</b>
<b class="nc">&nbsp;        DbHelper db = null;</b>
<b class="nc">&nbsp;        Cursor c = null;</b>
&nbsp;        try {
<b class="nc">&nbsp;            if (this != null) {</b>
<b class="nc">&nbsp;                db = new DbHelper(this);</b>
<b class="nc">&nbsp;                if (db != null) {</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        db.open();</b>
<b class="nc">&nbsp;                        c = db.fetchTrigInfo(trigId);</b>
<b class="nc">&nbsp;                        if (c != null &amp;&amp; c.moveToFirst()) {</b>
&nbsp;                            try {
<b class="nc">&nbsp;                                int latIndex = c.getColumnIndex(DbHelper.TRIG_LAT);</b>
<b class="nc">&nbsp;                                int lonIndex = c.getColumnIndex(DbHelper.TRIG_LON);</b>
<b class="nc">&nbsp;                                if (latIndex &gt;= 0 &amp;&amp; lonIndex &gt;= 0) {</b>
<b class="nc">&nbsp;                                    lat = c.getDouble(latIndex);</b>
<b class="nc">&nbsp;                                    lon = c.getDouble(lonIndex);</b>
&nbsp;                                } else {
<b class="nc">&nbsp;                                    android.util.Log.w(TAG, &quot;Invalid column indices for coordinates&quot;);</b>
&nbsp;                                }
&nbsp;                            } catch (Exception e) {
<b class="nc">&nbsp;                                android.util.Log.w(TAG, &quot;Error reading coordinates from cursor: &quot; + e.getMessage());</b>
&nbsp;                            }
&nbsp;                        } else {
<b class="nc">&nbsp;                            android.util.Log.w(TAG, &quot;No trig info found for ID: &quot; + trigId);</b>
&nbsp;                        }
&nbsp;                    } catch (Exception e) {
<b class="nc">&nbsp;                        android.util.Log.w(TAG, &quot;Error opening database or fetching trig info: &quot; + e.getMessage());</b>
&nbsp;                    }
&nbsp;                } else {
<b class="nc">&nbsp;                    android.util.Log.w(TAG, &quot;Database helper is null&quot;);</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                android.util.Log.w(TAG, &quot;Context is null&quot;);</b>
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            android.util.Log.w(TAG, &quot;Error creating database helper: &quot; + e.getMessage());</b>
&nbsp;        } finally {
<b class="nc">&nbsp;            if (c != null) {</b>
&nbsp;                try {
&nbsp;                    c.close();
&nbsp;                } catch (Exception e) {
<b class="nc">&nbsp;                    android.util.Log.w(TAG, &quot;Error closing cursor: &quot; + e.getMessage());</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if (db != null) {</b>
&nbsp;                try {
&nbsp;                    db.close();
&nbsp;                } catch (Exception e) {
<b class="nc">&nbsp;                    android.util.Log.w(TAG, &quot;Error closing database: &quot; + e.getMessage());</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return new double[]{lat, lon};</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;
&nbsp;    /**
&nbsp;     * Safely loads a drawable resource, returning null if it fails
&nbsp;     * @param res Resources object
&nbsp;     * @param drawableId The drawable resource ID
&nbsp;     * @return The drawable or null if loading fails
&nbsp;     */
&nbsp;    private android.graphics.drawable.Drawable getDrawableSafely(Resources res, int drawableId) {
&nbsp;        try {
<b class="nc">&nbsp;            return res.getDrawable(drawableId);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            android.util.Log.w(TAG, &quot;Failed to load drawable &quot; + drawableId + &quot;: &quot; + e.getMessage());</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Safely opens a web page with proper error handling and fallback mechanisms
&nbsp;     * @param url The URL to open
&nbsp;     */
&nbsp;    private void openWebPage(String url) {
<b class="nc">&nbsp;        android.util.Log.d(TAG, &quot;openWebPage called with URL: &quot; + url);</b>
&nbsp;        
<b class="nc">&nbsp;        if (url == null || url.trim().isEmpty()) {</b>
<b class="nc">&nbsp;            showToast(&quot;Invalid URL&quot;);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // Check if the activity is still valid
<b class="nc">&nbsp;        if (isFinishing() || isDestroyed()) {</b>
<b class="nc">&nbsp;            android.util.Log.w(TAG, &quot;Activity is finishing or destroyed, cannot open web page&quot;);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        // Check if LocalActivityManager is in a valid state
<b class="nc">&nbsp;        if (!isLocalActivityManagerValid()) {</b>
<b class="nc">&nbsp;            android.util.Log.w(TAG, &quot;LocalActivityManager is not valid, attempting to recreate&quot;);</b>
&nbsp;            try {
<b class="nc">&nbsp;                recreateLocalActivityManager();</b>
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                android.util.Log.e(TAG, &quot;Failed to recreate LocalActivityManager: &quot; + e.getMessage());</b>
<b class="nc">&nbsp;                showToast(&quot;Error: Application state is invalid&quot;);</b>
&nbsp;                return;
&nbsp;            }
&nbsp;        }
&nbsp;        
&nbsp;        // Save the current state before opening the browser
<b class="nc">&nbsp;        android.util.Log.d(TAG, &quot;Saving current state before opening browser&quot;);</b>
&nbsp;        try {
&nbsp;            // Removed manual LocalActivityManager pause to avoid corrupting internal state
&nbsp;        } catch (Exception e) {
&nbsp;            android.util.Log.w(TAG, &quot;Error saving state before browser: &quot; + e.getMessage());
&nbsp;        }
&nbsp;
&nbsp;        // Validate the URL format
&nbsp;        Uri uri;
&nbsp;        try {
<b class="nc">&nbsp;            uri = Uri.parse(url);</b>
<b class="nc">&nbsp;            if (uri == null) {</b>
<b class="nc">&nbsp;                showToast(&quot;Invalid URL format&quot;);</b>
&nbsp;                return;
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            android.util.Log.e(TAG, &quot;Error parsing URL: &quot; + e.getMessage());</b>
<b class="nc">&nbsp;            showToast(&quot;Invalid URL format&quot;);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        try {
&nbsp;            // First, try to use CustomTabsIntent for a better user experience
<b class="nc">&nbsp;            CustomTabsIntent.Builder builder = new CustomTabsIntent.Builder();</b>
<b class="nc">&nbsp;            if (builder != null) {</b>
<b class="nc">&nbsp;                CustomTabsIntent customTabsIntent = builder.build();</b>
<b class="nc">&nbsp;                if (customTabsIntent != null) {</b>
&nbsp;                    // Add error handling for CustomTabsIntent
&nbsp;                    try {
&nbsp;                        // Check if there&#39;s a browser that supports custom tabs
<b class="nc">&nbsp;                        if (customTabsIntent.intent.resolveActivity(getPackageManager()) != null) {</b>
&nbsp;                            // Add additional safety check for the activity state
<b class="nc">&nbsp;                            if (!isFinishing() &amp;&amp; !isDestroyed()) {</b>
<b class="nc">&nbsp;                                android.util.Log.d(TAG, &quot;Launching custom tabs for URL: &quot; + url);</b>
<b class="nc">&nbsp;                                customTabsIntent.launchUrl(this, uri);</b>
&nbsp;                                return; // Success, exit method
&nbsp;                            } else {
<b class="nc">&nbsp;                                android.util.Log.w(TAG, &quot;Activity state changed, cannot launch custom tabs&quot;);</b>
&nbsp;                            }
&nbsp;                        } else {
<b class="nc">&nbsp;                            android.util.Log.w(TAG, &quot;No browser supports custom tabs, falling back to regular intent&quot;);</b>
&nbsp;                        }
&nbsp;                    } catch (Exception e) {
&nbsp;                        // Log the error but continue to fallback
<b class="nc">&nbsp;                        android.util.Log.w(TAG, &quot;CustomTabsIntent failed: &quot; + e.getMessage());</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        } catch (Exception e) {
&nbsp;            // Log the error but continue to fallback
<b class="nc">&nbsp;            android.util.Log.w(TAG, &quot;CustomTabsIntent builder failed: &quot; + e.getMessage());</b>
&nbsp;        }
&nbsp;
&nbsp;        // Fallback to regular browser intent
&nbsp;        try {
<b class="nc">&nbsp;            Intent webIntent = new Intent(Intent.ACTION_VIEW, uri);</b>
&nbsp;            
&nbsp;            // Check if there&#39;s an app to handle this intent
<b class="nc">&nbsp;            if (webIntent.resolveActivity(getPackageManager()) != null) {</b>
&nbsp;                // Add additional safety check
<b class="nc">&nbsp;                if (!isFinishing() &amp;&amp; !isDestroyed()) {</b>
<b class="nc">&nbsp;                    android.util.Log.d(TAG, &quot;Launching regular intent for URL: &quot; + url);</b>
<b class="nc">&nbsp;                    startActivity(webIntent);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    android.util.Log.w(TAG, &quot;Activity state changed, cannot start web intent&quot;);</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                android.util.Log.w(TAG, &quot;No browser app found to handle web intent&quot;);</b>
<b class="nc">&nbsp;                showToast(&quot;No browser app found&quot;);</b>
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            android.util.Log.e(TAG, &quot;Failed to open web page: &quot; + e.getMessage());</b>
<b class="nc">&nbsp;            showToast(&quot;Failed to open web page&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void showToast(String message) {
&nbsp;        try {
<b class="nc">&nbsp;            if (!isFinishing() &amp;&amp; !isDestroyed()) {</b>
<b class="nc">&nbsp;                Toast.makeText(this, message, Toast.LENGTH_SHORT).show();</b>
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            android.util.Log.w(TAG, &quot;Error showing toast: &quot; + e.getMessage());</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-08-25 13:52</div>
</div>
</body>
</html>
