


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > LazyImageLoader</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">uk.trigpointing.android.common</a>
</div>

<h1>Coverage Summary for Class: LazyImageLoader (uk.trigpointing.android.common)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">LazyImageLoader</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/62)
  </span>
</td>
</tr>
  <tr>
    <td class="name">LazyImageLoader$BitmapDisplayer</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LazyImageLoader$PhotosLoader</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/17)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LazyImageLoader$PhotosQueue</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LazyImageLoader$PhotoToLoad</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/96)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package uk.trigpointing.android.common;
&nbsp;
&nbsp;import java.io.File;
&nbsp;import java.io.FileInputStream;
&nbsp;import java.io.FileNotFoundException;
&nbsp;import java.io.FileOutputStream;
&nbsp;import java.io.InputStream;
&nbsp;import java.io.OutputStream;
&nbsp;import java.net.HttpURLConnection;
&nbsp;import java.net.URL;
&nbsp;import java.util.Collections;
&nbsp;import java.util.Map;
&nbsp;import java.util.Stack;
&nbsp;import java.util.WeakHashMap;
&nbsp;
&nbsp;import android.app.Activity;
&nbsp;import android.content.Context;
&nbsp;import android.graphics.Bitmap;
&nbsp;import android.graphics.BitmapFactory;
&nbsp;import android.util.Log;
&nbsp;import android.widget.ImageView;
&nbsp;
&nbsp;import uk.trigpointing.android.R;
&nbsp;
&nbsp;// Code from https://github.com/thest1/LazyList
&nbsp;
&nbsp;public class LazyImageLoader {
&nbsp;	private static final String TAG = &quot;BitmapLoader&quot;;
&nbsp;
<b class="nc">&nbsp;    final int stub_id=R.drawable.imageloading;</b>
&nbsp;
<b class="nc">&nbsp;    MemoryCache memoryCache=new MemoryCache();</b>
&nbsp;    FileCache fileCache;
<b class="nc">&nbsp;    private final Map&lt;ImageView, String&gt; imageViews=Collections.synchronizedMap(new WeakHashMap&lt;&gt;());</b>
&nbsp;
<b class="nc">&nbsp;    PhotosLoader photoLoaderThread=new PhotosLoader();</b>
<b class="nc">&nbsp;    PhotosQueue photosQueue= new PhotosQueue();</b>
&nbsp;
&nbsp;    
<b class="nc">&nbsp;    public LazyImageLoader(Context context){</b>
&nbsp;        //Make the background thread low priority. This way it will not affect the UI performance
<b class="nc">&nbsp;        photoLoaderThread.setPriority(Thread.NORM_PRIORITY-1);</b>
&nbsp;        
<b class="nc">&nbsp;        fileCache=new FileCache(context, &quot;images&quot;);</b>
&nbsp;    }
&nbsp;    
&nbsp;    public void DisplayImage(String url, ImageView imageView)
&nbsp;    {
<b class="nc">&nbsp;        imageViews.put(imageView, url);</b>
<b class="nc">&nbsp;        Bitmap bitmap=memoryCache.getBitmap(url);</b>
<b class="nc">&nbsp;        if(bitmap!=null) {</b>
<b class="nc">&nbsp;            imageView.setImageBitmap(bitmap);</b>
<b class="nc">&nbsp;            Log.i(TAG, &quot;Got &quot;+url+&quot; from memory&quot;);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            queuePhoto(url, imageView);</b>
<b class="nc">&nbsp;            imageView.setImageResource(stub_id);</b>
&nbsp;        }    
&nbsp;    }
&nbsp;        
&nbsp;    private void queuePhoto(String url, ImageView imageView)
&nbsp;    {
&nbsp;        //This ImageView may be used for other images before. So there may be some old tasks in the queue. We need to discard them. 
<b class="nc">&nbsp;        photosQueue.Clean(imageView);</b>
<b class="nc">&nbsp;        PhotoToLoad p= new PhotoToLoad(url, imageView);</b>
<b class="nc">&nbsp;        synchronized(photosQueue.photosToLoad){</b>
<b class="nc">&nbsp;            photosQueue.photosToLoad.push(p);</b>
<b class="nc">&nbsp;            photosQueue.photosToLoad.notifyAll();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;        
&nbsp;        //start thread if it&#39;s not started yet
<b class="nc">&nbsp;        if(photoLoaderThread.getState()==Thread.State.NEW)</b>
<b class="nc">&nbsp;            photoLoaderThread.start();</b>
&nbsp;    }
&nbsp;    
&nbsp;    private Bitmap getBitmap(String url) 
&nbsp;    {
<b class="nc">&nbsp;        File f=fileCache.getFile(url);</b>
&nbsp;        
&nbsp;        //from SD cache
<b class="nc">&nbsp;        Bitmap b = decodeFile(f);</b>
<b class="nc">&nbsp;        if(b!=null) {</b>
<b class="nc">&nbsp;        	Log.i(TAG, &quot;Got &quot;+url+&quot; from SD cache&quot;);</b>
<b class="nc">&nbsp;            return b;</b>
&nbsp;        }
&nbsp;        
&nbsp;        //from web
&nbsp;        try {
&nbsp;            Bitmap bitmap;
<b class="nc">&nbsp;            URL imageUrl = new URL(url);</b>
<b class="nc">&nbsp;            HttpURLConnection conn = (HttpURLConnection)imageUrl.openConnection();</b>
<b class="nc">&nbsp;            conn.setConnectTimeout(30000);</b>
<b class="nc">&nbsp;            conn.setReadTimeout(30000);</b>
<b class="nc">&nbsp;            InputStream is=conn.getInputStream();</b>
<b class="nc">&nbsp;            OutputStream os = new FileOutputStream(f);</b>
<b class="nc">&nbsp;            Utils.CopyStream(is, os);</b>
&nbsp;            os.close();
<b class="nc">&nbsp;            bitmap = decodeFile(f);</b>
<b class="nc">&nbsp;            Log.i(TAG, &quot;Got &quot;+url+&quot; from network&quot;);</b>
<b class="nc">&nbsp;            return bitmap;</b>
&nbsp;        } catch (Exception ex){
<b class="nc">&nbsp;           Log.e(TAG, &quot;Error loading image from URL: &quot; + url, ex);</b>
&nbsp;           // Clean up the failed download file
<b class="nc">&nbsp;           if (f.exists()) {</b>
<b class="nc">&nbsp;               boolean ok = f.delete();</b>
<b class="nc">&nbsp;               if (!ok) {</b>
<b class="nc">&nbsp;                   Log.w(TAG, &quot;Failed to delete partial image file: &quot; + f.getAbsolutePath());</b>
&nbsp;               }
&nbsp;           }
<b class="nc">&nbsp;           return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    //decodes image and scales it to reduce memory consumption
&nbsp;    private Bitmap decodeFile(File f){
<b class="nc">&nbsp;        if (!f.exists()) {</b>
<b class="nc">&nbsp;            return null; // File doesn&#39;t exist, no need to log error</b>
&nbsp;        }
&nbsp;        
&nbsp;        try {
&nbsp;            //decode image size
<b class="nc">&nbsp;            BitmapFactory.Options o = new BitmapFactory.Options();</b>
<b class="nc">&nbsp;            o.inJustDecodeBounds = true;</b>
<b class="nc">&nbsp;            BitmapFactory.decodeStream(new FileInputStream(f),null,o);</b>
&nbsp;            
&nbsp;            //Find the correct scale value. It should be the power of 2.
<b class="nc">&nbsp;            final int REQUIRED_SIZE=600;</b>
<b class="nc">&nbsp;            int width_tmp=o.outWidth, height_tmp=o.outHeight;</b>
<b class="nc">&nbsp;            int scale=1;</b>
<b class="nc">&nbsp;            while (width_tmp / 2 &gt;= REQUIRED_SIZE &amp;&amp; height_tmp / 2 &gt;= REQUIRED_SIZE) {</b>
<b class="nc">&nbsp;                width_tmp /= 2;</b>
<b class="nc">&nbsp;                height_tmp /= 2;</b>
<b class="nc">&nbsp;                scale *= 2;</b>
&nbsp;            }
&nbsp;            
&nbsp;            //decode with inSampleSize
<b class="nc">&nbsp;            BitmapFactory.Options o2 = new BitmapFactory.Options();</b>
<b class="nc">&nbsp;            o2.inSampleSize=scale;</b>
<b class="nc">&nbsp;            return BitmapFactory.decodeStream(new FileInputStream(f), null, o2);</b>
&nbsp;        } catch (FileNotFoundException e) {
<b class="nc">&nbsp;            Log.d(TAG, &quot;File not found: &quot; + f.getAbsolutePath()); // Changed to debug level</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            Log.e(TAG, &quot;Error decoding file: &quot; + f.getAbsolutePath(), e);</b>
&nbsp;        }
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;    
&nbsp;    //Task for the queue
&nbsp;    private static class PhotoToLoad
&nbsp;    {
&nbsp;        public String url;
&nbsp;        public ImageView imageView;
<b class="nc">&nbsp;        public PhotoToLoad(String u, ImageView i){</b>
<b class="nc">&nbsp;            url=u; </b>
<b class="nc">&nbsp;            imageView=i;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    //stores list of photos to download
<b class="nc">&nbsp;    static class PhotosQueue</b>
&nbsp;    {
<b class="nc">&nbsp;        private final Stack&lt;PhotoToLoad&gt; photosToLoad= new Stack&lt;&gt;();</b>
&nbsp;        
&nbsp;        //removes all instances of this ImageView
&nbsp;        public void Clean(ImageView image)
&nbsp;        {
<b class="nc">&nbsp;            for(int j=0 ;j&lt;photosToLoad.size();){</b>
<b class="nc">&nbsp;                if(photosToLoad.get(j).imageView==image)</b>
<b class="nc">&nbsp;                    photosToLoad.remove(j);</b>
&nbsp;                else
<b class="nc">&nbsp;                    ++j;</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;    
<b class="nc">&nbsp;    class PhotosLoader extends Thread {</b>
&nbsp;        public void run() {
&nbsp;            try {
&nbsp;                do {
&nbsp;                    //thread waits until there are any images to load in the queue
<b class="nc">&nbsp;                    if (photosQueue.photosToLoad.isEmpty())</b>
<b class="nc">&nbsp;                        synchronized (photosQueue.photosToLoad) {</b>
<b class="nc">&nbsp;                            photosQueue.photosToLoad.wait();</b>
<b class="nc">&nbsp;                        }</b>
<b class="nc">&nbsp;                    if (!photosQueue.photosToLoad.isEmpty()) {</b>
&nbsp;                        PhotoToLoad photoToLoad;
<b class="nc">&nbsp;                        synchronized (photosQueue.photosToLoad) {</b>
<b class="nc">&nbsp;                            photoToLoad = photosQueue.photosToLoad.pop();</b>
<b class="nc">&nbsp;                        }</b>
<b class="nc">&nbsp;                        Bitmap bmp = getBitmap(photoToLoad.url);</b>
<b class="nc">&nbsp;                        memoryCache.put(photoToLoad.url, bmp);</b>
<b class="nc">&nbsp;                        String tag = imageViews.get(photoToLoad.imageView);</b>
<b class="nc">&nbsp;                        if (tag != null &amp;&amp; tag.equals(photoToLoad.url)) {</b>
<b class="nc">&nbsp;                            BitmapDisplayer bd = new BitmapDisplayer(bmp, photoToLoad.imageView);</b>
<b class="nc">&nbsp;                            Activity a = (Activity) photoToLoad.imageView.getContext();</b>
<b class="nc">&nbsp;                            a.runOnUiThread(bd);</b>
&nbsp;                        }
&nbsp;                    }
<b class="nc">&nbsp;                } while (!Thread.interrupted());</b>
&nbsp;            } catch (InterruptedException e) {
&nbsp;                //allow thread to exit
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    
&nbsp;    //Used to display bitmap in the UI thread
&nbsp;    class BitmapDisplayer implements Runnable
&nbsp;    {
&nbsp;        Bitmap bitmap;
&nbsp;        ImageView imageView;
<b class="nc">&nbsp;        public BitmapDisplayer(Bitmap b, ImageView i){</b>
<b class="nc">&nbsp;        	bitmap=b;</b>
<b class="nc">&nbsp;        	imageView=i;</b>
&nbsp;        }
&nbsp;        public void run()
&nbsp;        {
<b class="nc">&nbsp;            if(bitmap!=null) {</b>
<b class="nc">&nbsp;                imageView.setImageBitmap(bitmap);</b>
<b class="nc">&nbsp;                Log.d(TAG, &quot;Displayed bitmap successfully&quot;);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                imageView.setImageResource(stub_id);</b>
<b class="nc">&nbsp;                Log.w(TAG, &quot;Bitmap was null, showing placeholder image&quot;);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-08-25 13:52</div>
</div>
</body>
</html>
