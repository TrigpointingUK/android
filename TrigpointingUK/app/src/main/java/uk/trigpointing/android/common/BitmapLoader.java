package uk.trigpointing.android.common;

import java.io.File;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.URL;
import java.net.URLConnection;

import android.content.Context;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.util.Log;

public class BitmapLoader {
	private static final String TAG="BitmapLoader";
	private static final MemoryCache mMemoryCache=new MemoryCache();
	FileCache   mFileCache;

	public BitmapLoader(Context context) {
		mFileCache=new FileCache(context, "images");
	}

	public Bitmap getBitmap(String url, boolean reload) {
		Log.i(TAG, "getBitmap " + url + " , reload : " + reload);
		Bitmap bResult;

		File file=mFileCache.getFile(url);

		if (!reload) {
			// try soft reference memory cache
			bResult =  mMemoryCache.getBitmap(url);
			if(bResult != null) {
				Log.i(TAG, "Got "+url+" from memory");
				return bResult;
			}

			// try file cache
			try {
				//from SD cache
				bResult = BitmapFactory.decodeFile(file.getAbsolutePath());
				if(bResult != null) {
					Log.i(TAG, "Got "+url+" from SD cache");
					return bResult;
				}
			} catch (Exception e) {
				e.printStackTrace();
			}
		} else {
			Log.i(TAG, "Explicit request to reload from web");
		}

		//from web
		try {
			Log.i(TAG, "Downloading from web " + url);
			URLConnection conn = new URL(url).openConnection();
			conn.setConnectTimeout(30000);
			conn.setReadTimeout(30000);
			InputStream is=conn.getInputStream();
			OutputStream os = new FileOutputStream(file);
			Utils.CopyStream(is, os);
			os.close();
			bResult = BitmapFactory.decodeFile(file.getAbsolutePath());
			if(bResult != null) {
				Log.i(TAG, "Got "+url+" from web");
				return bResult;
			}
		} catch (Exception e) {
			Log.e(TAG, "Error downloading image from URL: " + url, e);
		}

		Log.i(TAG, "FAILED to get "+url);
		return null;
	}
}
